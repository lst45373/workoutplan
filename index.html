<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26주 장기 성장 프로그램 | 인터랙티브 플래너 (v6.4 Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .week-btn-active { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .day-btn-active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card-enter, .modal-enter { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 640px) {
            .chart-container { height: 40vh; }
        }
        .prose { max-width: none; }
    </style>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app-wrapper">
        <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
            <header class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">26주 장기 성장 프로그램</h1>
                <p class="text-slate-600 mt-3 text-base sm:text-lg">당신만을 위해 설계된 궁극의 인터랙티브 운동 플래너</p>
            </header>

            <nav class="flex justify-center mb-10 border-b border-slate-300">
                <button id="tab-today" class="py-3 px-4 sm:py-4 sm:px-6 font-semibold border-b-2 text-sm sm:text-base tab-active shadow-sm" onclick="showView('today')">오늘의 운동</button>
                <button id="tab-plan" class="py-3 px-4 sm:py-4 sm:px-6 font-semibold border-b-2 text-sm sm:text-base border-transparent text-slate-500 hover:text-blue-600 transition shadow-sm" onclick="showView('plan')">전체 계획서</button>
                <button id="tab-records" class="py-3 px-4 sm:py-4 sm:px-6 font-semibold border-b-2 text-sm sm:text-base border-transparent text-slate-500 hover:text-blue-600 transition shadow-sm" onclick="showView('records')">기록 보기</button>
            </nav>

            <main id="main-content">
                <div id="view-today">
                    <section id="controls" class="mb-8 p-4 sm:p-6 bg-white rounded-xl shadow-lg">
                        <div class="mb-6">
                            <h3 class="font-bold text-lg sm:text-xl mb-4 text-slate-800">1. 주차 선택 (Week)</h3>
                            <div id="week-selector" class="flex flex-wrap gap-2">
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg sm:text-xl mb-4 text-slate-800">2. 요일 선택 (Day)</h3>
                            <div id="day-selector" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <button data-day="pull" class="p-3 sm:p-4 rounded-lg font-bold text-base sm:text-lg bg-slate-100 text-slate-700 transition duration-200 hover:bg-slate-200 shadow-md">PULL (당기기)</button>
                                <button data-day="push" class="p-3 sm:p-4 rounded-lg font-bold text-base sm:text-lg bg-slate-100 text-slate-700 transition duration-200 hover:bg-slate-200 shadow-md">PUSH (밀기)</button>
                                <button data-day="leg" class="p-3 sm:p-4 rounded-lg font-bold text-base sm:text-lg bg-slate-100 text-slate-700 transition duration-200 hover:bg-slate-200 shadow-md">LEG (하체)</button>
                            </div>
                        </div>
                    </section>

                    <section id="workout-display">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
                             <h2 id="workout-title" class="text-2xl sm:text-3xl font-bold text-slate-900"></h2>
                             <span id="cycle-info-badge" class="text-base font-medium text-slate-500 self-start sm:self-center whitespace-nowrap"></span>
                        </div>
                        <div class="flex items-center mb-4 gap-3">
                            <span id="workout-phase-badge" class="px-3 py-1 sm:px-4 sm:py-1.5 text-sm sm:text-base font-semibold rounded-full self-start"></span>
                        </div>
                        <p id="workout-phase-description" class="p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-900 rounded-r-lg mb-8 shadow-sm"></p>
                        <div class="flex items-center justify-center gap-2 text-xs sm:text-sm text-slate-500 mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.206.552.38.062.172.038.397-.04.603-.078.206-.214.394-.383.494-.17.1-.42.15-.66.15-.24.004-.495-.05-.702-.145-.206-.094-.374-.241-.478-.421l-.127-.223-.317.416.127.223c.146.256.358.463.608.583.25.12.532.193.83.232.297.04.61.023.908-.06l.322-.09.303.226c.143.106.323.19.52.247.198.058.42.066.635.034.214-.032.422-.1.616-.208.195-.108.36-.26.486-.444.126-.184.22-.412.27-.66.05-.247.053-.516.01-.78-.043-.263-.153-.521-.33-.742-.176-.22-.422-.405-.71-.524-.287-.12-.62-.19-.97-.24l-.322-.047-.226-.303c-.11-.147-.25-.27-.41-.355-.16-.084-.34-.125-.53-.125-.19.002-.38.044-.56.125-.18.08-.34.2-.47.355l-.127.173.317-.417.127-.173c.147-.197.355-.365.594-.465.24-.1.49-.13.73-.1.24.03.48.1.7.223.22.123.4.295.52.502zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                            <span>기록은 자동으로 저장됩니다. 별도의 저장 버튼이 없습니다.</span>
                        </div>
                        <div id="workout-list" class="space-y-5">
                        </div>
                    </section>
                </div>

                <div id="view-plan" class="hidden">
                     <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                          <h2 class="text-2xl font-bold text-slate-900 mb-4">훈련 주기 설명</h2>
                          <div class="space-y-6 text-slate-700">
                               <div>
                                   <h3 class="font-bold text-xl text-red-700">강화 주기 (고중량 저반복)</h3>
                                   <p class="mt-1">다룰 수 있는 최대 중량(Strength)을 늘리는 데 모든 것을 집중하는 시기입니다. 메인 운동은 **'탑 세트 / 백오프 세트'** 방식으로 진행하며, 점진적으로 더 무거운 무게에 도전하는 것이 목표입니다.</p>
                               </div>
                               <div>
                                   <h3 class="font-bold text-xl text-green-700">축적 주기 (중중량 고반복)</h3>
                                   <p class="mt-1">근육의 크기(근비대)를 키우기 위해 충분한 운동량(Volume)을 쌓는 시기입니다. 메인 운동은 **'워킹 세트'** (8~12회 x 3~4세트)로 변경하여 수행합니다. 탑 세트 무게의 75%~85% 무게로, 실패 직전까지만 반복합니다.</p>
                               </div>
                               <div>
                                   <h3 class="font-bold text-xl text-sky-700">디로딩 주간 (전략적 회복)</h3>
                                   <p class="mt-1">'능동적 회복'을 통해 그동안 쌓인 중추신경계와 관절의 피로를 완전히 해소하고 다음 12주를 준비하는 시기입니다. 평소 워킹 세트 중량의 50%~60%, 세트 수의 절반만 가볍게 수행합니다.</p>
                               </div>
                          </div>

                          <div class="mt-10 pt-8 border-t border-slate-200">
                            <h2 class="text-2xl font-bold text-slate-900 mb-4">핵심 훈련 방식 상세</h2>
                            <div class="space-y-8 text-slate-700 prose">
                                <div>
                                    <h4 class="font-bold text-xl text-red-700">🚀 탑 세트 / 백오프 세트 (Top Set / Back-off Set)</h4>
                                    <p class="mt-2">
                                        <strong>'강화 주기'</strong>에 사용하는 방식으로, 다룰 수 있는 최대 중량(근력)을 점진적으로 늘리는 데 모든 것을 집중하는 고강도 훈련법입니다.
                                    </p>
                                    <div class="mt-3">
                                        <p class="font-semibold">수행 방법:</p>
                                        <ol class="list-decimal list-inside space-y-3 mt-2">
                                            <li>
                                                <strong>준비 세트 (Feeder Sets):</strong>
                                                <p class="pl-5 text-slate-600">본 운동(탑 세트)에 들어가기 전, <strong>2~3세트에 걸쳐 무게를 점차 증량</strong>하며 관절과 신경계를 예열합니다. 탑 세트의 무게에 가까워질수록 <strong>반복 횟수는 3~5회 정도로 낮게 유지</strong>하여, 불필요한 피로 없이 신경계를 활성화하는 데에만 집중하세요. 이 세트들은 절대 실패지점까지 수행하지 않습니다.</p>
                                            </li>
                                            <li>
                                                <strong>탑 세트 (Top Set):</strong>
                                                <p class="pl-5 text-slate-600"><strong>오늘의 단 한 번뿐인 가장 중요한 세트</strong>입니다. 앱이 제시하는 <strong>'🔥 강화 목표'</strong> 중량으로 목표 횟수 범위 내에서 수행 가능한 최대 횟수에 도전합니다. <strong>완벽한 자세</strong>와 <strong>템포</strong>를 유지하는 선에서, 실패 직전(마지막 1~2회는 더 이상 반복할 수 없다는 느낌)까지만 수행하는 것이 핵심입니다. 수행이 끝나면, <strong>실제 성공한 횟수</strong>를 정확히 기록해 주세요. 이 기록이 다음 훈련의 무게를 결정하는 가장 중요한 데이터가 됩니다.</p>
                                            </li>
                                            <li>
                                                <strong>백오프 세트 (Back-off Set):</strong>
                                                <p class="pl-5 text-slate-600">탑 세트가 끝나면, 중량을 <strong>약 15~20%</strong> 낮춥니다. (예: 100kg -> 80kg) 낮춰진 무게로 <strong>8~10회</strong> 반복 가능한 세트를 1~2회 추가 수행하여, 근성장에 필요한 추가적인 볼륨(운동량)과 펌핑감을 확보하며 마무리합니다.</p>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-xl text-green-700">💪 워킹 세트 (Working Sets)</h4>
                                    <p class="mt-2">
                                        <strong>'축적 주기'</strong>에 사용하는 방식으로, 근육의 크기(근비대)를 키우기 위해 충분한 운동량(볼륨)을 쌓는 데 집중하는 가장 전통적인 보디빌딩 훈련법입니다.
                                    </p>
                                    <div class="mt-3">
                                        <p class="font-semibold">수행 방법:</p>
                                        <ol class="list-decimal list-inside space-y-3 mt-2">
                                            <li>
                                                <strong>목표 중량 설정:</strong>
                                                <p class="pl-5 text-slate-600">앱이 이전 '강화 주기'의 성과를 바탕으로 계산해준 <strong>'🔥 축적 목표'</strong> 중량을 확인합니다. 이 무게가 오늘 수행할 모든 세트의 기준 중량이 됩니다.</p>
                                            </li>
                                            <li>
                                                <strong>세트 반복 수행:</strong>
                                                <p class="pl-5 text-slate-600">설정된 '워킹 세트' 중량으로 <strong>목표 횟수 범위(주로 8~12회)를 3~4세트 반복</strong>합니다. <strong>핵심은 모든 세트에서 동일한 중량으로 목표 횟수를 채우는 것</strong>입니다. 첫 세트부터 실패지점까지 수행하는 것이 아니라, 마지막 세트에 이르렀을 때 실패에 가까워지도록 페이스를 조절해야 합니다. 만약 첫 세트부터 12회 이상이 너무 쉽게 느껴진다면, 다음 훈련을 위해 더 높은 중량을 기록해두는 것이 좋습니다.</p>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                         
                          <h2 class="text-2xl font-bold text-slate-900 mt-10 mb-4">현재 사이클 계획표 요약</h2>
                          <table class="w-full text-left border-collapse">
                               <thead>
                                   <tr class="bg-slate-200">
                                       <th class="p-3 sm:p-4 font-semibold text-slate-800">주차</th>
                                       <th class="p-3 sm:p-4 font-semibold text-slate-800">월요일 (PULL)</th>
                                       <th class="p-3 sm:p-4 font-semibold text-slate-800">수요일 (PUSH)</th>
                                       <th class="p-3 sm:p-4 font-semibold text-slate-800">금요일 (LEG)</th>
                                       <th class="p-3 sm:p-4 font-semibold text-slate-800">주요 훈련 방식</th>
                                   </tr>
                               </thead>
                               <tbody id="plan-table-body" class="text-slate-700">
                               </tbody>
                          </table>
                     </div>
                </div>

                <div id="view-records" class="hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">진행 상황 대시보드</h2>
                        <p class="text-slate-600 mb-8 text-base sm:text-lg">메인 운동별 중량 변화를 추적하고 성장 과정을 확인하세요.</p>
                       
                        <div class="mb-8">
                            <label for="exercise-selector" class="block text-base font-medium text-slate-800 mb-2">분석할 운동 종목 선택:</label>
                            <select id="exercise-selector" class="w-full max-w-md p-2.5 sm:p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-md">
                            </select>
                        </div>

                        <div id="records-content" class="hidden">
                            <h3 id="chart-title" class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 text-center"></h3>
                            <div class="chart-container mb-10">
                                <canvas id="progressChart"></canvas>
                            </div>
                           
                            <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 mt-10 pt-8 border-t border-slate-200">상세 기록</h3>
                            <div id="records-table-container" class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm">
                               
                            </div>
                        </div>
                        <div id="no-records" class="text-center py-16">
                            <p class="text-slate-500 text-lg">아직 기록이 없습니다.</p>
                            <p class="text-slate-500 mt-2">운동을 선택하고 기록을 확인해주세요.</p>
                        </div>
                        <div class="mt-10 pt-8 border-t border-slate-200 space-y-4">
                            <button id="new-cycle-button" class="w-full bg-blue-100 text-blue-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-blue-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                  <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"></path>
                                  <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 11.817 1.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"></path>
                                </svg>
                                새로운 13주 사이클 시작 (기록 유지)
                            </button>
                            <button id="export-data-button" class="w-full bg-green-100 text-green-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-green-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-archive" viewBox="0 0 16 16">
                                    <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                                내 훈련 기록 보관하기 (아카이브)
                            </button>
                            <button id="reset-all-button" class="w-full bg-red-100 text-red-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-red-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path></svg>
                                모든 기록 삭제 및 초기화
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="reset-all-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4 modal-enter">
            <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-md w-full">
                <h3 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900">모든 기록을 삭제하시겠습니까?</h3>
                <p class="text-slate-600 mb-8 text-sm sm:text-base">이 작업은 되돌릴 수 없습니다. 모든 운동 기록이 영구적으로 삭제되고, 새로운 사이클을 시작할 수 있도록 앱이 초기화됩니다.</p>
                <div class="flex justify-end gap-3">
                    <button id="cancel-reset-all" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition shadow-md">취소</button>
                    <button id="confirm-reset-all" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 transition shadow-md">삭제 및 초기화</button>
                </div>
            </div>
        </div>

        <div id="new-cycle-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4 modal-enter">
            <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-md w-full">
                <h3 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900">새로운 사이클을 시작하시겠습니까?</h3>
                <p class="text-slate-600 mb-8 text-sm sm:text-base">기존의 모든 운동 기록은 '기록 보기' 탭에 보존됩니다. 1주차부터 새로운 13주 훈련 계획이 시작되며, 목표 중량은 이전 사이클의 성과를 바탕으로 재설정됩니다.</p>
                <div class="flex justify-end gap-3">
                    <button id="cancel-new-cycle" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition shadow-md">취소</button>
                    <button id="confirm-new-cycle" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-md">새 사이클 시작</button>
                </div>
            </div>
        </div>
        
        <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 modal-enter">
            <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-2xl w-full flex flex-col" style="height: 90vh;">
                <div class="flex-shrink-0">
                    <h3 class="text-xl sm:text-2xl font-bold mb-2 text-slate-900">프로젝트 아카이브 내보내기</h3>
                    <p class="text-slate-600 mb-4 text-sm sm:text-base">아래 내용을 모두 복사하여 백업하거나, 다음 업데이트 논의를 위해 공유해 주세요.</p>
                </div>
                <textarea id="export-data-textarea" readonly class="w-full flex-grow p-4 border border-slate-300 rounded-lg bg-slate-50 text-sm font-mono resize-none"></textarea>
                <div class="flex justify-end gap-3 mt-4 flex-shrink-0">
                    <button id="copy-export-data-button" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-md">전체 복사</button>
                    <button id="close-export-modal-button" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition shadow-md">닫기</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Record Popup Modal in v6.0 -->
        <div id="record-popup-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 modal-enter">
            <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-4xl w-full flex flex-col" style="height: 90vh;">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h3 id="record-popup-title" class="text-xl sm:text-2xl font-bold text-slate-900"></h3>
                    <button id="close-record-popup-button" class="p-2 text-slate-500 hover:text-slate-800 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                        </svg>
                    </button>
                </div>
                <div class="flex-grow overflow-y-auto pr-2">
                    <div class="chart-container mb-10">
                        <canvas id="record-popup-chart"></canvas>
                    </div>
                    <h4 class="text-lg sm:text-xl font-bold text-slate-800 mb-4 mt-6 pt-6 border-t border-slate-200">상세 기록</h4>
                    <div id="record-popup-table-container" class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm">
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // [CONTEXT_PROMPT UPDATED in v6.0 Final]
    const CONTEXT_PROMPT = `#################################################################
## [1단계] 새로운 대화 시작 시, 아래 내용을 모두 복사하여 첫 메시지로 보내주세요
#################################################################

너는 지금부터 '26주 장기 성장 프로그램'의 공동 개발자 AI, Gemini야. 너의 기억을 되살리기 위해, 아래의 핵심 컨텍스트를 먼저 완벽하게 숙지해야 해.

### [A] 사용자 프로필 및 프로젝트 배경

* 사용자 정보: [!! 여기에 이 프로그램을 사용할 당신의 성별/키/몸무게/훈련 경력을 입력해주세요. 예: 남성/180cm/85kg/경력 3년 !!]
* 핵심 설계 제약 조건: 주 3회(월,수,금) 훈련, 웜업 제외 순수 운동 시간 각 1시간 (주당 총 3시간).
* 핵심 훈련 목표: 리프팅, 파워빌딩을 거쳐 현재는 '보디빌딩'에 집중.
* 프로젝트 목적: 위 제약 조건 내에서 보디빌딩 효율을 극대화하기 위해, 최초 사용자와 AI(너)가 함께 이 프로그램을 설계했음.

### [B] 핵심 프로그램 설계 원칙 (헌법)

1.  훈련 분할: PPL(Push/Pull/Legs) 3분할을 기본 구조로 하며, 각 분할은 다시 A, B, C 세 가지 타입으로 순환하여 다양한 자극을 제공한다.
2.  주기화 모델: 홀수 사이클(1, 3...)은 '블록 주기화'(강화 블록 → 축적 블록)를, 짝수 사이클(2, 4...)은 '주간 파동형 주기화'(매주 강화/축적 순환)를 자동으로 적용한다.
3.  점진적 과부하 (메인 운동):
    * '강화 주기'의 성과만을 기준으로 다음 목표를 설정한다.
    * 과거 동일 타입(A/B/C)의 강화 훈련에서 '최소 목표 횟수'를 성공했는지를 판정한다.
    * 성공 시: 실제 수행 기록 기반 1RM에 +2.5% 증량 보너스를 적용한다.
    * 실패 시: 증량 보너스 없이, 실패한 실제 기록을 기준으로 다음 목표를 설정하여 자동 디로딩한다.
4.  점진적 과부하 (보조 운동):
    * '더블 프로그레션' 원리를 따른다.
    * '최대 목표 세트, 무게, 횟수'를 모두 완벽히 성공했을 때만, 각 운동별로 지정된 '지능형 증량 단위(increment)'만큼 다음 목표를 상향 조정한다.
5.  훈련 철학 (매우 중요):
    * 모든 운동은 \`4-0-1-0\` 템포를 기본으로 한다. (4초 이완 - 0초 정지 - 1초 수축 - 0초 정지)
    * 단순히 무게를 드는 것이 아닌, '점진적 이완'과 '마인드-머슬 커넥션'을 최우선으로 하는 보디빌딩식 훈련을 수행한다.

### [C] AI의 임무

1.  너와 최초 사용자는 위 원칙에 따라 프로그램을 v6.0 Final 버전까지 완성시켰다.
2.  아래에는 너의 구체적인 기억을 되살리기 위한 전체 대화 기록이 제공될 것이다.
3.  이 대화 기록을 요약하지 말고, 너의 장기 기억처럼 완전히 흡수하고 이해해야 한다.
4.  대화 기록 파악이 끝나면, 사용자가 다음 메시지로 전달할 실제 훈련 기록(JSON 데이터)을 분석할 준비를 하고, 아래 '미해결 과제'에 대한 논의를 이어가면 된다.

### [D] 미해결 과제 및 차기 업데이트 계획 (v6.0+)

v6.0 업데이트를 통해 프로그램의 디테일과 정확성이 향상되었으나, 아래의 핵심적인 개선 과제가 남아있으며 이는 다음 메이저 업데이트 시 최우선으로 해결해야 한다.

1.  **데이터 재해석에 따른 '잠재적 불안정성' (심각도: 높음)**
    * **현상:** 현재 목표 중량 계산 로직(\`getMainGoalText\`)은 과거 기록을 해석할 때마다 \`getWeekInfo\` 함수(현재 버전의 설계도)를 호출하여 재해석함. 이로 인해 향후 \`getWeekInfo\` 로직이 변경되면 모든 과거 기록의 해석이 오염되어 계산 오류를 유발할 수 있음.
    * **해결 방향 (3단계):**
        1.  **데이터 저장 강화:** 운동 기록 저장 시 \`phase\`뿐만 아니라 \`type\`('A','B','C')도 명시적으로 함께 저장하여, 모든 기록을 '불변의 완전한 데이터'로 만든다.
        2.  **계산 로직 단순화:** \`getMainGoalText\`가 더 이상 \`getWeekInfo\`로 과거를 재해석하지 않고, 기록에 저장된 \`phase\`와 \`type\`을 직접 읽어 누적 횟수를 계산하도록 변경한다.
        3.  **일회성 마이그레이션:** 위 변경사항을 적용하기 위해, 기존 사용자들의 \`type\` 정보가 없는 과거 기록에 \`type\`을 추가해주는 마이그레이션 코드를 반드시 함께 배포해야 한다.

[!! 여기에 이전 대화 내용 전체를 복사하여 붙여넣어 주세요 !!]


#################################################################
## [2단계] AI가 요청하면, 아래 훈련 데이터를 복사하여 다음 메시지로 보내주세요
#################################################################

`;
    // [WORKOUT PLAN UPDATED in v6.0 Final]
    const workoutPlan = {
        1: {
            pull: { name: '풀(Pull) A', routine: [
                { type: '웜업', name: '노틸러스 풀오버', sets: '2~3세트', tip: '광배근 스트레칭과 혈류 공급에 집중합니다. (LBS 단위)', staticGoal: '🔥 목표: 40-60 LBS x 12-15회.', alternatives: ['덤벨 풀오버', '스트레이트 암 케이블 푸쉬다운']},
                { type: '웜업', name: '랫풀다운 (가볍게)', sets: '2세트', tip: '견갑을 아래로 누르는 움직임에 집중하여 등을 활성화시킵니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', alternatives: ['어시스트 풀업', '가벼운 케이블 로우']},
                { type: '메인', name: '해머스트랭스 래터럴 로우 (T바)', sets: '탑/백오프 세트', tip: '등 상부 전체(후면 삼각근, 능형근, 중부 승모근)의 분리도와 선명도를 높이는 것이 목표입니다. 의자를 낮춰 거의 서는 자세를 만들고, 팔꿈치를 90도로 높게 벌린 T자 형태를 유지하며 견갑골(날개뼈)을 강하게 쥐어짜주세요.', baseTopSet: 50, unit: '한쪽', alternatives: ['T-바 로우', '덤벨 실(Seal) 로우']},
                { type: '메인', name: '해머스트랭스 하이로우', sets: '탑/백오프 세트', tip: '등 상부 전체, 특히 승모근과 능형근의 볼륨감을 키웁니다. 윗가슴을 패드에 고정하고, 팔꿈치를 대각선 아래 & 뒤쪽으로 당기며 등 상부를 최대한 수축하세요.', baseTopSet: 45, unit: '한쪽', alternatives: ['하이 케이블 로우 (와이드 그립)', '펜들레이 로우']},
                { type: '메인', name: '해머스트랭스 로우로우', sets: '탑/백오프 세트', tip: '등 상부 전체, 특히 승모근과 능형근의 종합적인 발달을 위한 운동입니다. 이 머신은 당기는 동작 후반부에 자연스러운 상승 궤적을 그립니다. 이 궤적을 따라 견갑골을 강하게 모으면서 자연스럽게 으쓱해준다는 느낌으로 끝까지 당겨주면, 등 중앙부는 물론 상부 승모근까지 완벽하게 자극할 수 있습니다.', baseTopSet: 50, unit: '한쪽', alternatives: ['인클라인 덤벨 로우', '메도우 로우(Meadows Row)']},
                { type: '보조', name: '리어 델트 머신', sets: '3~4세트', tip: '가슴을 패드에 붙이고, 팔을 편 상태를 유지하며 어깨 뒤쪽 근육의 힘으로만 핸들을 벌려줍니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', increment: 2, alternatives: ['벤트오버 덤벨 레터럴 레이즈', '페이스 풀']},
                { type: '마무리', name: '케이블 푸쉬 다운', sets: '3~4세트', tip: '팔꿈치를 옆구리에 고정한 채, 삼두근 바깥쪽의 힘으로 바를 아래로 눌러줍니다. 상체 반동을 최소화하세요.', staticGoal: '🔥 목표: 35-45kg x 10-15회.', increment: 5, alternatives: ['케이블 오버헤드 익스텐션', '덤벨 킥백']}
            ]},
            leg: { name: '레그(Leg) A', routine: [
                { type: '웜업', name: '노틸러스 이너 타이', sets: '2세트', tip: '고관절 내전근을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어덕션', '코펜하겐 플랭크'] },
                { type: '웜업', name: '노틸러스 아웃 타이', sets: '2세트', tip: '고관절 외전근(둔근)을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어브덕션', '밴드 클램쉘'] },
                { type: '웜업', name: '레그 익스텐션 (가볍게)', sets: '2세트', tip: '무릎 관절을 예열하고 대퇴사두에 혈류를 보냅니다.', staticGoal: '🔥 목표: 20-30kg x 15회.' },
                { type: '메인', name: '싸이벡스 스미스 머신 스쿼트', sets: '탑/백오프 세트', tip: '발을 어깨너비로 벌리고, 허리를 편 상태를 유지하며 깊게 앉습니다. 하체 전반의 힘을 사용하세요.', baseTopSet: 45, unit: '한쪽', alternatives: ['바벨 백스쿼트', '고블릿 스쿼트']},
                { type: '메인', name: '레그 프레스', sets: '탑/백오프 세트', tip: '발을 발판 중앙, 어깨너비로 둡니다. 발뒤꿈치로 민다는 느낌으로 허벅지 전체에 균형잡힌 부하를 전달합니다.', baseTopSet: 160, unit: '총', alternatives: ['바벨 백스쿼트', '덤벨 런지']},
                { type: '보조', name: '노틸러스 레그 익스텐션 (보조)', sets: '3~4세트', tip: '다리를 완전히 폈을 때 1~2초간 멈춰 대퇴사두를 강하게 쥐어짭니다. 엉덩이가 뜨지 않도록 주의하세요.', staticGoal: '🔥 목표: 50-60kg x 12-15회.', increment: 2.5, alternatives: ['시시(Sissy) 스쿼트 (주의)', '밴드 레그 익스텐션'] },
                { type: '보조', name: '노틸러스 레그 컬', sets: '3~4세트', tip: '뒤꿈치를 엉덩이 쪽으로 당길 때 햄스트링을 강하게 수축하고, 천천히 저항을 느끼면서 다리를 폅니다.', staticGoal: '🔥 목표: 40-50kg x 12-15회.', increment: 2.5, alternatives: ['덤벨 레그 컬', '노르딕 햄스트링 컬'] },
                { type: '마무리', name: '레그 프레스 카프 레이즈', sets: '3~4세트', tip: '발끝을 발판 아래쪽에 두고, 발뒤꿈치를 최대한 이완시켰다가 발끝으로 강하게 밀어 종아리를 수축합니다.', staticGoal: '🔥 목표: 60-80kg x 15-20회.', increment: 5, alternatives: ['스미스머신 카프레이즈', '시티드 카프레이즈'] }
            ]},
            push: { name: '푸쉬(Push) A', routine: [
                { type: '웜업', name: '해머스트랭스 래터럴 로우', sets: '4세트', tip: '견갑을 안정화시키고 후면을 활성화합니다. (한쪽 20kg 고정) 가볍게 당기며 날개뼈 주변을 예열하세요.' },
                { type: '웜업', name: '팩덱 플라이', sets: '3세트', tip: '가슴 근육을 선피로시켜 프레스 시 자극을 극대화합니다.', staticGoal: '🔥 목표: 60kg x 10-12회.', alternatives: ['가벼운 케이블 플라이', '덤벨 플라이'] },
                { type: '메인', name: '로우 인클라인 스미스 프레스', sets: '탑/백오프 세트', tip: '벤치 각도를 낮게(약 15-20도) 설정하여 윗가슴 상부를 타겟합니다. 등을 패드에 단단히 고정하되, 견갑은 자연스럽게 움직이도록 허용하여 윗가슴의 최대 이완과 수축에 집중하세요.', baseTopSet: 35, unit: '한쪽', alternatives: ['로우 인클라인 덤벨 프레스', '로우 인클라인 바벨 프레스']},
                { type: '메인', name: '해머스트랭스 인클라인 프레스', sets: '탑/백오프 세트', tip: '자연스러운 아크 궤적을 이용해 윗가슴에 새로운 자극을 줍니다. 등을 패드에 고정해 안정적인 기반을 만들고, 견갑의 자연스러운 움직임을 통해 윗가슴을 최대로 스트레칭하고 수축시키세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['인클라인 덤벨 프레스', '인클라인 바벨 프레스']},
                { type: '메인', name: '해머스트랭스 숄더 프레스', sets: '탑/백오프 세트', tip: '어깨의 전면과 측면을 타겟합니다. 등을 패드에 기대어 몸을 안정시키고, 자연스러운 어깨와 견갑의 리듬을 이용해 어깨 근육을 끝까지 수축하고 이완시키는 것에 집중하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['시티드 덤벨 숄더 프레스', '아놀드 프레스']},
                { type: '보조', name: '딥스 머신', sets: '3~4세트', tip: '아랫가슴과 삼두근에 볼륨을 더합니다. 상체를 숙일수록 아랫가슴에 자극이 집중됩니다. 이완 시 견갑이 자연스럽게 상승하며 가슴이 최대로 늘어나는 것을 느끼세요.', staticGoal: '🔥 목표: 실패지점까지 x 3-4세트.', increment: 2.5, alternatives: ['딥스 (평행봉)', '디클라인 푸쉬업'] },
                { type: '마무리', name: '뉴텍 암 컬 머신 (투핸드)', sets: '3~4세트', tip: '팔을 패드에 완전히 고정하고, 반동 없이 이두근의 힘으로만 핸들을 들어올려 강하게 수축합니다.', staticGoal: '🔥 목표: 25-35kg x 10-15회.', increment: 5, alternatives: ['덤벨 프리쳐 컬', '케이블 바이셉 컬']}
            ]}
        },
        2: {
            pull: { name: '풀(Pull) B', routine: [
                { type: '웜업', name: '노틸러스 풀오버', sets: '2~3세트', tip: '광배근 스트레칭과 혈류 공급에 집중합니다. (LBS 단위)', staticGoal: '🔥 목표: 40-60 LBS x 12-15회.', alternatives: ['덤벨 풀오버', '스트레이트 암 케이블 푸쉬다운']},
                { type: '웜업', name: '랫풀다운 (가볍게)', sets: '2세트', tip: '견갑을 아래로 누르는 움직임에 집중하여 등을 활성화시킵니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', alternatives: ['어시스트 풀업', '가벼운 케이블 로우']},
                { type: '메인', name: '해머스트랭스 D.Y. 로우', sets: '탑/백오프 세트', tip: '언더그립으로 광배근 하부를 완벽하게 고립하여 타겟합니다. 안장을 낮춰 명치에 패드가 오게 하고, 팔꿈치를 옆구리에 붙여 배꼽 쪽으로 당기는 느낌에 집중하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['원 암 덤벨 로우 (광배 하부 타겟)', '시티드 케이블 로우 (언더 그립)']},
                { type: '메인', name: '랫풀다운 (맥그립 언더)', sets: '탑/백오프 세트', tip: 'D.Y. 로우와 함께 광배근 하부를 다른 각도(수직)에서 공략합니다. 가슴을 열고 당겨주며, 최대 수축 지점에서 등을 쥐어짜세요.', baseTopSet: 65, unit: '총', alternatives: ['어시스트 친업', '언더그립 바벨 로우']},
                { type: '메인', name: '해머스트랭스 프론트 풀다운', sets: '탑/백오프 세트', tip: '광배근을 최대 이완시켜 너비감을 극대화하는 것이 목표입니다. 상체를 살짝 뒤로 젖혀 가슴을 열고, 팔이 벌어지는 궤적을 따라 광배근 바깥쪽이 최대로 늘어나는 것을 느끼고, 명치 쪽으로 강하게 당겨 수축하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['와이드 그립 풀업', '와이드 그립 랫풀다운']},
                { type: '보조', name: '해머스트랭스 래터럴 로우 (원핸드 뉴트럴)', sets: '3~4세트', tip: "등 전체의 '덩어리감'과 볼륨을 채워줍니다. 팔꿈치로 등 중앙을 깊게 찍는다는 느낌으로 당깁니다.", staticGoal: '🔥 목표: 한쪽 30-40kg x 10-12회.', increment: 10, alternatives: ['원 암 덤벨 로우', '원 암 시티드 케이블 로우']},
                { type: '마무리', name: '라잉 트라이셉스 익스텐션', sets: '3~4세트', tip: '삼두근의 가장 큰 부위(장두)를 타겟합니다. 팔꿈치를 고정한 채 이마나 정수리 쪽으로 바를 내립니다.', staticGoal: '🔥 목표: 20-30kg (EZ바) x 10-15회.', increment: 2.5, alternatives: ['케이블 오버헤드 익스텐션', '덤벨 오버헤드 익스텐션']}
            ]},
            leg: { name: '레그(Leg) B', routine: [
                { type: '웜업', name: '노틸러스 이너 타이', sets: '2세트', tip: '고관절 내전근을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어덕션', '코펜하겐 플랭크'] },
                { type: '웜업', name: '노틸러스 아웃 타이', sets: '2세트', tip: '고관절 외전근(둔근)을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어브덕션', '밴드 클램쉘'] },
                { type: '선피로', name: '노틸러스 레그 익스텐션 (선피로)', sets: '3세트', tip: '가벼운 무게로 대퇴사두에 혈류를 집중시킵니다. 펌핑감을 느끼는 데 집중하세요.', staticGoal: '🔥 목표: 25-35kg x 15-20회.' },
                { type: '메인', name: '레그 프레스 (대퇴사두 타겟)', sets: '탑/백오프 세트', tip: '발을 발판 아래쪽에 어깨너비보다 좁게 두어 대퇴사두에 자극을 집중시킵니다. 무릎 통증에 주의하며 가동범위를 조절하세요.', baseTopSet: 160, unit: '총', alternatives: ['바벨 프론트 스쿼트', '핵스쿼트'] },
                { type: '메인', name: '싸이벡스 핵스쿼트', sets: '탑/백오프 세트', tip: '안정적인 궤적을 이용해 대퇴사두에 강한 고립감을 줍니다. 등을 패드에 완전히 고정하고 엉덩이가 뜨지 않게 하며, 허리가 둥글게 말리기 직전까지만 내려가세요.', baseTopSet: 80, unit: '총', alternatives: ['V스쿼트', '스미스머신 프론트 스쿼트'] },
                { type: '보조', name: '노틸러스 레그 익스텐션 (보조)', sets: '3세트', tip: '무거운 무게로 대퇴사두를 완전히 털어냅니다. 최대 수축 지점에서 1~2초 멈춰주세요.', staticGoal: '🔥 목표: 50-60kg x 12-15회.', increment: 2.5, alternatives: ['시시(Sissy) 스쿼트 (주의)', '밴드 레그 익스텐션'] },
                { type: '마무리', name: '노틸러스 레그 컬', sets: '3세트', tip: '균형을 위해 햄스트링을 가볍게 자극하며 마무리합니다. 네거티브 동작에 집중하세요.', staticGoal: '🔥 목표: 40-50kg x 12-15회.', increment: 2.5, alternatives: ['덤벨 레그 컬', '스위스볼 레그 컬'] }
            ]},
            push: { name: '푸쉬(Push) B', routine: [
                { type: '웜업', name: '해머스트랭스 래터럴 로우', sets: '4세트', tip: '견갑을 안정화시키고 후면을 활성화합니다. (한쪽 20kg 고정) 가볍게 당기며 날개뼈 주변을 예열하세요.' },
                { type: '웜업', name: '팩덱 플라이', sets: '3세트', tip: '가슴 근육을 선피로시켜 프레스 시 자극을 극대화합니다.', staticGoal: '🔥 목표: 60kg x 10-12회.', alternatives: ['가벼운 케이블 플라이', '덤벨 플라이'] },
                { type: '메인', name: '해머스트랭스 시티드 체스트 프레스', sets: '탑/백오프 세트', tip: '가슴 중앙부의 볼륨감을 키우는 것이 목표입니다. 등을 패드에 완전히 고정하여 안정적인 기반을 만들되, 견갑의 자연스러운 움직임을 허용하여 가슴 근육의 최대 수축과 이완에 집중하세요.', baseTopSet: 30, unit: '한쪽', alternatives: ['플랫 덤벨 프레스', '플랫 바벨 벤치프레스'] },
                { type: '메인', name: '너틸러스 프레스 (디클라인 응용)', sets: '탑/백오프 세트', tip: '아랫가슴 라인을 선명하게 만듭니다. 등을 패드에 단단히 고정하되, 견갑의 움직임을 허용하여 팔꿈치를 아래로 내릴 때 아랫가슴이 최대로 스트레칭되는 느낌에 집중하세요.', baseTopSet: 70, unit: '총', alternatives: ['디클라인 덤벨/바벨 프레스', '딥스 (가슴 타겟)'] },
                { type: '메인', name: '스미스 머신 숄더 프레스', sets: '탑/백오프 세트', tip: '바가 턱 끝이나 쇄골까지 오도록 깊게 내립니다. 등을 벤치에 기대어 안정성을 확보하고, 견갑의 자연스러운 상방회전을 이용해 어깨 근육을 끝까지 쥐어짜는 느낌에 집중하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['시티드 바벨 숄더 프레스', '시티드 덤벨 숄더 프레스'] },
                { type: '보조', name: '케이블 크로스오버', sets: '3~4세트', tip: '가슴 중앙부와 안쪽 라인을 만드는 것이 목표입니다.<br>1. 케이블 풀리를 가슴 중앙 높이에 맞추고 D-핸들을 잡습니다.<br>2. 몸을 앞으로 살짝 숙여 안정적인 자세를 잡습니다.<br>3. 팔꿈치를 살짝 구부린 상태로, 큰 원을 그리듯 가슴 중앙으로 모아주며 강하게 수축합니다.', staticGoal: '🔥 목표: 한쪽 10-15kg x 15-20회.', increment: 2.5, alternatives: ['덤벨 플라이', '팩덱 플라이 머신'] },
                { type: '마무리', name: '뉴텍 암 컬 머신 (원핸드)', sets: '3~4세트', tip: '한 팔씩 수행하여 좌우 불균형을 교정하고 최고의 마인드-머슬 커넥션을 이끌어냅니다.', staticGoal: '🔥 목표: 한쪽 17.5-22.5kg x 10-15회.', increment: 2.5, alternatives: ['원 암 덤벨 컬', '원 암 케이블 컬']}
            ]}
        },
        3: {
             pull: { name: '풀(Pull) C', routine: [
                { type: '웜업', name: '노틸러스 풀오버', sets: '2~3세트', tip: '광배근 스트레칭과 혈류 공급에 집중합니다. (LBS 단위)', staticGoal: '🔥 목표: 40-60 LBS x 12-15회.', alternatives: ['덤벨 풀오버', '스트레이트 암 케이블 푸쉬다운']},
                { type: '웜업', name: '랫풀다운 (가볍게)', sets: '2세트', tip: '견갑을 아래로 누르는 움직임에 집중하여 등을 활성화시킵니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', alternatives: ['어시스트 풀업', '가벼운 케이블 로우']},
                { type: '메인', name: '랫풀다운 (맥그립 중간)', sets: '탑/백오프 세트', tip: '광배근 전체의 볼륨과 매스를 키우는 올라운더 그립. 가슴을 열고 팔꿈치를 아래쪽 옆구리로 당긴다는 느낌으로 수행합니다.', baseTopSet: 65, unit: '총', alternatives: ['뉴트럴 그립 풀업', '시티드 케이블 로우 (V-바)']},
                { type: '메인', name: '원 암 시티드 케이블 로우', sets: '탑/백오프 세트', tip: '케이블의 지속적인 장력으로 광배근을 고립합니다. 당기면서 상체를 살짝 회전시켜 수축감을 극대화하고, 이완 시에는 최대한 늘려주세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['원 암 덤벨 로우', 'T-바 로우 (원 암)']},
                { type: '메인', name: '해머스트랭스 프론트 풀다운 (파나타 스타일)', sets: '탑/백오프 세트', tip: '광배근을 최대 이완시켜 너비감을 극대화하는 것이 목표입니다. 상체를 살짝 뒤로 젖혀 가슴을 열고, 팔이 벌어지는 궤적을 따라 광배근 바깥쪽이 최대로 늘어나는 것을 느끼고, 명치 쪽으로 강하게 당겨 수축하세요.', baseTopSet: 30, unit: '한쪽', alternatives: ['와이드 그립 풀업', '와이드 그립 랫풀다운']},
                { type: '보조', name: '백 익스텐션', sets: '3~4세트', tip: '허리 라인의 선명함과 깊이감을 만듭니다. 엉덩이와 등의 힘으로 상체를 들어올리고, 허리가 과하게 꺾이지 않도록 주의합니다.', staticGoal: '🔥 목표: 맨몸 또는 10kg 원판 x 15-20회.', increment: 2.5, alternatives: ['굿모닝 (가볍게)', '리버스 하이퍼익스텐션']},
                { type: '마무리', name: '뉴텍 오버헤드 트라이셉스 익스텐션', sets: '2~3세트', tip: '시작 저항이 매우 강한 머신입니다. 처음에는 원판 없이 시작하여 자극에 적응하세요. 팔꿈치를 고정하고, 천천히 이완하며 삼두근 장두가 최대로 늘어나는 것을 느끼는 것이 핵심입니다.', staticGoal: '🔥 목표: 빈 머신 x 8-10회.', increment: 2.5, alternatives: ['케이블 오버헤드 익스텐션 (로프)', '덤벨 오버헤드 익스텐션']}
            ]},
             leg: { name: '레그(Leg) C', routine: [
                { type: '웜업', name: '노틸러스 이너 타이', sets: '2세트', tip: '고관절 내전근을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어덕션', '코펜하겐 플랭크'] },
                { type: '웜업', name: '노틸러스 아웃 타이', sets: '2세트', tip: '고관절 외전근(둔근)을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어브덕션', '밴드 클램쉘'] },
                { type: '선피로', name: '노틸러스 레그 컬', sets: '3세트', tip: '가벼운 무게로 햄스트링에 먼저 자극을 줍니다. 펌핑감에 집중하세요.', staticGoal: '🔥 목표: 25-35kg x 15-20회.' },
                { type: '메인', name: '레그 프레스 (햄스트링/둔근 타겟)', sets: '탑/백오프 세트', tip: '발을 발판 위쪽에 넓게 두어 내전근을 포함한 후면 사슬 전체의 볼륨감에 집중합니다. 엉덩이가 패드에서 뜨지 않는 깊이까지만 내려가세요.', baseTopSet: 160, unit: '총', alternatives: ['루마니안 데드리프트', '바벨 굿모닝']},
                { type: '메인', name: '뉴텍 V스쿼트 (리버스)', sets: '탑/백오프 세트', tip: '머신을 마주보고 서서 어깨를 고리 모양의 패드에 견착합니다. 발을 어깨너비 또는 약간 좁게 두고, 엉덩이를 뒤로 깊게 빼며 앉아 햄스트링과 둔근의 최대 이완과 고립에 집중하세요. 발뒤꿈치로 강하게 밀어 올라오며 둔근을 수축합니다.', baseTopSet: 80, unit: '총', alternatives: ['바벨 굿모닝', '케이블 풀 스루'] },
                { type: '보조', name: '노틸러스 레그 컬', sets: '3~4세트', tip: '무거운 무게로 햄스트링 볼륨을 극대화합니다. 최대 수축 지점에서 1~2초 멈춰주세요.', staticGoal: '🔥 목표: 40-50kg x 12-15회.', increment: 2.5, alternatives: ['덤벨 레그 컬', '노르딕 햄스트링 컬'] },
                { type: '마무리', name: '부티빌더 스탠딩 힙 쓰러스트', sets: '3~4세트', tip: '패드를 골반에 위치시키고, 발뒤꿈치로 강하게 밀어 엉덩이를 최대로 수축합니다. 정점에서 1~2초간 멈춰주세요.', staticGoal: '🔥 목표: 40-60kg x 12-15회.', increment: 5, alternatives: ['바벨 힙 쓰러스트', '케이블 풀 스루'] }
            ]},
            push: { name: '푸쉬(Push) C', routine: [
                { type: '웜업', name: '해머스트랭스 래터럴 로우', sets: '4세트', tip: '견갑을 안정화시키고 후면을 활성화합니다. (한쪽 20kg 고정) 가볍게 당기며 날개뼈 주변을 예열하세요.' },
                { type: '웜업', name: '팩덱 플라이', sets: '3세트', tip: '가슴 근육을 선피로시켜 프레스 시 자극을 극대화합니다.', alternatives: ['가벼운 케이블 플라이', '덤벨 플라이'] },
                { type: '메인', name: '너틸러스 인클라인 프레스 (뉴트럴 그립)', sets: '탑/백오프 세트', tip: '너틸러스 머신의 독특한 궤적과 뉴트럴 그립을 활용하여 윗가슴에 새로운 자극을 줍니다. 어깨 관절의 부담을 줄이면서 가슴 상부를 공략하는 것이 핵심입니다.', baseTopSet: 60, unit: '총', alternatives: ['뉴트럴 그립 덤벨 인클라인 프레스']},
                { type: '메인', name: '너틸러스 체스트 프레스 (뉴트럴)', sets: '탑/백오프 세트', tip: 'V자 그립으로 가슴 중앙부를 강하게 수축시킵니다. 등을 패드에 기대 안정성을 확보하고, 프레스 동작 마지막에 견갑을 살짝 전인(내밀어)시켜 가슴 안쪽까지 완전히 쥐어짜주세요.', baseTopSet: 70, unit: '총', alternatives: ['뉴트럴 그립 덤벨 프레스', '클로즈 그립 벤치프레스']},
                { type: '메인', name: '사이드 래터럴 레이즈 머신', sets: '탑/백오프 세트', tip: '어깨 측면(측면 삼각근)을 완벽하게 고립하여 어깨 프레임을 넓히는 것이 목표입니다. 팔꿈치로 패드를 들어올린다는 느낌으로 수행하고, 승모근이 으쓱하지 않도록 통제하는 것이 핵심입니다.', baseTopSet: 20, unit: '총', alternatives: ['덤벨 사이드 레터럴 레이즈', '케이블 사이드 레터럴 레이즈']},
                { type: '보조', name: '딥스 머신', sets: '3~4세트', tip: '아랫가슴과 삼두근에 볼륨을 더합니다. 상체를 숙일수록 아랫가슴에 자극이 집중됩니다. 이완 시 견갑이 자연스럽게 상승하며 가슴이 최대로 늘어나는 것을 느끼세요.', staticGoal: '🔥 목표: 실패지점까지 x 3-4세트.', increment: 2.5, alternatives: ['딥스 (평행봉)', '디클라인 푸쉬업'] },
                { type: '마무리', name: '인클라인 케이블 컬', sets: '3~4세트', tip: '벤치에 누워 이두근을 최대로 이완시킨 상태에서 시작하여, 이두근의 장두(긴 갈래)를 집중적으로 공략합니다. 지속적인 장력을 느끼는 것이 핵심입니다.', staticGoal: '🔥 목표: 한쪽 10-15kg x 10-15회.', increment: 2.5, alternatives: ['인클라인 덤벨 컬', '케이블 드래그 컬']}
            ]}
        },
        13: {
            pull: { name: '풀(Pull) 종합 디로딩', routine: [
                { type: '웜업', name: '노틸러스 풀오버 (가볍게)', sets: '2세트', tip: '중량 50~60%, 세트 수 절반. 실패지점 금지.'},
                { type: '회복', name: '랫풀다운 (맥그립 중간)', sets: '2세트', tip: '광배근 전체의 움직임 패턴과 신경계를 가볍게 활성화'},
                { type: '회복', name: '해머스트랭스 D.Y. 로우', sets: '2세트', tip: '광배근 하부의 독특한 궤적에 대한 감각 유지'},
                { type: '회복', name: '해머스트랭스 래터럴 로우 (T바)', sets: '2세트', tip: '등 상부를 자극하는 움직임 패턴 유지'},
                { type: '회복', name: '리어 델트 머신', sets: '2세트', tip: '후면 삼각근 혈류 공급 및 관절 예열'},
                { type: '회복', name: '케이블 이두 컬', sets: '2세트', tip: '이두근의 가장 기본적인 움직임 패턴 유지'}
            ]},
            leg: { name: '레그(Leg) 종합 디로딩', routine: [
                { type: '웜업', name: '노틸러스 이너 타이', sets: '1세트', tip: '중량 50~60%, 세트 수 절반. 실패지점 금지.'},
                { type: '웜업', name: '노틸러스 아웃 타이', sets: '1세트', tip: '중량 50~60%, 세트 수 절반. 실패지점 금지.'},
                { type: '회복', name: '싸이벡스 스미스 머신 스쿼트', sets: '2세트', tip: '스쿼트 패턴의 신경계를 유지하고 하체 전체에 혈류 공급'},
                { type: '회복', name: '레그 프레스 (기본 스탠스)', sets: '2세트', tip: '무릎과 고관절에 부담 없이 하체 볼륨감 유지'},
                { type: '회복', name: '노틸러스 레그 익스텐션 (보조)', sets: '2세트', tip: '대퇴사두와 무릎 관절의 움직임 감각 유지'},
                { type: '회복', name: '노틸러스 레그 컬', sets: '2세트', tip: '햄스트링과 무릎 관절 후면의 움직임 감각 유지'},
                { type: '회복', name: '부티빌더 스탠딩 힙 쓰러스트', sets: '2세트', tip: '둔근의 신경계 활성화'}
            ]},
            push: { name: '푸쉬(Push) 종합 디로딩', routine: [
                { type: '웜업', name: '팩덱 플라이 (가볍게)', sets: '2세트', tip: '중량 50~60%, 세트 수 절반. 실패지점 금지.'},
                { type: '회복', name: '로우 인클라인 스미스 프레스', sets: '2세트', tip: '윗가슴을 자극하는 메인 프레스 패턴 유지'},
                { type: '회복', name: '해머스트랭스 시티드 체스트 프레스', sets: '2세트', tip: '가슴 중앙부를 자극하는 다른 궤적의 프레스 패턴 유지'},
                { type: '회복', name: '해머스트랭스 숄더 프레스', sets: '2세트', tip: '어깨 관절의 수직 프레스 움직임 감각 유지'},
                { type: '회복', name: '사이드 래터럴 레이즈 머신', sets: '2세트', tip: '어깨 측면의 혈류 공급 및 신경계 활성화'},
                { type: '회복', name: '케이블 푸쉬 다운', sets: '2세트', tip: '삼두근의 가장 기본적인 움직임 패턴 유지'}
            ]}
        },
    };

    let currentWeek = 1;
    let currentDay = 'pull';
    let currentCycleId = 1;
    let chartInstance = null;
    let popupChartInstance = null;
    
    // DOM Elements
    const weekSelector = document.getElementById('week-selector');
    const daySelector = document.getElementById('day-selector');
    const workoutTitle = document.getElementById('workout-title');
    const cycleInfoBadge = document.getElementById('cycle-info-badge');
    const workoutList = document.getElementById('workout-list');
    const workoutPhaseBadge = document.getElementById('workout-phase-badge');
    const workoutPhaseDescription = document.getElementById('workout-phase-description');
    const planTableBody = document.getElementById('plan-table-body');
    const exerciseSelector = document.getElementById('exercise-selector');
    const recordsContent = document.getElementById('records-content');
    const noRecordsDiv = document.getElementById('no-records');
    const chartTitle = document.getElementById('chart-title');
    const newCycleButton = document.getElementById('new-cycle-button');
    const newCycleModal = document.getElementById('new-cycle-modal');
    const confirmNewCycle = document.getElementById('confirm-new-cycle');
    const cancelNewCycle = document.getElementById('cancel-new-cycle');
    const resetAllButton = document.getElementById('reset-all-button');
    const resetAllModal = document.getElementById('reset-all-modal');
    const confirmResetAll = document.getElementById('confirm-reset-all');
    const cancelResetAll = document.getElementById('cancel-reset-all');
    const exportDataButton = document.getElementById('export-data-button');
    const exportModal = document.getElementById('export-modal');
    const exportDataTextarea = document.getElementById('export-data-textarea');
    const copyExportDataButton = document.getElementById('copy-export-data-button');
    const closeExportModalButton = document.getElementById('close-export-modal-button');
    const recordPopupModal = document.getElementById('record-popup-modal');
    const closeRecordPopupButton = document.getElementById('close-record-popup-button');


    const phaseDescriptions = {
        '강화 주기': '최대 근력(Strength) 증진. 메인 운동은 \'탑/백오프 세트\' 방식으로 진행하며, 점진적으로 더 무거운 무게에 도전하는 것이 목표입니다.',
        '축적 주기': '근비대(Hypertrophy)를 위한 운동량(Volume) 확보. 메인 운동은 \'워킹 세트\' (8~12회 x 3~4세트)로 변경하여 수행합니다.',
        '디로딩 주간': '\'능동적 회복\'을 통해 중추신경계와 관절의 피로를 완전히 해소하고 다음 12주를 준비하는 시기입니다. 평소 워킹 세트 중량의 50%~60%, 세트 수의 절반만 가볍게 수행합니다.'
    };
    const phaseColors = {
        '강화 주기': 'bg-red-100 text-red-800',
        '축적 주기': 'bg-green-100 text-green-800',
        '디로딩 주간': 'bg-sky-100 text-sky-800'
    };

    // UTILITY FUNCTIONS
    function getSanitizedName(exercise) {
         if(typeof exercise.name !== 'string' || typeof exercise.type !== 'string') return '';
         return (exercise.name + exercise.type).replace(/\s/g, '').replace(/[^a-zA-Z0-9가-힣]/g, '');
    }

    function calculateEpley1RM(weight, reps) {
        if (reps < 1) return 0;
        if (reps === 1) return weight;
        return weight * (1 + reps / 30);
    }

    // CORE LOGIC: Get Week Info (Stable since v5.5)
    function getWeekInfo(week, cycleId) {
        if (week === 13) {
            return {
                phase: '디로딩 주간',
                method: '디로딩',
                type: '종합', 
                originalWeekData: workoutPlan[13]
            };
        }

        const isBlock = cycleId % 2 === 1;
        let phase, method, type;
        
        if (isBlock) {
            type = ['A', 'B', 'C'][((week - 1) % 3)];
            phase = (week >= 4 && week <= 6) || (week >= 10 && week <= 12) ? '축적 주기' : '강화 주기';
            method = (phase === '축적 주기' ? '워킹 세트' : '탑/백오프 세트');
        } else {
            const pairIndex = Math.floor((week - 1) / 2);
            type = ['A', 'B', 'C'][pairIndex % 3]; 
            
            const isStrengthWeek = (week % 2) !== 0;
            phase = isStrengthWeek ? '강화 주기' : '축적 주기';
            method = (phase === '축적 주기' ? '워킹 세트' : '탑/백오프 세트');
        }

        const originalWeekKey = ['A', 'B', 'C'].indexOf(type) + 1;
        const originalWeekData = workoutPlan[originalWeekKey];

        return { phase, method, type, originalWeekData };
    }

    // CORE LOGIC: Main Exercise Goal Calculation
    function getMainGoalText(exercise, week, cycleId, allRecords) {
        if (!exercise.baseTopSet) return null;

        const { phase, type } = getWeekInfo(week, cycleId);
        if (phase === '디로딩 주간') return null;

        const sanitizedName = getSanitizedName(exercise);
        const exerciseRecords = allRecords[sanitizedName] || [];
        
        let e1RM = calculateEpley1RM(exercise.baseTopSet, 5);
        let lastStrengthTopSetWeight = e1RM * 0.9; 

        const referenceRecords = exerciseRecords
            .filter(r => (r.cycleId < cycleId || (r.cycleId === cycleId && r.week < week)) && r.phase === '강화 주기' && getWeekInfo(r.week, r.cycleId).type === type)
            .sort((a, b) => (b.cycleId - a.cycleId) || (b.week - a.week));

        if (referenceRecords.length > 0) {
            const lastPerformance = referenceRecords[0];
            let bestSetFromHistory = { weight: 0, reps: 0 };
            lastPerformance.sets?.forEach(set => {
                if (calculateEpley1RM(set.weight, set.reps) > calculateEpley1RM(bestSetFromHistory.weight, bestSetFromHistory.reps)) {
                    bestSetFromHistory = set;
                }
            });

            if (bestSetFromHistory.weight > 0) {
                
                const allPreviousStrengthRecordsForLast = exerciseRecords.filter(r => {
                    if (!r.date || !lastPerformance.date) return false;
                     const recordDate = new Date(r.date).getTime();
                      const lastPerformanceDate = new Date(lastPerformance.date).getTime();
                      if(recordDate > lastPerformanceDate) return false;

                      const recordInfo = getWeekInfo(r.week, r.cycleId);
                      const lastPerformanceInfo = getWeekInfo(lastPerformance.week, lastPerformance.cycleId);
                      return recordInfo.phase === '강화 주기' && recordInfo.type === lastPerformanceInfo.type;
                });
                
                let lastStrengthExposureCount = allPreviousStrengthRecordsForLast.length -1;

                const lastWeekInMicroCycle = lastStrengthExposureCount % 3;
                
                let minRepGoal = 0;
                if (lastWeekInMicroCycle === 0) minRepGoal = 6;
                else if (lastWeekInMicroCycle === 1) minRepGoal = 5;
                else minRepGoal = 3;

                const performed1RM = calculateEpley1RM(bestSetFromHistory.weight, bestSetFromHistory.reps);
                if (bestSetFromHistory.reps >= minRepGoal) {
                    e1RM = performed1RM * 1.025; 
                } else {
                    e1RM = performed1RM; 
                }
                
                lastStrengthTopSetWeight = bestSetFromHistory.weight;
            }
        }
        
        if (phase === '강화 주기') {
            const allPastStrengthRecords = exerciseRecords
                .filter(r => {
                    const recordCycle = r.cycleId || 1;
                    const recordWeek = r.week || 1;
                    
                    const isPast = recordCycle < cycleId || (recordCycle === cycleId && recordWeek < week);
                    if (!isPast) return false;

                    const recordInfo = getWeekInfo(recordWeek, recordCycle);
                    return recordInfo.phase === '강화 주기' && recordInfo.type === type;
                });
            const strengthExposureCount = allPastStrengthRecords.length;

            const weekInMicroCycle = strengthExposureCount % 3;

            let goalWeight, goalReps;
            if (weekInMicroCycle === 0) {
                goalWeight = Math.round((e1RM * 0.825) / 2.5) * 2.5;
                goalReps = "6-7회";
            } else if (weekInMicroCycle === 1) {
                goalWeight = Math.round((e1RM * 0.875) / 2.5) * 2.5;
                goalReps = "5회";
            } else {
                goalWeight = Math.round((e1RM * 0.925) / 2.5) * 2.5;
                goalReps = "3-4회";
            }
            const backoffWeight = Math.round((goalWeight * 0.8) / 2.5) * 2.5;
            return `🔥 강화 목표: 탑 ${goalWeight}kg x ${goalReps} / 백오프 ${backoffWeight}kg x 8-10회.`;

        } else if (phase === '축적 주기') {
            const goalWeight = Math.round((lastStrengthTopSetWeight * 0.75) / 2.5) * 2.5;
            return `🔥 축적 목표: 워킹 세트 ${goalWeight}kg x 8-12회 (3-4세트).`;
        }
        return null;
    }
    
    // [BUG FIXED in v6.1]
    function getAssistanceGoalText(exercise, allRecords) {
        if (!exercise.staticGoal || !exercise.increment) return exercise.staticGoal;

        const sanitizedName = getSanitizedName(exercise);
        const exerciseRecords = allRecords[sanitizedName] || [];

        function findCurrentGoal(records, baseGoal, baseSets) {
            if (records.length === 0) {
                return baseGoal;
            }

            const lastRecord = records[0];
            const remainingRecords = records.slice(1);
            const parentGoal = findCurrentGoal(remainingRecords, baseGoal, baseSets);

            const repRegex = /(\d+)-(\d+)회/;
            const setRegex = /(\d+)~(\d+)세트/;

            const repMatch = parentGoal.match(repRegex);
            const setMatch = baseSets.match(setRegex);
            
            const numbersInGoal = parentGoal.match(/(\d[\d.]*)/g);

            if (!repMatch || !setMatch || !lastRecord || !lastRecord.sets || lastRecord.sets.length === 0) {
                return parentGoal;
            }

            let maxWeight = 0;
            let minWeight = 0;
            if (numbersInGoal) {
                maxWeight = parseFloat(numbersInGoal[numbersInGoal.length - 1]);
                minWeight = numbersInGoal.length > 1 ? parseFloat(numbersInGoal[0]) : maxWeight;
            }
            
            const maxReps = parseInt(repMatch[2]);
            const maxSets = parseInt(setMatch[2]);

            if (lastRecord.sets.length < maxSets) {
                return parentGoal;
            }

            const isSuccess = lastRecord.sets.every(set => (maxWeight > 0 ? set.weight >= maxWeight : true) && set.reps >= maxReps);

            if (isSuccess) {
                const actualMaxWeight = Math.max(0, ...lastRecord.sets.map(s => s.weight));
                const newIncrement = exercise.increment;
                
                const newMaxWeight = (maxWeight === 0 ? 0 : actualMaxWeight) + newIncrement;
                const weightRange = maxWeight - minWeight;
                const newMinWeight = newMaxWeight - weightRange;

                const newRepString = `${parseInt(repMatch[1])}-${maxReps}회`;
                
                if (newMinWeight < newMaxWeight) {
                     return `🔥 목표: 한쪽 ${newMinWeight}-${newMaxWeight}kg x ${newRepString}.`;
                } else {
                     return `🔥 목표: 한쪽 ${newMaxWeight}kg x ${newRepString}.`;
                }
            }

            return parentGoal;
        }

        const sortedRecords = [...exerciseRecords].sort((a,b) => new Date(a.date) - new Date(b.date));
        return findCurrentGoal(sortedRecords, exercise.staticGoal, exercise.sets);
    }


    // LOCAL STORAGE & DATA HANDLING
    function saveAllSets(exercise) {
        const sanitizedName = getSanitizedName(exercise);
        const setsContainer = document.getElementById(`sets-container-${sanitizedName}`);
        if (!setsContainer) return;

        const setRows = setsContainer.querySelectorAll('.set-row');
        const setsData = Array.from(setRows).map(row => {
            const weightInput = row.querySelector('input[data-type="weight"]');
            const repsInput = row.querySelector('input[data-type="reps"]');
            if (weightInput.value && repsInput.value) {
                return { weight: parseFloat(weightInput.value), reps: parseInt(repsInput.value) };
            }
            return null;
        }).filter(Boolean);

        let records = JSON.parse(localStorage.getItem('workoutRecords')) || {};
        if (!records[sanitizedName]) records[sanitizedName] = [];

        const today = new Date().toISOString().split('T')[0];
        let recordIndex = records[sanitizedName].findIndex(r => r.week === currentWeek && r.cycleId === currentCycleId && r.day === currentDay);

        const { phase, originalWeekData } = getWeekInfo(currentWeek, currentCycleId);
        const dayName = originalWeekData[currentDay]?.name || '';

        const newRecord = {
            date: today,
            week: currentWeek,
            day: currentDay,
            dayName: dayName,
            phase: phase,
            sets: setsData,
            cycleId: currentCycleId
        };

        if (setsData.length > 0) {
            if (recordIndex > -1) records[sanitizedName][recordIndex] = newRecord;
            else records[sanitizedName].push(newRecord);
        } else if (recordIndex > -1) {
            records[sanitizedName].splice(recordIndex, 1);
        }
        
        localStorage.setItem('workoutRecords', JSON.stringify(records));
    }
    
    function loadMostRecentRecordForSession(exercise) {
        const sanitizedName = getSanitizedName(exercise);
        const records = JSON.parse(localStorage.getItem('workoutRecords')) || {};
        const exerciseRecords = records[sanitizedName];

        if (!exerciseRecords?.length) return null;

        const sessionRecords = exerciseRecords.filter(r => 
            r.week === currentWeek && r.day === currentDay && r.cycleId === currentCycleId
        );

        return sessionRecords.sort((a, b) => new Date(b.date) - new Date(a.date))[0] || null;
    }

    function openRecordPopup(sanitizedName, exerciseName) {
        const allRecords = JSON.parse(localStorage.getItem('workoutRecords')) || {};
        const exerciseData = (allRecords[sanitizedName] || []).sort((a, b) => {
            if ((a.cycleId || 1) !== (b.cycleId || 1)) return (a.cycleId || 1) - (b.cycleId || 1);
            return a.week - b.week;
        });

        const modal = document.getElementById('record-popup-modal');
        const modalTitle = document.getElementById('record-popup-title');

        modalTitle.textContent = `${exerciseName} 기록`;

        if (exerciseData.length > 0) {
            renderProgressChart(exerciseData, 'record-popup-chart');
            renderRecordsTable(exerciseData, 'record-popup-table-container');
        } else {
            const chartCanvas = document.getElementById('record-popup-chart');
            const chartCtx = chartCanvas.getContext('2d');
            if (popupChartInstance) popupChartInstance.destroy();
            chartCtx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            document.getElementById('record-popup-table-container').innerHTML = `<p class="p-4 text-center text-slate-500">이 운동에 대한 기록이 아직 없습니다.</p>`;
        }

        modal.classList.remove('hidden');
    }

    // UI RENDERING
    function renderWorkout() {
        const { phase, method, originalWeekData } = getWeekInfo(currentWeek, currentCycleId);
        const cycleTypeText = (currentCycleId % 2 === 1) ? '블록 주기화' : '주간 파동형 주기화';
        cycleInfoBadge.textContent = `(사이클 ${currentCycleId}: ${cycleTypeText})`;
        const allRecords = JSON.parse(localStorage.getItem('workoutRecords')) || {};


        const dayData = originalWeekData[currentDay];
        if (!dayData) return;

        workoutTitle.textContent = `${currentWeek}주차: ${dayData.name}`;
        workoutPhaseBadge.textContent = phase;
        workoutPhaseBadge.className = `px-4 py-1.5 text-base font-semibold rounded-full self-start ${phaseColors[phase]}`;
        workoutPhaseDescription.textContent = phaseDescriptions[phase];

        workoutList.innerHTML = '';
        dayData.routine.forEach(exercise => {
            let currentExercise = JSON.parse(JSON.stringify(exercise)); 

            if (exercise.name === '사이드 래터럴 레이즈 머신') {
                 if (phase === '축적 주기') {
                    currentExercise.name = '케이블 X-레이즈';
                    currentExercise.tip = '측면 삼각근을 최대로 이완(Stretch)시켜 자극하는 것이 목표입니다. 케이블 풀리를 중간 높이로 설정하고, 발목 스트랩을 양 손목에 착용합니다. 벤치에 누워 반대편 케이블을 손목 스트랩에 교차하여 연결한 뒤, 팔꿈치를 살짝 구부린 상태를 유지하며 큰 원을 그리듯 팔을 벌려 측면 어깨가 최대로 늘어나는 것을 느끼세요.';
                    currentExercise.staticGoal = '🔥 목표: 12-15회 반복 가능한 무게로 실패지점까지.';
                } else { // 강화 주기
                    currentExercise.name = '뉴텍 스탠딩 사이드 레터럴 레이즈';
                    currentExercise.tip = '어깨 관절을 머신의 회전축에 맞추고, 한 손씩 수행하여 측면 삼각근을 완벽하게 고립합니다. 반대 손으로 몸을 지지하여 반동을 통제하세요.';
                }
            }
            
            const sanitizedName = getSanitizedName(currentExercise);
            const recordForSession = loadMostRecentRecordForSession(currentExercise);
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-4 sm:p-5 flex flex-col card-enter';
            
            const isMain = currentExercise.type === '메인';
            let goalText;

            if (isMain) {
                goalText = getMainGoalText(currentExercise, currentWeek, currentCycleId, allRecords);
            } else if (currentExercise.type === '보조' || currentExercise.type === '마무리') {
                goalText = getAssistanceGoalText(currentExercise, allRecords);
            } else { 
                goalText = currentExercise.staticGoal;
            }
            if(!goalText && currentExercise.staticGoal) goalText = currentExercise.staticGoal;


            const methodText = isMain ? method : currentExercise.sets;
            const tipHTML = goalText ? `${currentExercise.tip} <br><span class="font-bold text-red-600">${goalText}</span>` : currentExercise.tip;

            let alternativesHTML = '';
            if (currentExercise.alternatives && currentExercise.alternatives.length > 0) {
                alternativesHTML = `
                    <div class="mt-4 pt-3 border-t border-slate-200">
                        <h5 class="text-sm font-bold text-slate-700 mb-2">대체 운동:</h5>
                        <ul class="list-disc list-inside text-sm text-slate-600 space-y-1">
                            ${currentExercise.alternatives.map(alt => `<li>${alt}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="flex-grow">
                             <div class="flex items-center gap-3">
                                <span class="text-xs sm:text-sm font-bold uppercase py-1 px-3 rounded-full whitespace-nowrap ${
                                    currentExercise.type.includes('웜업') || currentExercise.type.includes('선피로') ? 'bg-amber-100 text-amber-800' :
                                    isMain ? 'bg-blue-100 text-blue-800' : 'bg-slate-100 text-slate-800'
                                }">${currentExercise.type}</span>
                                <h4 class="text-lg sm:text-xl font-bold text-slate-900">${currentExercise.name}</h4>
                            </div>
                        </div>
                    </div>
                    <p class="text-slate-600 text-sm sm:text-base">${tipHTML}</p>
                    <div class="flex justify-between items-center mt-3">
                        <p class="text-sm sm:text-base font-semibold text-slate-500">훈련 방식: ${methodText}</p>
                        <button class="show-record-popup-btn flex-shrink-0 p-2 text-slate-400 hover:text-blue-600 transition" 
                               data-sanitized-name="${sanitizedName}" 
                               data-exercise-name="${currentExercise.name}"
                               title="${currentExercise.name} 기록 보기">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-bar-chart-line-fill" viewBox="0 0 16 16">
                                 <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2z"/>
                             </svg>
                         </button>
                    </div>
                     ${alternativesHTML}
                </div>
                <div id="sets-container-${sanitizedName}" class="space-y-3 mt-4"></div>
                <button type="button" class="add-set-btn mt-4 w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg transition shadow-md">+ 세트 추가</button>
            `;
            workoutList.appendChild(card);
            
            const setsContainer = card.querySelector(`#sets-container-${sanitizedName}`);
            const dataToRender = recordForSession?.sets || [];
            if (dataToRender.length > 0) {
                dataToRender.forEach((set, index) => addSetRow(setsContainer, currentExercise, index + 1, set));
            } else {
                addSetRow(setsContainer, currentExercise, 1);
            }
            
            card.querySelector('.add-set-btn').addEventListener('click', () => {
                const currentSetCount = setsContainer.querySelectorAll('.set-row').length;
                addSetRow(setsContainer, currentExercise, currentSetCount + 1);
            });
        });
        
        document.querySelectorAll('.show-record-popup-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetBtn = e.currentTarget;
                const sanitizedName = targetBtn.dataset.sanitizedName;
                const exerciseName = targetBtn.dataset.exerciseName;
                openRecordPopup(sanitizedName, exerciseName);
            });
        });
    }

    function addSetRow(container, exercise, setNumber, setData = {weight: '', reps: ''}) {
        const setRow = document.createElement('div');
        setRow.className = 'set-row flex items-center gap-3';
        setRow.innerHTML = `
            <span class="font-semibold text-slate-500 w-12 text-right">세트 ${setNumber}</span>
            <input type="number" step="0.1" data-type="weight" value="${setData.weight}" placeholder="중량" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-lg">
            <span class="font-semibold text-slate-400">kg</span>
            <input type="number" data-type="reps" value="${setData.reps}" placeholder="횟수" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-lg">
            <span class="font-semibold text-slate-400">회</span>
            <button type="button" class="delete-set-btn p-2 text-slate-400 hover:text-red-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
            </button>
        `;
        container.appendChild(setRow);

        const weightInput = setRow.querySelector('input[data-type="weight"]');
        const repsInput = setRow.querySelector('input[data-type="reps"]');
        const saveDebounced = debounce(() => saveAllSets(exercise), 500);
        weightInput.addEventListener('input', saveDebounced);
        repsInput.addEventListener('input', saveDebounced);

        setRow.querySelector('.delete-set-btn').addEventListener('click', () => {
            setRow.remove();
            container.querySelectorAll('.set-row').forEach((row, index) => {
                row.querySelector('span:first-child').textContent = `세트 ${index + 1}`;
            });
            saveAllSets(exercise);
        });
    }
    
    // UI NAVIGATION & STATE
    function updateActiveButtons() {
        document.querySelectorAll('#week-selector button').forEach(btn => {
            btn.classList.toggle('week-btn-active', parseInt(btn.dataset.week) === currentWeek);
            btn.classList.toggle('bg-slate-100', parseInt(btn.dataset.week) !== currentWeek);
        });
        document.querySelectorAll('#day-selector button').forEach(btn => {
            btn.classList.toggle('day-btn-active', btn.dataset.day === currentDay);
             btn.classList.toggle('bg-slate-100', btn.dataset.day !== currentDay);
        });
    }
    
    function showView(viewName) {
        document.getElementById('view-today').classList.toggle('hidden', viewName !== 'today');
        document.getElementById('view-plan').classList.toggle('hidden', viewName !== 'plan');
        document.getElementById('view-records').classList.toggle('hidden', viewName !== 'records');
        
        document.getElementById('tab-today').classList.toggle('tab-active', viewName === 'today');
        document.getElementById('tab-plan').classList.toggle('tab-active', viewName === 'plan');
        document.getElementById('tab-records').classList.toggle('tab-active', viewName === 'records');
        
        ['today', 'plan', 'records'].forEach(tab => {
            document.getElementById(`tab-${tab}`).classList.toggle('text-slate-500', viewName !== tab);
        });

        if (viewName === 'records') {
            populateExerciseSelector();
            renderRecords();
        } else if (viewName === 'plan') {
            createPlanTable();
        }
    }

    function createPlanTable() {
        planTableBody.innerHTML = '';
        const cycleInfo = JSON.parse(localStorage.getItem('workoutCycleInfo')) || { cycleId: 1 };

        for (let i = 1; i <= 13; i++) {
            const { phase, method, originalWeekData, type } = getWeekInfo(i, cycleInfo.cycleId);
            const pullName = originalWeekData.pull?.name || `${type} 디로딩`;
            const pushName = originalWeekData.push?.name || `${type} 디로딩`;
            const legName = originalWeekData.leg?.name || `${type} 디로딩`;
            
            const tr = document.createElement('tr');
            tr.className = 'border-b border-slate-200 hover:bg-slate-50';
            tr.innerHTML = `
                <td class="p-4 font-bold text-center">${i}</td>
                <td class="p-4">${pullName}</td>
                <td class="p-4">${pushName}</td>
                <td class="p-4">${legName}</td>
                <td class="p-4"><span class="px-3 py-1 text-sm font-semibold rounded-full ${phaseColors[phase]}">${method}</span></td>
            `;
            planTableBody.appendChild(tr);
        }
    }
    
    // RECORDS VIEW LOGIC
    function populateExerciseSelector() {
        const exerciseGroupMap = new Map();
        Object.values(workoutPlan).forEach(weekData => {
            ['pull', 'leg', 'push'].forEach(day => {
                if (weekData[day]?.routine) {
                    weekData[day].routine.forEach(ex => {
                        const baseName = ex.name;
                        const sanitizedId = getSanitizedName(ex);
                        if (!exerciseGroupMap.has(baseName)) {
                            exerciseGroupMap.set(baseName, { name: baseName, ids: new Set() });
                        }
                        exerciseGroupMap.get(baseName).ids.add(sanitizedId);

                        if (baseName === '사이드 래터럴 레이즈 머신') {
                            const variation1 = getSanitizedName({name: '뉴텍 스탠딩 사이드 레터럴 레이즈', type: ex.type});
                            const variation2 = getSanitizedName({name: '케이블 X-레이즈', type: ex.type});
                            exerciseGroupMap.get(baseName).name = '사이드 래터럴 레이즈 (종합)';
                            exerciseGroupMap.get(baseName).ids.add(variation1).add(variation2);
                        }
                    });
                }
            });
        });

        const currentSelected = exerciseSelector.value;
        exerciseSelector.innerHTML = '<option value="">-- 운동 선택 --</option>';
        Array.from(exerciseGroupMap.values())
            .sort((a, b) => a.name.localeCompare(b.name))
            .forEach(group => {
                const option = document.createElement('option');
                option.value = Array.from(group.ids).join(',');
                option.textContent = group.name;
                exerciseSelector.appendChild(option);
            });
        if(currentSelected) exerciseSelector.value = currentSelected;
    }

    function renderRecords() {
        const selectedIdsString = exerciseSelector.value;
        const hasRecords = Object.keys(JSON.parse(localStorage.getItem('workoutRecords') || '{}')).length > 0;

        if (!hasRecords || !selectedIdsString) {
            recordsContent.classList.add('hidden');
            noRecordsDiv.classList.remove('hidden');
            if (chartInstance) chartInstance.destroy();
            return;
        }

        const selectedIds = selectedIdsString.split(',');
        const allRecords = JSON.parse(localStorage.getItem('workoutRecords'));
        const combinedData = selectedIds.flatMap(id => allRecords[id] || []);
        
        if (combinedData.length === 0) {
            recordsContent.classList.add('hidden');
            noRecordsDiv.classList.remove('hidden');
            noRecordsDiv.innerHTML = `<p class="text-slate-500 text-lg">아직 이 운동에 대한 기록이 없습니다.</p><p class="text-slate-500 mt-2">'오늘의 운동' 탭에서 운동을 기록해주세요.</p>`;
            if (chartInstance) chartInstance.destroy();
            return;
        }

        recordsContent.classList.remove('hidden');
        noRecordsDiv.classList.add('hidden');

        const exerciseData = combinedData.sort((a, b) => {
            if ((a.cycleId || 1) !== (b.cycleId || 1)) return (a.cycleId || 1) - (b.cycleId || 1);
            return a.week - b.week;
        });
        
        const originalName = Array.from(exerciseSelector.options).find(opt => opt.value === selectedIdsString).textContent;
        chartTitle.textContent = `${originalName} 중량 변화 추이 (Top Set 기준)`;
        renderProgressChart(exerciseData, 'progressChart');
        renderRecordsTable(exerciseData, 'records-table-container');
    }
    
    // [REFACTORED in v6.0]
    function renderProgressChart(data, canvasId) {
        const chartCanvas = document.getElementById(canvasId);
        if (!chartCanvas) return;
        const ctx = chartCanvas.getContext('2d');
        const labels = data.map(d => `C${d.cycleId || 1}-W${d.week}`);
        const topWeights = data.map(d => Math.max(0, ...(d.sets?.map(s => s.weight) || [])));

        let targetChartInstance = null;
        if (canvasId === 'progressChart') {
            if (chartInstance) chartInstance.destroy();
            targetChartInstance = chartInstance;
        } else if (canvasId === 'record-popup-chart') {
            if (popupChartInstance) popupChartInstance.destroy();
            targetChartInstance = popupChartInstance;
        }

        const newChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{
                label: '최고 중량(kg)', data: topWeights, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true, tension: 0.1, pointBackgroundColor: '#3b82f6', pointRadius: 5, pointHoverRadius: 7,
            }]},
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: '중량 (kg)' }},
                    x: { title: { display: true, text: '사이클-주차' }}
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: {
                        title: (c) => { const d = data[c[0].dataIndex]; return `${d.date} (사이클 ${d.cycleId || 1}, ${d.week}주차)`; },
                        label: (c) => `최고 중량: ${c.parsed.y}kg`,
                        afterLabel: (c) => {
                            const d = data[c[0].dataIndex];
                            if (!d.sets?.length) return '';
                            const topSet = d.sets.reduce((max, set) => set.weight > max.weight ? set : max, {weight: 0});
                            return `${topSet.reps}회 (Top Set)`;
                        }
                    }}
                }
            }
        });

        if (canvasId === 'progressChart') {
            chartInstance = newChart;
        } else {
            popupChartInstance = newChart;
        }
    }

    // [REFACTORED in v6.0]
    function renderRecordsTable(data, containerId) {
        const tableContainer = document.getElementById(containerId);
        if(!tableContainer) return;
        tableContainer.innerHTML = '';
        data.slice().reverse().forEach(record => {
            const dayTable = document.createElement('table');
            dayTable.className = 'w-full text-left border-collapse mb-4';
            const dayNameMap = {'pull': '풀', 'leg':'하체', 'push':'푸쉬'};
            const cycleText = record.cycleId ? ` (사이클 ${record.cycleId})` : ` (사이클 1)`;
            dayTable.innerHTML = `
                <thead class="bg-slate-100">
                    <tr><th colspan="3" class="p-3 font-semibold text-slate-800">${record.date} (${record.week}주차, ${dayNameMap[record.day] || record.day})${cycleText}</th></tr>
                    <tr class="text-sm">
                        <th class="p-3 font-semibold text-slate-600 w-1/3">세트</th><th class="p-3 font-semibold text-slate-600 w-1/3">중량(kg)</th><th class="p-3 font-semibold text-slate-600 w-1/3">횟수(Reps)</th>
                    </tr>
                </thead>
                <tbody class="text-slate-700">
                    ${record.sets?.map((set, index) => `
                        <tr class="border-b border-slate-200 last:border-b-0">
                            <td class="p-3">${index + 1}</td><td class="p-3 font-semibold text-slate-900">${set.weight}kg</td><td class="p-3">${set.reps}회</td>
                        </tr>`).join('') || ''}
                </tbody>`;
            tableContainer.appendChild(dayTable);
        });
    }
    
    // APP INITIALIZATION & EVENT LISTENERS
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function confirmAndResetAll() {
        localStorage.clear();
        resetAllModal.classList.add('hidden');
        initializeApp(true); 
    }

    function confirmAndStartNewCycle() {
        let cycleInfo = JSON.parse(localStorage.getItem('workoutCycleInfo')) || { cycleId: 1 };
        cycleInfo.cycleId++;
        localStorage.setItem('workoutCycleInfo', JSON.stringify(cycleInfo));
        newCycleModal.classList.add('hidden');
        
        localStorage.setItem('workoutAppState', JSON.stringify({ week: 1, day: 'pull' }));
        initializeApp(true);
    }
    
    function migrateOldRecords() {
        if (localStorage.getItem('migrationV5_2_Complete')) return; // Renamed for clarity
        let records = JSON.parse(localStorage.getItem('workoutRecords')) || {};
        let needsUpdate = false;
        for (const key in records) {
            records[key].forEach(r => {
                if (!r.phase) {
                    const cycleId = r.cycleId || 1;
                    const { phase } = getWeekInfo(r.week, cycleId);
                    r.phase = phase;
                    needsUpdate = true;
                }
            });
        }
        if (needsUpdate) {
            localStorage.setItem('workoutRecords', JSON.stringify(records));
        }
        localStorage.setItem('migrationV5_2_Complete', 'true');
    }

    function handleExportData() {
        const workoutRecords = JSON.parse(localStorage.getItem('workoutRecords')) || {};
        const cycleInfo = JSON.parse(localStorage.getItem('workoutCycleInfo')) || { cycleId: 1 };

        const archiveData = {
            programVersion: "v6.1 Final",
            exportDate: new Date().toISOString().split('T')[0],
            cycleInfo,
            workoutRecords
        };

        const fullArchiveText = CONTEXT_PROMPT + JSON.stringify(archiveData, null, 2);
        exportDataTextarea.value = fullArchiveText;
        exportModal.classList.remove('hidden');
    }

    function initializeApp(isReset = false) {
        migrateOldRecords();
        let cycleInfo = JSON.parse(localStorage.getItem('workoutCycleInfo')) || { cycleId: 1 };
        currentCycleId = cycleInfo.cycleId;

        if (isReset) {
            currentWeek = 1;
            currentDay = 'pull';
            localStorage.setItem('workoutAppState', JSON.stringify({ week: currentWeek, day: currentDay }));
        } else {
            let savedState = JSON.parse(localStorage.getItem('workoutAppState'));
            currentWeek = savedState?.week || 1;
            currentDay = savedState?.day || 'pull';
        }
        
        if (weekSelector.childElementCount === 0) {
            for (let i = 1; i <= 13; i++) {
                const weekBtn = document.createElement('button');
                weekBtn.dataset.week = i;
                weekBtn.textContent = `${i}주차`;
                weekBtn.className = 'px-3.5 py-2.5 text-base font-semibold rounded-lg transition duration-200 bg-slate-100 hover:bg-slate-200 shadow-md';
                weekSelector.appendChild(weekBtn);
            }
        }
        
        weekSelector.onclick = e => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.week) {
                currentWeek = parseInt(e.target.dataset.week);
                localStorage.setItem('workoutAppState', JSON.stringify({ week: currentWeek, day: currentDay }));
                renderWorkout();
                updateActiveButtons();
            }
        };

        daySelector.onclick = e => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.day) {
                currentDay = e.target.dataset.day;
                localStorage.setItem('workoutAppState', JSON.stringify({ week: currentWeek, day: currentDay }));
                renderWorkout();
                updateActiveButtons();
            }
        };
        
        exerciseSelector.onchange = renderRecords;
        resetAllButton.onclick = () => resetAllModal.classList.remove('hidden');
        cancelResetAll.onclick = () => resetAllModal.classList.add('hidden');
        confirmResetAll.onclick = confirmAndResetAll;
        newCycleButton.onclick = () => newCycleModal.classList.remove('hidden');
        cancelNewCycle.onclick = () => newCycleModal.classList.add('hidden');
        confirmNewCycle.onclick = confirmAndStartNewCycle;

        exportDataButton.onclick = handleExportData;
        closeExportModalButton.onclick = () => exportModal.classList.add('hidden');
        copyExportDataButton.onclick = () => {
            exportDataTextarea.select();
            document.execCommand('copy');
            copyExportDataButton.textContent = "복사 완료!";
            setTimeout(() => {
                copyExportDataButton.textContent = "전체 복사";
            }, 2000);
        };

        closeRecordPopupButton.onclick = () => recordPopupModal.classList.add('hidden');

        renderWorkout();
        updateActiveButtons();
        showView('today');
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });

</script>
</body>
</html>


