<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26주 장기 성장 프로그램 | 인터랙티브 플래너 (v2.2.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .week-btn-active { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .day-btn-active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card-enter, .modal-enter { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flash { 
            0%, 100% { background-color: transparent; } 
            50% { background-color: #dcfce7; }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 640px) { .chart-container { height: 40vh; } }
        .prose { max-width: none; }
/* ▼▼▼ 타이머 배너 스타일 추가 ▼▼▼ */
        #timer-banner.show {
            transform: translateY(0);
        }
        /* ▲▲▲ /타이머 배너 스타일 추가 ▲▲▲ */
    </style>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app-wrapper">
        <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
            <header class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">26주 장기 성장 프로그램</h1>
                <p class="text-slate-600 mt-3 text-base sm:text-lg">당신만을 위해 설계된 궁극의 인터랙티브 운동 플래너</p>
            </header>

            <nav id="main-tabs" class="flex justify-center mb-10 border-b border-slate-300 flex-wrap">
                <button data-view="today" class="py-3 px-2 text-sm sm:px-6 sm:text-base font-semibold border-b-2 tab-active shadow-sm">오늘의 운동</button>
                <button data-view="plan" class="py-3 px-2 text-sm sm:px-6 sm:text-base font-semibold border-b-2 border-transparent text-slate-500 hover:text-blue-600 transition shadow-sm">전체 계획서</button>
                <button data-view="records" class="py-3 px-2 text-sm sm:px-6 sm:text-base font-semibold border-b-2 border-transparent text-slate-500 hover:text-blue-600 transition shadow-sm">운동 기록</button>
                <button data-view="bodycomp" class="py-3 px-2 text-sm sm:px-6 sm:text-base font-semibold border-b-2 border-transparent text-slate-500 hover:text-blue-600 transition shadow-sm">신체 변화</button>
            </nav>

            <main id="main-content">
                <div id="view-today">
                    <section id="controls" class="mb-8 p-4 sm:p-6 bg-white rounded-xl shadow-lg">
                        <div class="mb-6">
                            <h3 class="font-bold text-lg sm:text-xl mb-4 text-slate-800">1. 주차 선택 (Week)</h3>
                            <div id="week-selector" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg sm:text-xl mb-4 text-slate-800">2. 요일 선택 (Day)</h3>
                            <div id="day-selector" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <button data-day="pull" class="p-3 sm:p-4 rounded-lg font-bold text-base sm:text-lg bg-slate-100 text-slate-700 transition duration-200 hover:bg-slate-200 shadow-md">PULL (당기기)</button>
                                <button data-day="push" class="p-3 sm:p-4 rounded-lg font-bold text-base sm:text-lg bg-slate-100 text-slate-700 transition duration-200 hover:bg-slate-200 shadow-md">PUSH (밀기)</button>
                                <button data-day="leg" class="p-3 sm:p-4 rounded-lg font-bold text-base sm:text-lg bg-slate-100 text-slate-700 transition duration-200 hover:bg-slate-200 shadow-md">LEG (하체)</button>
                            </div>
                        </div>
                    </section>
                    <section id="workout-display">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
                            <h2 id="workout-title" class="text-2xl sm:text-3xl font-bold text-slate-900"></h2>
                            <div class="flex items-center gap-3 bg-slate-200 rounded-full p-1 self-start sm:self-center">
                                <button id="prev-cycle-btn" class="p-2 rounded-full hover:bg-slate-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                                    </svg>
                                </button>
                                <span id="cycle-info-badge" class="text-base font-bold text-slate-700 self-center whitespace-nowrap px-2"></span>
                                <button id="next-cycle-btn" class="p-2 rounded-full hover:bg-slate-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center mb-4 gap-3">
                            <span id="workout-phase-badge" class="px-3 py-1 sm:px-4 sm:py-1.5 text-sm sm:text-base font-semibold rounded-full self-start"></span>
                        </div>
                        <p id="workout-phase-description" class="p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-900 rounded-r-lg mb-8 shadow-sm"></p>
                        <div class="flex items-center justify-center gap-2 text-xs sm:text-sm text-slate-500 mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.206.552.38.062.172.038.397-.04.603-.078.206-.214.394-.383.494-.17.1-.42.15-.66.15-.24.004-.495-.05-.702-.145-.206-.094-.374-.241-.478-.421l-.127-.223-.317.416.127.223c.146.256.358.463.608.583.25.12.532.193.83.232.297.04.61.023.908-.06l.322-.09.303.226c.143.106.323.19.52.247.198.058.42.066.635.034.214-.032.422-.1.616-.208.195-.108.36-.26.486-.444.126-.184.22-.412.27-.66.05-.247.053-.516.01-.78-.043-.263-.153-.521-.33-.742-.176-.22-.422-.405-.71-.524-.287-.12-.62-.19-.97-.24l-.322-.047-.226-.303c-.11-.147-.25-.27-.41-.355-.16-.084-.34-.125-.53-.125-.19.002-.38.044-.56.125-.18.08-.34.2-.47.355l-.127.173.317-.417.127-.173c.147-.197.355-.365.594-.465.24-.1.49-.13.73-.1.24.03.48.1.7.223.22.123.4.295.52.502zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                            <span>기록은 자동으로 저장됩니다. 별도의 저장 버튼이 없습니다.</span>
                        </div>
                        <div id="workout-list" class="space-y-5"></div>
                    </section>
                </div>

                <div id="view-plan" class="hidden">
                     <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                          <h2 class="text-2xl font-bold text-slate-900 mb-4">훈련 주기 설명</h2>
                          <div class="space-y-6 text-slate-700">
                               <div>
                                   <h3 class="font-bold text-xl text-red-700">강화 주기 (고강도 훈련)</h3>
                                   <p class="mt-1">실패 지점까지 수행하는 단 한 번의 **'탑 세트'**를 통해 근육에 최대 강도의 자극을 주는 시기입니다. 목표는 '지난번보다 단 1kg, 단 1회라도 더' 입니다.</p>
                               </div>
                               <div>
                                   <h3 class="font-bold text-xl text-green-700">축적 주기 (볼륨 훈련)</h3>
                                   <p class="mt-1">근육의 크기(근비대)를 키우기 위해 충분한 운동량(Volume)을 쌓는 시기입니다. 강화 주기 성과를 바탕으로 자동 계산된 무게로 **'워킹 세트'** (8~12회 x 3~4세트)를 수행합니다.</p>
                               </div>
                               <div>
                                   <h3 class="font-bold text-xl text-sky-700">디로딩 주간 (전략적 회복)</h3>
                                   <p class="mt-1">'능동적 회복'을 통해 그동안 쌓인 중추신경계와 관절의 피로를 완전히 해소하고 다음 12주를 준비하는 시기입니다. 평소 워킹 세트 중량의 50%~60%, 세트 수의 절반만 가볍게 수행합니다.</p>
                               </div>
                          </div>
                          <div class="mt-10 pt-8 border-t border-slate-200">
                            <h2 class="text-2xl font-bold text-slate-900 mb-4">핵심 훈련 방식 상세</h2>
                            <div class="space-y-8 text-slate-700 prose">
                                <div>
                                    <h4 class="font-bold text-xl text-red-700">🚀 탑 세트 / 백오프 세트 (Top Set / Back-off Set)</h4>
                                    <p class="mt-2">
                                        <strong>'강화 주기'</strong>에 사용하는 방식으로, H.I.T.(고강도 훈련) 철학에 따라 실패 지점까지의 단 한 세트를 통해 최대의 근성장 자극을 이끌어내는 것을 목표로 합니다.
                                    </p>
                                    <div class="mt-3">
                                        <p class="font-semibold">수행 방법:</p>
                                        <ol class="list-decimal list-inside space-y-3 mt-2">
                                            <li>
                                                <strong>준비 세트 (Feeder Sets):</strong>
                                                <p class="pl-5 text-slate-600">본 운동(탑 세트)에 들어가기 전, <strong>2~3세트에 걸쳐 무게를 점차 증량</strong>하며 관절과 신경계를 예열합니다. 탑 세트의 무게에 가까워질수록 <strong>반복 횟수는 3~5회 정도로 낮게 유지</strong>하여, 불필요한 피로 없이 신경계를 활성화하는 데에만 집중하세요. 이 세트들은 절대 실패지점까지 수행하지 않습니다.</p>
                                            </li>
                                            <li>
                                                <strong>탑 세트 (Top Set):</strong>
                                                <p class="pl-5 text-slate-600"><strong>오늘의 단 한 번뿐인 가장 중요한 세트</strong>입니다. 앱이 제시하는 <strong>'🔥 강화 목표'</strong> 중량으로 **실패 지점(Failure)까지 가능한 최대 횟수(AMRAP)**에 도전합니다. <strong>완벽한 자세</strong>와 <strong>템포</strong>를 유지하는 선에서, 더 이상 단 1회도 반복할 수 없을 때까지 수행하는 것이 핵심입니다. 수행이 끝나면, **실제 성공한 횟수**를 정확히 기록해 주세요. 이 기록이 다음 훈련의 무게를 결정하는 가장 중요한 데이터가 됩니다.</p>
                                            </li>
                                            <li>
                                                <strong>백오프 세트 (Back-off Set):</strong>
                                                <p class="pl-5 text-slate-600">탑 세트가 끝나면, 중량을 <strong>약 20%</strong> 낮춥니다. 앱이 자동으로 계산해준 무게로 **8~10회** 반복 가능한 세트를 1~2회 추가 수행하여, 근성장에 필요한 추가적인 볼륨(운동량)과 펌핑감을 확보하며 마무리합니다.</p>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-xl text-green-700">💪 워킹 세트 (Working Sets)</h4>
                                    <p class="mt-2">
                                        <strong>'축적 주기'</strong>에 사용하는 방식으로, 근육의 크기(근비대)를 키우기 위해 충분한 운동량(볼륨)을 쌓는 데 집중하는 가장 전통적인 보디빌딩 훈련법입니다.
                                    </p>
                                    <div class="mt-3">
                                        <p class="font-semibold">수행 방법:</p>
                                        <ol class="list-decimal list-inside space-y-3 mt-2">
                                            <li>
                                                <strong>목표 중량 설정:</strong>
                                                <p class="pl-5 text-slate-600">앱이 이전 '강화 주기'의 성과를 바탕으로 계산해준 <strong>'🔥 축적 목표'</strong> 중량을 확인합니다. 이 무게가 오늘 수행할 모든 세트의 기준 중량이 됩니다.</p>
                                            </li>
                                            <li>
                                                <strong>세트 반복 수행:</strong>
                                                <p class="pl-5 text-slate-600">설정된 '워킹 세트' 중량으로 <strong>목표 횟수 범위(주로 8~12회)를 3~4세트 반복</strong>합니다. <strong>핵심은 모든 세트에서 동일한 중량으로 목표 횟수를 채우는 것</strong>입니다. 첫 세트부터 실패지점까지 수행하는 것이 아니라, 마지막 세트에 이르렀을 때 실패에 가까워지도록 페이스를 조절해야 합니다. 만약 첫 세트부터 12회 이상이 너무 쉽게 느껴진다면, 다음 훈련을 위해 더 높은 중량을 기록해두는 것이 좋습니다.</p>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                          <h2 class="text-2xl font-bold text-slate-900 mt-10 mb-4">현재 사이클 계획표 요약</h2>
                          <div id="plan-table-container" class="overflow-x-auto"></div>
                     </div>
                </div>
                <div id="view-records" class="hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">진행 상황 대시보드</h2>
                        <p class="text-slate-600 mb-8 text-base sm:text-lg">과거 기록을 바탕으로 훈련 성과와 신체 균형을 분석합니다.</p>
                        
                        <div id="movement-pattern-analysis" class="mb-10">
                            <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 text-center">움직임 패턴 분석</h3>
                            <div class="chart-container mb-6">
                                <canvas id="movementPatternChart"></canvas>
                            </div>
                            <div id="ai-feedback" class="p-4 bg-gray-100 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-robot" viewBox="0 0 16 16"><path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.932a.25.25 0 0 0-.192-.41l-1.004.232c-.596-.57-1.23-.926-1.92-1.107a.25.25 0 0 0-.217-.068Z"/><path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1ZM2.5 7.542c.157-.884 1.12-1.64 2.572-1.789a25.614 25.614 0 0 1 5.856 0c1.452.149 2.415.905 2.572 1.79v1.645a1.933 1.933 0 0 1-1.57.98c-1.043.183-2.658.372-4.43.372s-3.387-.189-4.43-.372A1.933 1.933 0 0 1 2.5 9.187V7.542Z"/></svg>
                                    AI 코치 피드백
                                </h4>
                                <p id="ai-feedback-text" class="text-gray-700 text-sm sm:text-base"></p>
                            </div>
                        </div>

                        <div class="mb-8 pt-8 border-t border-slate-200">
                            <label for="exercise-selector" class="block text-base font-medium text-slate-800 mb-2">운동별 상세 기록 분석:</label>
                            <select id="exercise-selector" class="w-full max-w-md p-2.5 sm:p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-md">
                            </select>
                        </div>

                        <div id="records-content" class="hidden">
                            <h3 id="chart-title" class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 text-center"></h3>
                            <div class="chart-container mb-10">
                                <canvas id="progressChart"></canvas>
                            </div>
                           
                            <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 mt-10 pt-8 border-t border-slate-200">상세 기록</h3>
                            <div id="records-table-container" class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm"></div>
                        </div>
                        <div id="no-records" class="text-center py-16"></div>
                        <div class="mt-10 pt-8 border-t border-slate-200 space-y-4">
                            <h3 class="text-xl font-bold text-slate-800">데이터 및 설정 관리</h3>
<!-- ▼▼▼ 주간 공유/내보내기 바 (데이터 및 설정 관리 바로 아래) ▼▼▼ -->
<div id="weekly-share-bar" class="space-y-3">
  <button id="weekly-share-summary"
          class="w-full bg-blue-100 text-blue-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-blue-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
    <!-- share icon -->
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-share" viewBox="0 0 16 16">
      <path d="M13.5 1a1.5 1.5 0 1 0 .001 3.001A1.5 1.5 0 0 0 13.5 1zM4.5 6a1.5 1.5 0 1 0 .001 3.001A1.5 1.5 0 0 0 4.5 6zm9 6a1.5 1.5 0 1 0 .001 3.001A1.5 1.5 0 0 0 13.5 12z"/>
      <path d="M13.5 3.5a.5.5 0 0 1-.276-.084l-7-4.5a.5.5 0 1 1 .552-.832l7 4.5A.5.5 0 0 1 13.5 3.5ZM4.5 7.5a.5.5 0 0 1-.276-.084l-3-2a.5.5 0 1 1 .552-.832l3 2A.5.5 0 0 1 4.5 7.5Zm9 6a.5.5 0 0 1-.276-.084l-7-4.5a.5.5 0 1 1 .552-.832l7 4.5a.5.5 0 0 1-.276.916Z"/>
    </svg>
    주간 요약 복사/공유
  </button>

  <button id="weekly-export-csv"
          class="w-full bg-green-100 text-green-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-green-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
    <!-- archive icon -->
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-archive" viewBox="0 0 16 16">
      <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5A2.5 2.5 0 0 1 12.5 15h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
    </svg>
    주간 기록 내보내기 (CSV)
  </button>

  <button id="weekly-instagram-png"
          class="w-full bg-purple-100 text-purple-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-purple-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
    <!-- image icon -->
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
      <path d="M4.502 5.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
      <path d="M14.002 3a1 1 0 0 1 1 1v8.002a1 1 0 0 1-1 1h-12a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h12Zm-12-1A2 2 0 0 0 .002 4v8.002a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-12Z"/>
      <path d="M10.648 6.646a.5.5 0 0 1 .704.02l3.148 3.35V12h-12v-1.146l2.852-2.984a.5.5 0 0 1 .704-.02l1.601 1.523 3.0-2.718Z"/>
    </svg>
    인스타 카드 만들기 (PNG)
  </button>
</div>
<!-- ▲▲▲ /주간 공유/내보내기 바 ▲▲▲ -->
                            <button id="new-cycle-button" class="w-full bg-blue-100 text-blue-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-blue-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                  <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"></path>
                                  <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 11.817 1.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"></path>
                                </svg>
                                새로운 13주 사이클 시작 (기록 유지)
                            </button>
                            <button id="export-data-button" class="w-full bg-green-100 text-green-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-green-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-archive" viewBox="0 0 16 16">
                                    <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                                내 훈련 기록 내보내기 (Export)
                            </button>
                            <button id="import-data-button" class="w-full bg-purple-100 text-purple-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-purple-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                </svg>
                                훈련 기록 불러오기 (Import)
                            </button>
                            <button id="reset-all-button" class="w-full bg-red-100 text-red-700 font-bold p-3 sm:p-4 rounded-lg hover:bg-red-200 transition duration-200 flex items-center justify-center gap-2 text-base sm:text-lg shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path></svg>
                                모든 기록 삭제 및 초기화
                            </button>
                        </div>
                    </div>
                </div>
                <div id="view-bodycomp" class="hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">신체 변화 추적</h2>
                        <p class="text-slate-600 mb-8 text-base sm:text-lg">인바디 기록을 입력하고 신체 구성의 변화를 추적하세요.</p>
                        
                        <form id="inbody-form" class="mb-10 p-6 bg-slate-50 rounded-lg border border-slate-200 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div>
                                <label for="inbody-date" class="block text-sm font-medium text-slate-700 mb-1">측정일</label>
                                <input type="date" id="inbody-date" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="inbody-weight" class="block text-sm font-medium text-slate-700 mb-1">체중 (kg)</label>
                                <input type="number" step="0.1" id="inbody-weight" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="예: 85.5">
                            </div>
                            <div>
                                <label for="inbody-smm" class="block text-sm font-medium text-slate-700 mb-1">골격근량 (kg)</label>
                                <input type="number" step="0.1" id="inbody-smm" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="예: 40.2">
                            </div>
                            <div>
                                <label for="inbody-fat" class="block text-sm font-medium text-slate-700 mb-1">체지방률 (%)</label>
                                <input type="number" step="0.1" id="inbody-fat" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="예: 15.3">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold p-2.5 rounded-lg hover:bg-blue-700 transition md:col-span-1">기록 추가</button>
                        </form>

                        <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 text-center">신체 구성 변화 추이</h3>
                        <div class="chart-container mb-10">
                            <canvas id="inbodyChart"></canvas>
                        </div>
                        
                        <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4 mt-10 pt-8 border-t border-slate-200">상세 기록</h3>
                        <div id="inbody-table-container" class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm"></div>
                    </div>
                </div>
            </main>
        </div>

        <div id="modal-container">
            <!-- Universal confirmation modal -->
            <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4 modal-enter">
                <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-md w-full">
                    <h3 id="confirm-modal-title" class="text-xl sm:text-2xl font-bold mb-4 text-slate-900"></h3>
                    <p id="confirm-modal-message" class="text-slate-600 mb-8 text-sm sm:text-base"></p>
                    <div class="flex justify-end gap-3">
                        <button data-action="close-modal" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition shadow-md">취소</button>
                        <button id="confirm-modal-action-btn" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg text-white font-bold transition shadow-md">확인</button>
                    </div>
                </div>
            </div>
            
            <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 modal-enter">
                <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-2xl w-full flex flex-col" style="height: 90vh;">
                    <div class="flex-shrink-0">
                        <h3 class="text-xl sm:text-2xl font-bold mb-2 text-slate-900">프로젝트 아카이브 내보내기</h3>
                        <p class="text-slate-600 mb-4 text-sm sm:text-base">아래 내용을 복사하거나 파일로 저장하여 데이터를 안전하게 백업하세요.</p>
                    </div>
                    <textarea id="export-data-textarea" readonly class="w-full flex-grow p-4 border border-slate-300 rounded-lg bg-slate-50 text-sm font-mono resize-none"></textarea>
                    <div class="flex justify-end gap-3 mt-4 flex-shrink-0">
                        <button id="save-export-data-button" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 transition shadow-md">파일로 저장 (.json)</button>
                        <button id="copy-export-data-button" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-md">전체 복사</button>
                        <button data-action="close-modal" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition shadow-md">닫기</button>
                    </div>
                </div>
            </div>

            <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 modal-enter">
                <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-2xl w-full flex flex-col" style="height: 90vh;">
                    <div class="flex-shrink-0">
                        <h3 class="text-xl sm:text-2xl font-bold mb-2 text-slate-900">훈련 기록 불러오기</h3>
                        <p class="text-slate-600 mb-4 text-sm sm:text-base">백업한 JSON 파일을 선택하거나, 파일 내용을 아래에 직접 붙여넣으세요. <strong class="text-red-600">주의: 현재 모든 기록을 덮어씁니다.</strong></p>
                        <input type="file" id="import-file-input" accept=".json,text/plain" class="mb-4 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                    </div>
                    <textarea id="import-data-textarea" class="w-full flex-grow p-4 border border-slate-300 rounded-lg bg-slate-50 text-sm font-mono resize-none" placeholder="여기에 JSON 데이터를 붙여넣으세요..."></textarea>
                    <div id="import-feedback" class="text-sm mt-3 h-5"></div>
                    <div class="flex justify-end gap-3 mt-4 flex-shrink-0">
                        <button data-action="close-modal" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition shadow-md">취소</button>
                        <button id="confirm-import-button" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-purple-600 text-white font-bold hover:bg-purple-700 transition shadow-md">불러오기</button>
                    </div>
                </div>
            </div>

            <!-- Timer Modal -->
            <div id="timer-banner" class="fixed bottom-0 left-0 right-0 bg-slate-800 text-white p-4 shadow-lg transform translate-y-full transition-transform duration-500 ease-in-out z-40 hidden">
    <div class="container mx-auto max-w-7xl flex items-center justify-between gap-4">
        <div class="flex-grow">
            <p id="banner-timer-exercise-name" class="font-bold text-base sm:text-lg truncate"></p>
            <p class="text-sm text-slate-300">휴식 시간</p>
        </div>
        <div id="banner-timer-display" class="font-mono font-bold text-4xl sm:text-5xl" style="font-variant-numeric: tabular-nums;">00:00</div>
        <button id="banner-skip-timer-btn" class="bg-slate-600 hover:bg-slate-500 font-bold py-2 px-4 rounded-lg transition text-sm sm:text-base">건너뛰기</button>
    </div>
</div>

            <!-- History Modal -->
            <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 modal-enter">
                <div class="bg-white rounded-xl p-6 md:p-8 shadow-2xl max-w-2xl w-full flex flex-col" style="max-height: 90vh;">
                    <div class="flex-shrink-0">
                        <h3 id="history-modal-title" class="text-xl sm:text-2xl font-bold mb-4 text-slate-900"></h3>
                    </div>
                    <div id="history-modal-content" class="overflow-y-auto flex-grow pr-4 -mr-4">
                        <!-- History table will be injected here -->
                    </div>
                    <div class="flex justify-end mt-6 flex-shrink-0">
                        <button data-action="close-modal" class="px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition shadow-md">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DATA & CONFIGURATION ---
    const workoutPlan = {
        1: { /* Weeks 1-12 data... */ 
            pull: { name: '풀(Pull) A', routine: [
                { type: '웜업', name: '노틸러스 풀오버', sets: '2~3세트', tip: '광배근 스트레칭과 혈류 공급에 집중합니다. (LBS 단위)', staticGoal: '🔥 목표: 40-60 LBS x 12-15회.', alternatives: ['덤벨 풀오버', '스트레이트 암 케이블 푸쉬다운'], movement_pattern: 'isolation_back'},
                { type: '웜업', name: '랫풀다운 (가볍게)', sets: '2세트', tip: '견갑을 아래로 누르는 움직임에 집중하여 등을 활성화시킵니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', alternatives: ['어시스트 풀업', '가벼운 케이블 로우'], movement_pattern: 'vertical_pull'},
                { type: '메인', name: '해머스트랭스 래터럴 로우 (T바)', sets: '탑/백오프 세트', tip: '등 상부 전체(후면 삼각근, 능형근, 중부 승모근)의 분리도와 선명도를 높이는 것이 목표입니다. 의자를 낮춰 거의 서는 자세를 만들고, 팔꿈치를 90도로 높게 벌린 T자 형태를 유지하며 견갑골(날개뼈)을 강하게 쥐어짜주세요.', baseTopSet: 50, unit: '한쪽', alternatives: ['T-바 로우', '덤벨 실(Seal) 로우'], movement_pattern: 'horizontal_pull'},
                { type: '메인', name: '해머스트랭스 하이로우', sets: '탑/백오프 세트', tip: '등 상부 전체, 특히 승모근과 능형근의 볼륨감을 키웁니다. 윗가슴을 패드에 고정하고, 팔꿈치를 대각선 아래 & 뒤쪽으로 당기며 등 상부를 최대한 수축하세요.', baseTopSet: 45, unit: '한쪽', alternatives: ['하이 케이블 로우 (와이드 그립)', '펜들레이 로우'], movement_pattern: 'horizontal_pull'},
                { type: '메인', name: '해머스트랭스 로우로우', sets: '탑/백오프 세트', tip: '등 상부 전체, 특히 승모근과 능형근의 종합적인 발달을 위한 운동입니다. 이 머신은 당기는 동작 후반부에 자연스러운 상승 궤적을 그립니다. 이 궤적을 따라 견갑골을 강하게 모으면서 자연스럽게 으쓱해준다는 느낌으로 끝까지 당겨주면, 등 중앙부는 물론 상부 승모근까지 완벽하게 자극할 수 있습니다.', baseTopSet: 50, unit: '한쪽', alternatives: ['인클라인 덤벨 로우', '메도우 로우(Meadows Row)'], movement_pattern: 'horizontal_pull'},
                { type: '보조', name: '리어 델트 머신', sets: '3~4세트', tip: '가슴을 패드에 붙이고, 팔을 편 상태를 유지하며 어깨 뒤쪽 근육의 힘으로만 핸들을 벌려줍니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', increment: 5, alternatives: ['벤트오버 덤벨 레터럴 레이즈', '페이스 풀'], movement_pattern: 'horizontal_pull'},
                { type: '마무리', name: '케이블 푸쉬 다운', sets: '3~4세트', tip: '팔꿈치를 옆구리에 고정한 채, 삼두근 바깥쪽의 힘으로 바를 아래로 눌러줍니다. 상체 반동을 최소화하세요.', staticGoal: '🔥 목표: 35-45kg x 10-15회.', increment: 5, alternatives: ['케이블 오버헤드 익스텐션', '덤벨 킥백'], movement_pattern: 'isolation_triceps'}
            ]},
            leg: { name: '레그(Leg) A', routine: [
                { type: '웜업', name: '노틸러스 이너 타이', sets: '2세트', tip: '고관절 내전근을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어덕션', '코펜하겐 플랭크'], movement_pattern: 'isolation_quads' },
                { type: '웜업', name: '노틸러스 아웃 타이', sets: '2세트', tip: '고관절 외전근(둔근)을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어브덕션', '밴드 클램쉘'], movement_pattern: 'isolation_glutes' },
                { type: '웜업', name: '레그 익스텐션 (가볍게)', sets: '2세트', tip: '무릎 관절을 예열하고 대퇴사두에 혈류를 보냅니다.', staticGoal: '🔥 목표: 20-30kg x 15회.', movement_pattern: 'isolation_quads' },
                { type: '메인', name: '싸이벡스 스미스 머신 스쿼트', sets: '탑/백오프 세트', tip: '발을 어깨너비로 벌리고, 허리를 편 상태를 유지하며 깊게 앉습니다. 하체 전반의 힘을 사용하세요.', baseTopSet: 45, unit: '한쪽', alternatives: ['바벨 백스쿼트', '고블릿 스쿼트'], movement_pattern: 'squat'},
                { type: '메인', name: '레그 프레스', sets: '탑/백오프 세트', tip: '발을 발판 중앙, 어깨너비로 둡니다. 발뒤꿈치로 민다는 느낌으로 허벅지 전체에 균형잡힌 부하를 전달합니다.', baseTopSet: 160, unit: '총', alternatives: ['바벨 백스쿼트', '덤벨 런지'], movement_pattern: 'squat'},
                { type: '보조', name: '노틸러스 레그 익스텐션 (보조)', sets: '3~4세트', tip: '다리를 완전히 폈을 때 1~2초간 멈춰 대퇴사두를 강하게 쥐어짭니다. 엉덩이가 뜨지 않도록 주의하세요.', staticGoal: '🔥 목표: 50-60kg x 12-15회.', increment: 5, alternatives: ['시시(Sissy) 스쿼트 (주의)', '밴드 레그 익스텐션'], movement_pattern: 'isolation_quads' },
                { type: '보조', name: '노틸러스 레그 컬', sets: '3~4세트', tip: '뒤꿈치를 엉덩이 쪽으로 당길 때 햄스트링을 강하게 수축하고, 천천히 저항을 느끼면서 다리를 폅니다.', staticGoal: '🔥 목표: 40-50kg x 12-15회.', increment: 5, alternatives: ['덤벨 레그 컬', '노르딕 햄스트링 컬'], movement_pattern: 'isolation_hams' },
                { type: '마무리', name: '레그 프레스 카프 레이즈', sets: '3~4세트', tip: '발끝을 발판 아래쪽에 두고, 발뒤꿈치를 최대한 이완시켰다가 발끝으로 강하게 밀어 종아리를 수축합니다.', staticGoal: '🔥 목표: 60-80kg x 15-20회.', increment: 5, alternatives: ['스미스머신 카프레이즈', '시티드 카프레이즈'], movement_pattern: 'isolation_calves' }
            ]},
            push: { name: '푸쉬(Push) A', routine: [
                { type: '웜업', name: '해머스트랭스 래터럴 로우', sets: '4세트', tip: '견갑을 안정화시키고 후면을 활성화합니다. 가볍게 당기며 날개뼈 주변을 예열하세요.', staticGoal: '🔥 목표: 한쪽 20kg x 10회.', movement_pattern: 'horizontal_pull' },
                { type: '웜업', name: '팩덱 플라이', sets: '3세트', tip: '가슴 근육을 선피로시켜 프레스 시 자극을 극대화합니다.', staticGoal: '🔥 목표: 45kg x 10-12회.', alternatives: ['가벼운 케이블 플라이', '덤벨 플라이'], movement_pattern: 'isolation_chest' },
                { type: '메인', name: '로우 인클라인 스미스 프레스', sets: '탑/백오프 세트', tip: '벤치 각도를 낮게(약 15-20도) 설정하여 윗가슴 상부를 타겟합니다. 등을 패드에 단단히 고정하되, 견갑은 자연스럽게 움직이도록 허용하여 윗가슴의 최대 이완과 수축에 집중하세요.', baseTopSet: 35, unit: '한쪽', alternatives: ['로우 인클라인 덤벨 프레스', '로우 인클라인 바벨 프레스'], movement_pattern: 'horizontal_push'},
                { type: '메인', name: '해머스트랭스 인클라인 프레스', sets: '탑/백오프 세트', tip: '자연스러운 아크 궤적을 이용해 윗가슴에 새로운 자극을 줍니다. 등을 패드에 고정해 안정적인 기반을 만들고, 견갑의 자연스러운 움직임을 통해 윗가슴을 최대로 스트레칭하고 수축시키세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['인클라인 덤벨 프레스', '인클라인 바벨 프레스'], movement_pattern: 'horizontal_push'},
                { type: '메인', name: '해머스트랭스 숄더 프레스', sets: '탑/백오프 세트', tip: '어깨의 전면과 측면을 타겟합니다. 등을 패드에 기대어 몸을 안정시키고, 자연스러운 어깨와 견갑의 리듬을 이용해 어깨 근육을 끝까지 수축하고 이완시키는 것에 집중하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['시티드 덤벨 숄더 프레스', '아놀드 프레스'], movement_pattern: 'vertical_push'},
                { type: '보조', name: '딥스 머신', sets: '3~4세트', tip: '아랫가슴과 삼두근에 볼륨을 더합니다. 상체를 숙일수록 아랫가슴에 자극이 집중됩니다. 이완 시 견갑이 자연스럽게 상승하며 가슴이 최대로 늘어나는 것을 느끼세요.', staticGoal: '🔥 목표: 실패지점까지 x 3-4세트.', increment: 5, alternatives: ['딥스 (평행봉)', '디클라인 푸쉬업'], movement_pattern: 'horizontal_push' },
                { type: '마무리', name: '뉴텍 암 컬 머신 (투핸드)', sets: '3~4세트', tip: '팔을 패드에 완전히 고정하고, 반동 없이 이두근의 힘으로만 핸들을 들어올려 강하게 수축합니다.', staticGoal: '🔥 목표: 25-35kg x 10-15회.', increment: 5, alternatives: ['덤벨 프리쳐 컬', '케이블 바이셉 컬'], movement_pattern: 'isolation_biceps'}
            ]}
        },
        2: {
            pull: { name: '풀(Pull) B', routine: [
                { type: '웜업', name: '노틸러스 풀오버', sets: '2~3세트', tip: '광배근 스트레칭과 혈류 공급에 집중합니다. (LBS 단위)', staticGoal: '🔥 목표: 40-60 LBS x 12-15회.', alternatives: ['덤벨 풀오버', '스트레이트 암 케이블 푸쉬다운'], movement_pattern: 'isolation_back'},
                { type: '웜업', name: '랫풀다운 (가볍게)', sets: '2세트', tip: '견갑을 아래로 누르는 움직임에 집중하여 등을 활성화시킵니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', alternatives: ['어시스트 풀업', '가벼운 케이블 로우'], movement_pattern: 'vertical_pull'},
                { type: '메인', name: '해머스트랭스 D.Y. 로우', sets: '탑/백오프 세트', tip: '언더그립으로 광배근 하부를 완벽하게 고립하여 타겟합니다. 안장을 낮춰 명치에 패드가 오게 하고, 팔꿈치를 옆구리에 붙여 배꼽 쪽으로 당기는 느낌에 집중하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['원 암 덤벨 로우 (광배 하부 타겟)', '시티드 케이블 로우 (언더 그립)'], movement_pattern: 'horizontal_pull'},
                { type: '메인', name: '랫풀다운 (맥그립 언더)', sets: '탑/백오프 세트', tip: 'D.Y. 로우와 함께 광배근 하부를 다른 각도(수직)에서 공략합니다. 가슴을 열고 당겨주며, 최대 수축 지점에서 등을 쥐어짜세요.', baseTopSet: 65, unit: '총', alternatives: ['어시스트 친업', '언더그립 바벨 로우'], movement_pattern: 'vertical_pull'},
                { type: '메인', name: '해머스트랭스 프론트 풀다운', sets: '탑/백오프 세트', tip: '언더핸드 그립으로 핸들을 잡고 광배근 전체를 타겟합니다. 머신의 자연스러운 호(arc) 궤적을 따라 팔꿈치를 아래 및 뒤쪽으로 당겨, 등 중앙부까지 완전히 수축하는 느낌에 집중하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['언더 그립 풀업', '언더 그립 랫풀다운'], movement_pattern: 'vertical_pull'},
                { type: '보조', name: '해머스트랭스 래터럴 로우 (원핸드 뉴트럴)', sets: '3~4세트', tip: "등 전체의 '덩어리감'과 볼륨을 채워줍니다. 팔꿈치로 등 중앙을 깊게 찍는다는 느낌으로 당깁니다.", staticGoal: '🔥 목표: 한쪽 30-40kg x 10-12회.', increment: 10, alternatives: ['원 암 덤벨 로우', '원 암 시티드 케이블 로우'], movement_pattern: 'horizontal_pull'},
                { type: '마무리', name: '라잉 트라이셉스 익스텐션', sets: '3~4세트', tip: '삼두근의 가장 큰 부위(장두)를 타겟합니다. 팔꿈치를 고정한 채 이마나 정수리 쪽으로 바를 내립니다. EZ바 사용을 권장합니다.', staticGoal: '🔥 목표: 20-30kg x 10-15회.', increment: 5, alternatives: ['케이블 오버헤드 익스텐션', '덤벨 오버헤드 익스텐션'], movement_pattern: 'isolation_triceps'}
            ]},
            leg: { name: '레그(Leg) B', routine: [
                { type: '웜업', name: '노틸러스 이너 타이', sets: '2세트', tip: '고관절 내전근을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어덕션', '코펜하겐 플랭크'], movement_pattern: 'isolation_quads' },
                { type: '웜업', name: '노틸러스 아웃 타이', sets: '2세트', tip: '고관절 외전근(둔근)을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어브덕션', '밴드 클램쉘'], movement_pattern: 'isolation_glutes' },
                { type: '선피로', name: '노틸러스 레그 익스텐션 (선피로)', sets: '3세트', tip: '가벼운 무게로 대퇴사두에 혈류를 집중시킵니다. 펌핑감을 느끼는 데 집중하세요.', staticGoal: '🔥 목표: 25-35kg x 15-20회.', movement_pattern: 'isolation_quads' },
                { type: '메인', name: '레그 프레스 (대퇴사두 타겟)', sets: '탑/백오프 세트', tip: '발을 발판 아래쪽에 어깨너비보다 좁게 두어 대퇴사두에 자극을 집중시킵니다. 무릎 통증에 주의하며 가동범위를 조절하세요.', baseTopSet: 160, unit: '총', alternatives: ['바벨 프론트 스쿼트', '핵스쿼트'], movement_pattern: 'squat' },
                { type: '메인', name: '싸이벡스 핵스쿼트', sets: '탑/백오프 세트', tip: '안정적인 궤적을 이용해 대퇴사두에 강한 고립감을 줍니다. 등을 패드에 완전히 고정하고 엉덩이가 뜨지 않게 하며, 허리가 둥글게 말리기 직전까지만 내려가세요.', baseTopSet: 80, unit: '총', alternatives: ['V스쿼트', '스미스머신 프론트 스쿼트'], movement_pattern: 'squat' },
                { type: '보조', name: '노틸러스 레그 익스텐션 (보조)', sets: '3세트', tip: '무거운 무게로 대퇴사두를 완전히 털어냅니다. 최대 수축 지점에서 1~2초 멈춰주세요.', staticGoal: '🔥 목표: 50-60kg x 12-15회.', increment: 5, alternatives: ['시시(Sissy) 스쿼트 (주의)', '밴드 레그 익스텐션'], movement_pattern: 'isolation_quads' },
                { type: '마무리', name: '노틸러스 레그 컬', sets: '3세트', tip: '균형을 위해 햄스트링을 가볍게 자극하며 마무리합니다. 네거티브 동작에 집중하세요.', staticGoal: '🔥 목표: 40-50kg x 12-15회.', increment: 5, alternatives: ['덤벨 레그 컬', '스위스볼 레그 컬'], movement_pattern: 'isolation_hams' }
            ]},
            push: { name: '푸쉬(Push) B', routine: [
                { type: '웜업', name: '해머스트랭스 래터럴 로우', sets: '4세트', tip: '견갑을 안정화시키고 후면을 활성화합니다. 가볍게 당기며 날개뼈 주변을 예열하세요.', staticGoal: '🔥 목표: 한쪽 20kg x 10회.', movement_pattern: 'horizontal_pull' },
                { type: '웜업', name: '팩덱 플라이', sets: '3세트', tip: '가슴 근육을 선피로시켜 프레스 시 자극을 극대화합니다.', staticGoal: '🔥 목표: 45kg x 10-12회.', alternatives: ['가벼운 케이블 플라이', '덤벨 플라이'], movement_pattern: 'isolation_chest' },
                { type: '메인', name: '해머스트랭스 시티드 체스트 프레스', sets: '탑/백오프 세트', tip: '가슴 중앙부의 볼륨감을 키우는 것이 목표입니다. 등을 패드에 완전히 고정하여 안정적인 기반을 만들되, 견갑의 자연스러운 움직임을 허용하여 가슴 근육의 최대 수축과 이완에 집중하세요.', baseTopSet: 30, unit: '한쪽', alternatives: ['플랫 덤벨 프레스', '플랫 바벨 벤치프레스'], movement_pattern: 'horizontal_push' },
                { type: '메인', name: '너틸러스 프레스 (디클라인 응용)', sets: '탑/백오프 세트', tip: '아랫가슴 라인을 선명하게 만듭니다. 등을 패드에 단단히 고정하되, 견갑의 움직임을 허용하여 팔꿈치를 아래로 내릴 때 아랫가슴이 최대로 스트레칭되는 느낌에 집중하세요.', baseTopSet: 70, unit: '총', alternatives: ['디클라인 덤벨/바벨 프레스', '딥스 (가슴 타겟)'], movement_pattern: 'horizontal_push' },
                { type: '메인', name: '스미스 머신 숄더 프레스', sets: '탑/백오프 세트', tip: '바가 턱 끝이나 쇄골까지 오도록 깊게 내립니다. 등을 벤치에 기대어 안정성을 확보하고, 견갑의 자연스러운 상방회전을 이용해 어깨 근육을 끝까지 쥐어짜는 느낌에 집중하세요.', baseTopSet: 40, unit: '한쪽', alternatives: ['시티드 바벨 숄더 프레스', '시티드 덤벨 숄더 프레스'], movement_pattern: 'vertical_push' },
                { type: '보조', name: '케이블 크로스오버', sets: '3~4세트', tip: '가슴 중앙부와 안쪽 라인을 만드는 것이 목표입니다.<br>1. 케이블 풀리를 가슴 중앙 높이에 맞추고 D-핸들을 잡습니다.<br>2. 몸을 앞으로 살짝 숙여 안정적인 자세를 잡습니다.<br>3. 팔꿈치를 살짝 구부린 상태로, 큰 원을 그리듯 가슴 중앙으로 모아주며 강하게 수축합니다.', staticGoal: '🔥 목표: 한쪽 10-15kg x 15-20회.', increment: 5, alternatives: ['덤벨 플라이', '팩덱 플라이 머신'], movement_pattern: 'isolation_chest' },
                { type: '마무리', name: '뉴텍 암 컬 머신 (원핸드)', sets: '3~4세트', tip: '한 팔씩 수행하여 좌우 불균형을 교정하고 최고의 마인드-머슬 커넥션을 이끌어냅니다.', staticGoal: '🔥 목표: 한쪽 17.5-22.5kg x 10-15회.', increment: 5, alternatives: ['원 암 덤벨 컬', '원 암 케이블 컬'], movement_pattern: 'isolation_biceps'}
            ]}
        },
        3: {
             pull: { name: '풀(Pull) C', routine: [
                { type: '웜업', name: '노틸러스 풀오버', sets: '2~3세트', tip: '광배근 스트레칭과 혈류 공급에 집중합니다. (LBS 단위)', staticGoal: '🔥 목표: 40-60 LBS x 12-15회.', alternatives: ['덤벨 풀오버', '스트레이트 암 케이블 푸쉬다운'], movement_pattern: 'isolation_back'},
                { type: '웜업', name: '랫풀다운 (가볍게)', sets: '2세트', tip: '견갑을 아래로 누르는 움직임에 집중하여 등을 활성화시킵니다.', staticGoal: '🔥 목표: 30-40kg x 12-15회.', alternatives: ['어시스트 풀업', '가벼운 케이블 로우'], movement_pattern: 'vertical_pull'},
                { type: '메인', name: '랫풀다운 (맥그립 중간)', sets: '탑/백오프 세트', tip: '광배근 전체의 볼륨과 매스를 키우는 올라운더 그립. 가슴을 열고 팔꿈치를 아래쪽 옆구리로 당긴다는 느낌으로 수행합니다.', baseTopSet: 65, unit: '총', alternatives: ['뉴트럴 그립 풀업', '시티드 케이블 로우 (V-바)'], movement_pattern: 'vertical_pull'},
                { type: '메인', name: '원 암 시티드 케이블 로우', sets: '탑/백오프 세트', tip: '케이블의 지속적인 장력으로 광배근을 고립합니다. 당기면서 상체를 살짝 회전시켜 수축감을 극대화하고, 이완 시에는 최대한 늘려주세요.', baseTopSet: 40, unit: '총', alternatives: ['원 암 덤벨 로우', 'T-바 로우 (원 암)'], movement_pattern: 'horizontal_pull'},
                { type: '메인', name: '해머스트랭스 프론트 풀다운 (파나타 스타일)', sets: '탑/백오프 세트', tip: "원 암 방식으로 견갑골을 최대로 움직여, 일반 풀다운으로는 불가능한 '최대 이완' 지점을 공략해 등 너비감을 만드는 운동입니다.<br>스트랩형 원핸드 그립 연결 후, 운동하는 쪽 어깨를 앞으로 최대한 밀어내 광배근 바깥쪽의 최대 이완 지점을 찾고, 그 지점에서부터 팔꿈치를 골반 쪽으로 당겨 등 하부까지 수축합니다.", baseTopSet: 30, unit: '한쪽', alternatives: ['원 암 케이블 풀다운', '원 암 랫풀다운 머신'], movement_pattern: 'vertical_pull'},
                { type: '보조', name: '백 익스텐션', sets: '3~4세트', tip: '허리 라인의 선명함과 깊이감을 만듭니다. 엉덩이와 등의 힘으로 상체를 들어올리고, 허리가 과하게 꺾이지 않도록 주의합니다.', staticGoal: '🔥 목표: 맨몸 또는 10kg 원판 x 15-20회.', increment: 2.5, alternatives: ['굿모닝 (가볍게)', '리버스 하이퍼익스텐션'], movement_pattern: 'hip_hinge'},
                { type: '마무리', name: '뉴텍 오버헤드 트라이셉스 익스텐션', sets: '2~3세트', tip: '시작 저항이 매우 강한 머신입니다. 처음에는 원판 없이 시작하여 자극에 적응하세요. 팔꿈치를 고정하고, 천천히 이완하며 삼두근 장두가 최대로 늘어나는 것을 느끼는 것이 핵심입니다.', staticGoal: '🔥 목표: 0kg x 8-10회.', increment: 5, alternatives: ['케이블 오버헤드 익스텐션 (로프)', '덤벨 오버헤드 익스텐션'], movement_pattern: 'isolation_triceps'}
            ]},
             leg: { name: '레그(Leg) C', routine: [
                { type: '웜업', name: '노틸러스 이너 타이', sets: '2세트', tip: '고관절 내전근을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어덕션', '코펜하겐 플랭크'], movement_pattern: 'isolation_quads' },
                { type: '웜업', name: '노틸러스 아웃 타이', sets: '2세트', tip: '고관절 외전근(둔근)을 활성화합니다. (LBS 단위)', staticGoal: '🔥 목표: 100-130 LBS x 10-12회.', alternatives: ['케이블 어브덕션', '밴드 클램쉘'], movement_pattern: 'isolation_glutes' },
                { type: '선피로', name: '노틸러스 레그 컬', sets: '3세트', tip: '가벼운 무게로 햄스트링에 먼저 자극을 줍니다. 펌핑감에 집중하세요.', staticGoal: '🔥 목표: 25-35kg x 15-20회.', movement_pattern: 'isolation_hams' },
                { type: '메인', name: '레그 프레스 (햄스트링/둔근 타겟)', sets: '탑/백오프 세트', tip: '발을 발판 위쪽에 넓게 두어 내전근을 포함한 후면 사슬 전체의 볼륨감에 집중합니다. 엉덩이가 패드에서 뜨지 않는 깊이까지만 내려가세요.', baseTopSet: 160, unit: '총', alternatives: ['루마니안 데드리프트', '바벨 굿모닝'], movement_pattern: 'hip_hinge'},
                { type: '메인', name: '뉴텍 V스쿼트 (리버스)', sets: '탑/백오프 세트', tip: '머신을 마주보고 서서 어깨를 고리 모양의 패드에 견착합니다. 발을 어깨너비 또는 약간 좁게 두고, 엉덩이를 뒤로 깊게 빼며 앉아 햄스트링과 둔근의 최대 이완과 고립에 집중하세요. 발뒤꿈치로 강하게 밀어 올라오며 둔근을 수축합니다.', baseTopSet: 80, unit: '총', alternatives: ['바벨 굿모닝', '케이블 풀 스루'], movement_pattern: 'hip_hinge' },
                { type: '보조', name: '노틸러스 레그 컬', sets: '3~4세트', tip: '무거운 무게로 햄스트링 볼륨을 극대화합니다. 최대 수축 지점에서 1~2초 멈춰주세요.', staticGoal: '🔥 목표: 40-50kg x 12-15회.', increment: 5, alternatives: ['덤벨 레그 컬', '노르딕 햄스트링 컬'], movement_pattern: 'isolation_hams' },
                { type: '마무리', name: '부티빌더 스탠딩 힙 쓰러스트', sets: '3~4세트', tip: '패드를 골반에 위치시키고, 발뒤꿈치로 강하게 밀어 엉덩이를 최대로 수축합니다. 정점에서 1~2초간 멈춰주세요.', staticGoal: '🔥 목표: 40-60kg x 12-15회.', increment: 5, alternatives: ['바벨 힙 쓰러스트', '케이블 풀 스루'], movement_pattern: 'hip_hinge' }
            ]},
            push: { name: '푸쉬(Push) C', routine: [
                { type: '웜업', name: '해머스트랭스 래터럴 로우', sets: '4세트', tip: '견갑을 안정화시키고 후면을 활성화합니다. 가볍게 당기며 날개뼈 주변을 예열하세요.', staticGoal: '🔥 목표: 한쪽 20kg x 10회.', movement_pattern: 'horizontal_pull' },
                { type: '웜업', name: '팩덱 플라이', sets: '3세트', tip: '가슴 근육을 선피로시켜 프레스 시 자극을 극대화합니다.', staticGoal: '🔥 목표: 45kg x 10-12회.', alternatives: ['가벼운 케이블 플라이', '덤벨 플라이'], movement_pattern: 'isolation_chest' },
                { type: '메인', name: '뉴트럴 그립 덤벨 인클라인 프레스', sets: '탑/백오프 세트', tip: '벤치 각도를 30도로 설정합니다. 어깨 관절의 부담을 줄이면서 윗가슴 상부(쇄골지)를 집중적으로 공략하는 것이 핵심입니다. 등을 벤치에 단단히 고정하고, 팔꿈치를 과도하게 벌리지 말고 몸통에 가까운 궤적으로 움직이세요. 덤벨을 내릴 때 윗가슴이 최대로 늘어나는 것을 느끼고, 들어 올릴 때는 윗가슴을 강하게 쥐어짠다는 느낌에 집중하세요.', baseTopSet: 26, unit: '한쪽', alternatives: ['로우 인클라인 스미스 프레스', '인클라인 바벨 프레스'], movement_pattern: 'horizontal_push'},
                { type: '메인', name: '너틸러스 체스트 프레스 (뉴트럴)', sets: '탑/백오프 세트', tip: 'V자 그립으로 가슴 중앙부를 강하게 수축시킵니다. 등을 패드에 기대 안정성을 확보하고, 프레스 동작 마지막에 견갑을 살짝 전인(내밀어)시켜 가슴 안쪽까지 완전히 쥐어짜주세요.', baseTopSet: 70, unit: '총', alternatives: ['뉴트럴 그립 덤벨 프레스', '클로즈 그립 벤치프레스'], movement_pattern: 'horizontal_push'},
                { type: '메인', name: '사이드 래터럴 레이즈 머신', sets: '3~4세트', tip: '어깨 측면(측면 삼각근)을 완벽하게 고립하여 어깨 프레임을 넓히는 것이 목표입니다. 팔꿈치로 패드를 들어올린다는 느낌으로 수행하고, 승모근이 으쓱하지 않도록 통제하는 것이 핵심입니다.', staticGoal: '🔥 목표: 30kg x 10-15회.', increment: 10, alternatives: ['덤벨 사이드 레터럴 레이즈', '케이블 사이드 레터럴 레이즈'], movement_pattern: 'isolation_shoulder'},
                { type: '보조', name: '딥스 머신', sets: '3~4세트', tip: '아랫가슴과 삼두근에 볼륨을 더합니다. 상체를 숙일수록 아랫가슴에 자극이 집중됩니다. 이완 시 견갑이 자연스럽게 상승하며 가슴이 최대로 늘어나는 것을 느끼세요.', staticGoal: '🔥 목표: 실패지점까지 x 3-4세트.', increment: 5, alternatives: ['딥스 (평행봉)', '디클라인 푸쉬업'], movement_pattern: 'horizontal_push' },
                { type: '마무리', name: '인클라인 케이블 컬', sets: '3~4세트', tip: '벤치에 누워 이두근을 최대로 이완시킨 상태에서 시작하여, 이두근의 장두(긴 갈래)를 집중적으로 공략합니다. 지속적인 장력을 느끼는 것이 핵심입니다.', staticGoal: '🔥 목표: 한쪽 10-15kg x 10-15회.', increment: 5, alternatives: ['인클라인 덤벨 컬', '케이블 드래그 컬'], movement_pattern: 'isolation_biceps'}
            ]}
        },
        13: {
            pull: { name: '풀(Pull) 종합 디로딩', routine: [
                { type: '회복', name: '랫풀다운 (맥그립 중간)', sets: '2세트'},
                { type: '회복', name: '해머스트랭스 D.Y. 로우', sets: '2세트'},
                { type: '회복', name: '해머스트랭스 래터럴 로우 (T바)', sets: '2세트'},
                { type: '회복', name: '리어 델트 머신', sets: '2세트'}
            ]},
            leg: { name: '레그(Leg) 종합 디로딩', routine: [
                { type: '회복', name: '싸이벡스 스미스 머신 스쿼트', sets: '2세트'},
                { type: '회복', name: '레그 프레스', sets: '2세트'},
                { type: '회복', name: '노틸러스 레그 익스텐션 (보조)', sets: '2세트'},
                { type: '회복', name: '노틸러스 레그 컬', sets: '2세트'}
            ]},
            push: { name: '푸쉬(Push) 종합 디로딩', routine: [
                { type: '회복', name: '로우 인클라인 스미스 프레스', sets: '2세트'},
                { type: '회복', name: '해머스트랭스 시티드 체스트 프레스', sets: '2세트'},
                { type: '회복', name: '해머스트랭스 숄더 프레스', sets: '2세트'},
                { type: '회복', name: '사이드 래터럴 레이즈 머신', sets: '2세트'}
            ]}
        }
    };
    const phaseInfo = {
        descriptions: {
            '강화 주기': '최대 근력(Strength) 증진. 메인 운동은 \'탑/백오프 세트\' 방식으로 진행하며, 점진적으로 더 무거운 무게에 도전하는 것이 목표입니다.',
            '축적 주기': '근비대(Hypertrophy)를 위한 운동량(Volume) 확보. 메인 운동은 \'워킹 세트\' (8~12회 x 3~4세트)로 변경하여 수행합니다.',
            '디로딩 주간': '\'능동적 회복\'을 통해 중추신경계와 관절의 피로를 완전히 해소하고 다음 12주를 준비하는 시기입니다. 평소 워킹 세트 중량의 50%~60%, 세트 수의 절반만 가볍게 수행합니다.'
        },
        colors: {
            '강화 주기': 'bg-red-100 text-red-800',
            '축적 주기': 'bg-green-100 text-green-800',
            '디로딩 주간': 'bg-sky-100 text-sky-800'
        }
    };
    
    // --- APP STATE & DOM ELEMENTS ---
// ▼▼▼ 화면 꺼짐 방지(Wake Lock) 기능 코드 ▼▼▼
let wakeLock = null;

// Function to acquire the wake lock
const acquireWakeLock = async () => {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('화면 꺼짐 방지 기능이 활성화되었습니다.');

            // The lock can be released by the system, so listen for release events
            wakeLock.addEventListener('release', () => {
                console.log('화면 꺼짐 방지 기능이 시스템에 의해 해제되었습니다.');
                wakeLock = null;
            });
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    } else {
        console.log('이 브라우저에서는 화면 꺼짐 방지 기능이 지원되지 않습니다.');
    }
};

// Function to release the wake lock
const releaseWakeLock = async () => {
    if (wakeLock !== null) {
        await wakeLock.release();
        wakeLock = null;
        console.log('화면 꺼짐 방지 기능이 비활성화되었습니다.');
    }
};
// ▲▲▲ /화면 꺼짐 방지(Wake Lock) 기능 코드 ▲▲▲
    let appState = {
        currentWeek: 1, currentDay: 'pull', currentCycleId: 1,
        displayCycleId: 1,
        allRecords: {}, inbodyRecords: [], charts: {}, dom: {},
        currentRoutine: [],
        timerInterval: null
    };

    // --- UTILITY FUNCTIONS ---
    const getSanitizedName = (ex) => (ex.name + (ex.type || '')).replace(/\s/g, '').replace(/[^a-zA-Z0-9가-힣]/g, '');
    const debounce = (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; };
    const roundToNearest2point5 = (num) => Math.round(num / 2.5) * 2.5;
    const formatTime = (seconds) => `${String(Math.floor(seconds / 60)).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
    let audioCtx;
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.warn("Web Audio API is not supported in this browser."); }
    const toLocalISODate = (d = new Date()) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    };
    const calculateEpley1RM = (weight, reps) => {
        if (!weight || !reps || reps < 1) return 0;
        if (reps === 1) return weight;
        return weight * (1 + reps / 30);
    };

    const parseWeightRange = (text) => {
        if (!text) return null;
        const kg = text.match(/([\d.]+)(?:-([\d.]+))?\s*kg/i);
        const lbs = text.match(/([\d.]+)(?:-([\d.]+))?\s*(?:lbs|pounds)/i);
        if (kg) return { unit: 'kg', min: parseFloat(kg[1]), max: parseFloat(kg[2] || kg[1]) };
        if (lbs) {
            const toKg = (x) => Math.round(x * 0.45359237 * 2) / 2; // 0.5kg 단위 반올림
            const min = toKg(parseFloat(lbs[1]));
            const max = toKg(parseFloat(lbs[2] || lbs[1]));
            return { unit: 'kg', min, max };
        }
        return null;
    };

    const pickStrongestSet = (sets) => {
        if (!sets || sets.length === 0) return { weight: 0, reps: 0, e1rm: 0 };
        return sets.reduce((best, s) => {
            const e = calculateEpley1RM(s.weight, s.reps);
            return e > best.e1rm ? { ...s, e1rm: e } : best;
        }, { weight: 0, reps: 0, e1rm: 0 });
    };

// 메인 운동 키(Set) 생성
function getMainExerciseKeySet() {
  const S = new Set();
  try {
    Object.values(workoutPlan || {}).forEach(week => {
      ['push','pull','leg'].forEach(dayKey => {
        const day = week?.[dayKey];
        (day?.routine || []).forEach(ex => {
          if (ex.type === '메인') {
            S.add(getSanitizedName(ex)); // ex.name + ex.type 기반
          }
        });
      });
    });
  } catch (e) { /* no-op */ }
  return S;
}    
    
// === PPL TOP3 (내부 PPL 사용) — "메인" 운동만 집계 ===
function getWeeklyPPLTop3(cycle = appState?.displayCycleId ?? 1,
                          week  = appState?.currentWeek ?? 1) {
  const buckets = { Push: new Map(), Pull: new Map(), Legs: new Map() };
  const MAIN = getMainExerciseKeySet(); // 메인 운동 키 집합

  // 내부 PPL 라벨 판별
  const toPPL = (v) => {
    if (!v && v !== 0) return null;
    const s = String(v).toLowerCase();
    if (s.includes('push') || s.includes('푸쉬') || s.includes('푸시')) return 'Push';
    if (s.includes('pull') || s.includes('풀')) return 'Pull';
    if (s.includes('leg')  || s.includes('하체')) return 'Legs';
    if (s === 'push' || s === 'pull' || s === 'leg' || s === 'legs') {
      return s === 'leg' ? 'Legs' : s[0].toUpperCase() + s.slice(1);
    }
    return null;
  };

  for (const [k, recs] of Object.entries(appState?.allRecords || {})) {
    (recs || []).forEach(r => {
      if (+r.cycleId !== +cycle || +r.week !== +week) return;

      // ⚠️ 메인 운동만 통과 (키 우선, 보조 매칭: exerciseName로 보정)
      const dispName = (r?.exerciseName || r?.name || '').trim();
      const asMainKey = dispName ? getSanitizedName({ name: dispName, type: '메인' }) : '';
      if (!MAIN.has(k) && (!asMainKey || !MAIN.has(asMainKey))) return;

      // PPL 판별 (내부 필드 우선 → 세션 텍스트 보조)
      const cat =
        toPPL(r?.ppl) || toPPL(r?.PPL) || toPPL(r?.category) || toPPL(r?.split) ||
        toPPL(r?.dayType) || toPPL(r?.dayTag) || toPPL(r?.workoutType) ||
        toPPL(r?.tags?.ppl) || toPPL(r?.meta?.ppl) ||
        toPPL(r?.dayName) || toPPL(r?.phase) || toPPL(r?.day);
      if (!cat || !buckets[cat]) return;

      // 운동명: allRecords의 키(k) 우선
      const name = (k || dispName || '미지정 운동').trim() || '미지정 운동';

      // Max Kg / Reps / Sets 집계
      let kgMax = 0, reps = 0, sets = 0;
      (r?.sets || []).forEach(s => {
        const w = +s?.weight || 0, rr = +s?.reps || 0;
        kgMax = Math.max(kgMax, w);
        reps  += rr; sets += 1;
      });

      const m = buckets[cat];
      const prev = m.get(name) || { name, kgMax: 0, reps: 0, sets: 0 };
      prev.kgMax = Math.max(prev.kgMax, kgMax);
      prev.reps += reps;
      prev.sets += sets;
      m.set(name, prev);
    });
  }

  const sortByMaxKg = (a,b) => (b.kgMax - a.kgMax) || (b.sets - a.sets) || (b.reps - a.reps);
  const top3 = m => [...m.values()].sort(sortByMaxKg).slice(0, 3);

  return {
    Push: top3(buckets.Push),
    Pull: top3(buckets.Pull),
    Legs: top3(buckets.Legs)
  };
}

// 폰트 로딩 보장 (Canvas는 폰트가 로딩되기 전에 그리면 깨져 보일 수 있음)
async function ensureFonts(fonts = []) {
  try {
    // CSS Font Loading API (지원 브라우저에서만 대기)
    if (document.fonts && document.fonts.load) {
      await Promise.all(fonts.map(f => document.fonts.load(f)));
      await document.fonts.ready;
    }
  } catch (e) { /* ignore */ }
}

// 문자 단위 줄바꿈 (한글/영문 혼용도 안정)
function drawTextWrap(ctx, text, x, y, maxWidth, lineHeight) {
  let line = '';
  for (const ch of String(text)) {
    const test = line + ch;
    if (ctx.measureText(test).width > maxWidth) {
      ctx.fillText(line, x, y);
      y += lineHeight;
      line = ch === ' ' ? '' : ch; // 줄 시작 공백 제거
    } else {
      line = test;
    }
  }
  if (line) {
    ctx.fillText(line, x, y);
    y += lineHeight;
  }
  return y;
}

    // --- CORE LOGIC FUNCTIONS ---
    function playBeepSound() {
        if (!audioCtx) return;
        function beep(frequency, duration) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.01);
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            oscillator.type = 'sine';
            
            oscillator.start(audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration/1000);
            oscillator.stop(audioCtx.currentTime + duration/1000);
        }
        beep(880, 100);
        setTimeout(() => beep(880, 100), 150);
    }
    
    function findOriginalExercise(exerciseName) {
        for (let i = 1; i <= 3; i++) {
            for (const day of Object.values(workoutPlan[i])) {
                const found = day.routine.find(ex => ex.name === exerciseName);
                if (found) return found;
            }
        }
        return null;
    }

    function getRestTime(exercise, phase) {
        if (exercise.type === '메인') {
            return phase === '강화 주기' ? 150 : 90;
        }
        if (exercise.type === '보조' || exercise.type === '마무리') {
            return 90;
        }
        return 60; // 웜업, 선피로, 디로딩 등
    }

    function getDeloadGoalText(exercise) {
        const originalExercise = findOriginalExercise(exercise.name);
        if (!originalExercise) return "가볍게 수행하세요.";
        
        let workingSetWeight = 0;
        if (originalExercise.baseTopSet) { // 메인 운동
            const sanitizedName = getSanitizedName(originalExercise);
            const refRecords = (appState.allRecords[sanitizedName] || [])
                .filter(r => r.phase === '강화 주기').sort((a, b) => (b.cycleId - a.cycleId) || (b.week - a.week));
            let e1RM = originalExercise.baseTopSet * (1 + 6/30);
            if(refRecords.length > 0) {
                const topSet = pickStrongestSet(refRecords[0].sets);
                if(topSet.weight > 0) e1RM = calculateEpley1RM(topSet.weight, topSet.reps);
            }
            workingSetWeight = roundToNearest2point5(e1RM * 0.7);
        } else if (originalExercise.staticGoal) { // 보조 운동
            const parsed = parseWeightRange(originalExercise.staticGoal);
            if (parsed) {
                workingSetWeight = parsed.min;
            }
        }
        
        if (workingSetWeight > 0) {
            const minDeload = roundToNearest2point5(workingSetWeight * 0.5);
            const maxDeload = roundToNearest2point5(workingSetWeight * 0.6);
            
            const setMatch = originalExercise.sets.match(/(\d+)/);
            let deloadSetText = '';
            if (setMatch && setMatch[1]) {
                const deloadSets = Math.ceil(parseInt(setMatch[1]) / 2);
                deloadSetText = ` (약 ${deloadSets}세트)`;
            } else {
                 deloadSetText = ` (약 1-2세트)`;
            }
            
            return `🔥 디로딩 목표: ${minDeload}-${maxDeload}kg${deloadSetText}`;
        }
        return "최근 워킹 세트 중량의 50~60%로 수행하세요.";
    }
    
    function getWeekInfo(week, cycleId) {
        if (week === 13) return { phase: '디로딩 주간', method: '디로딩', type: '종합', originalWeekData: workoutPlan[13] };
        const isBlock = cycleId % 2 === 1;
        let phase, type;
        if (isBlock) {
            type = ['A', 'B', 'C'][((week - 1) % 3)];
            phase = (week >= 4 && week <= 6) || (week >= 10 && week <= 12) ? '축적 주기' : '강화 주기';
        } else {
            type = ['A', 'B', 'C'][Math.floor((week - 1) / 2) % 3];
            phase = ((week % 2) !== 0) ? '강화 주기' : '축적 주기';
        }
        const method = (phase === '축적 주기' ? '워킹 세트' : '탑/백오프 세트');
        const originalWeekKey = ['A', 'B', 'C'].indexOf(type) + 1;
        return { phase, method, type, originalWeekData: workoutPlan[originalWeekKey] };
    }

    function getMainGoalText(exercise, week, cycleId) {
        if (!exercise.baseTopSet) return null;
        const { phase, type } = getWeekInfo(week, cycleId);
        if (phase === '디로딩 주간') return null;

        const sanitizedName = getSanitizedName(exercise);
        
    const allPastRecords = (appState.allRecords[sanitizedName] || [])
        .filter(r => (r.cycleId < cycleId || (r.cycleId === cycleId && r.week < week)));

    // BUG FIX: 항상 현재 사이클까지의 기록 중에서 최고 기록을 찾아야 함
    const allRecordsThroughCurrent = (appState.allRecords[sanitizedName] || [])
        .filter(r => (r.cycleId < appState.currentCycleId) || (r.cycleId === appState.currentCycleId && r.week <= appState.currentWeek));

    let peakE1RM = 0;
    if (allRecordsThroughCurrent.length > 0) { // <-- 이 부분을 수정하세요
         allRecordsThroughCurrent.forEach(record => { // <-- 이 부분을 수정하세요
            const strongestSet = pickStrongestSet(record.sets);
            if (strongestSet.e1rm > peakE1RM) {
                peakE1RM = strongestSet.e1rm;
            }
        });
    } else {
            peakE1RM = calculateEpley1RM(exercise.baseTopSet, 6); // 기록 없을 시 초기값
        }

        let lastTopSet = { weight: 0, reps: 0 };
        const lastStrengthRecord = allPastRecords
            .filter(r => r.phase === '강화 주기' && getWeekInfo(r.week, r.cycleId).type === type)
            .sort((a, b) => (b.cycleId - a.cycleId) || (b.week - a.week))[0];

        if (lastStrengthRecord) {
            const topSet = pickStrongestSet(lastStrengthRecord.sets);
            if (topSet.weight > 0) lastTopSet = topSet;
        }

        let change = 1.0;
        if (lastTopSet.reps >= 11) change = 1.05;      // 11회 이상: +5.0%
        else if (lastTopSet.reps >= 8) change = 1.025;   // 8-10회: +2.5%
        else if (lastTopSet.reps >= 6) change = 1.0125;  // 6-7회: +1.25%
        else if (lastTopSet.reps === 5) change = 1.0;     // 5회: 유지
        else if (lastTopSet.reps === 4) change = 0.975;  // 4회: -2.5%
        else if (lastTopSet.reps === 3) change = 0.95;    // 3회: -5.0%
        else change = 0.90;                            // 2회 이하: -10.0%

        let targetWeight = (peakE1RM / (1 + 6/30)) * change;
        
        const unitText = exercise.unit ? (exercise.unit === '총' ? '(전체 중량)' : '(한쪽 원판)') : '';

        if (phase === '강화 주기') {
            let goalWeight = roundToNearest2point5(targetWeight);
            if (lastTopSet.reps >= 6 && goalWeight <= lastTopSet.weight) {
                goalWeight = lastTopSet.weight + 2.5;
            }
            let backoffWeight = roundToNearest2point5(goalWeight * 0.8);
            return `🔥 강화 목표: ${unitText} 탑 ${Math.max(10, goalWeight)}kg x 최대 반복 / 백오프 ${Math.max(10, backoffWeight)}kg x 8-10회`;
        } else { // 축적 주기
            return `🔥 축적 목표: ${unitText} 워킹 세트 ${roundToNearest2point5(peakE1RM * 0.7)}kg x 8-12회`;
        }
    }

// --- BUG FIX v20.9.1: Aegis System v16 (Stateful, Recursive Goal Calculation) ---
const aegisCache = new Map(); // 메모리 캐시 추가

function getSmartAssistanceGoal_Aegis_v16(exercise, targetWeek, targetCycleId) {
    const { staticGoal: initialGoal, increment, sets: setsString } = exercise;
    const sanitizedName = getSanitizedName(exercise);

    // 현재 계산 중인 목표 주차 및 사이클 ID (재귀 호출 시 사용)
    const week = targetWeek !== undefined ? targetWeek : appState.currentWeek;
    const cycleId = targetCycleId !== undefined ? targetCycleId : appState.displayCycleId;

    // 캐시 키 생성 및 확인
    const cacheKey = `${sanitizedName}-${cycleId}-${week}`;
    if (aegisCache.has(cacheKey)) {
        return aegisCache.get(cacheKey);
    }

    // 기본 조건: 이지스 시스템 적용 대상이 아니거나, 1주차인 경우 초기 목표 반환
    if (!initialGoal || !increment || !setsString || week === 1) {
        return initialGoal;
    }

    // 분석할 가장 최근 기록을 찾는다 (현재 주차보다 이전 기록만)
    const lastRecord = (appState.allRecords[sanitizedName] || [])
        .filter(r => (r.cycleId < cycleId) || (r.cycleId === cycleId && r.week < week))
        .sort((a, b) => (b.cycleId - a.cycleId) || (b.week - a.week))[0];

    // 이전 기록이 없으면 초기 목표 반환
    if (!lastRecord) {
        return initialGoal;
    }

    // --- 핵심 로직: 과거의 목표를 재귀적으로 계산하여 가져온다 ---
    const historicGoal = getSmartAssistanceGoal_Aegis_v16(exercise, lastRecord.week, lastRecord.cycleId);

    const parsedW = parseWeightRange(historicGoal);
    const parsedR = historicGoal.match(/(\d+)\s*-\s*(\d+)회/);

    if (!parsedW || !parsedR) return historicGoal; // 이전 목표 계산이 잘못되면 그대로 반환

    const [ , minR, maxR ] = parsedR;
    const minWeightGoal = parsedW.min, maxWeightGoal = parsedW.max;
    const minRepsGoal = parseInt(minR), maxRepsGoal = parseInt(maxR);

    const performedSets = lastRecord.sets;
    const setsMatch = setsString.match(/(\d+)(?:~|-)?(\d+)?/);
    const minSetsGoal = setsMatch ? parseInt(setsMatch[1]) : 3;
    const maxSetsGoal = setsMatch ? parseInt(setsMatch[2] || setsMatch[1]) : minSetsGoal;

    // --- 감량 및 증량 조건 판단 ---
    const qualityFail = performedSets.filter(s => s.weight < minWeightGoal).length > performedSets.length / 2;
    const repsFail = performedSets.slice(0, minSetsGoal).some(s => s.weight >= minWeightGoal && s.reps < minRepsGoal);
    const performedVolume = performedSets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
    const minTargetVolume = minWeightGoal * minRepsGoal * minSetsGoal;
    const volumeFail = performedVolume < minTargetVolume;
    const setsFail = performedSets.length < minSetsGoal;

    let newGoal = historicGoal; // 기본값은 이전 목표 유지

    if (qualityFail || repsFail || volumeFail || setsFail) {
        // 감량 조건 충족
        let newMin = Math.max(0, roundToNearest2point5(minWeightGoal - increment));
        let newMax = Math.max(0, roundToNearest2point5(maxWeightGoal - increment));
        if (newMin === 0 && newMax === 0) return historicGoal;
        const weightText = newMin === newMax ? `${newMin}kg` : `${newMin}-${newMax}kg`;
        newGoal = historicGoal.replace(/([\d.]+)(?:-([\d.]+))?\s*(kg|lbs)/i, weightText);
    } else {
        // 증량 조건 확인
        const didMaxSets = performedSets.length >= maxSetsGoal;
        const allSetsPerfect = performedSets.every(s => s.weight >= maxWeightGoal && s.reps >= maxRepsGoal);
        if (didMaxSets && allSetsPerfect) {
            let newMin = Math.max(0, roundToNearest2point5(minWeightGoal + increment));
            let newMax = Math.max(0, roundToNearest2point5(maxWeightGoal + increment));
            const weightText = newMin === newMax ? `${newMin}kg` : `${newMin}-${newMax}kg`;
            newGoal = historicGoal.replace(/([\d.]+)(?:-([\d.]+))?\s*(kg|lbs)/i, weightText);
        }
    }

    // 계산된 최종 목표를 캐시에 저장하고 반환
    aegisCache.set(cacheKey, newGoal);
    return newGoal;
}

// --- RENDER & UI FUNCTIONS ---
    function renderWorkout() {
        const { currentWeek, currentDay, displayCycleId } = appState;
        const { phase, method, originalWeekData } = getWeekInfo(currentWeek, displayCycleId);
        
        const dom = appState.dom;
        dom.workoutTitle.textContent = `${currentWeek}주차: ${originalWeekData[currentDay]?.name || '휴식일'}`;
        
        // [버그 수정] 잘못된 문법을 올바르게 수정했습니다.
        dom.cycleInfoBadge.textContent = `(사이클 ${displayCycleId}: ${(displayCycleId % 2 === 1) ? '블록 주기화' : '주간 파동형 주기화'})`;
        
        dom.workoutPhaseBadge.className = `px-4 py-1.5 text-base font-semibold rounded-full self-start ${phaseInfo.colors[phase]}`;
        dom.workoutPhaseBadge.textContent = phase;
        dom.workoutPhaseDescription.textContent = phaseInfo.descriptions[phase];
        
        dom.workoutList.innerHTML = '';
        const routine = JSON.parse(JSON.stringify(originalWeekData[currentDay]?.routine || []));
        
        if (getWeekInfo(currentWeek, displayCycleId).type === 'C' && currentDay === 'push') {
            const isStrengthPhase = (phase === '강화 주기');
            const strengthExercise = { type: '메인', name: '뉴텍 스탠딩 사이드 레터럴 레이즈', sets: '3~4세트', tip: '어깨 관절을 머신의 회전축에 맞추고, 한 손씩 수행하여 측면 삼각근을 완벽하게 고립합니다. 반대 손으로 몸을 지지하여 반동을 통제하세요.', staticGoal: '🔥 목표: 30kg x 10-15회.', movement_pattern: 'isolation_shoulder', increment: 10, alternatives: ['덤벨 사이드 레터럴 레이즈', '케이블 사이드 레터럴 레이즈']};
            const accumulationExercise = { type: '메인', name: '케이블 X-레이즈', sets: '3~4세트', tip: '측면 삼각근을 최대로 이완(Stretch)시켜 자극하는 것이 목표입니다. 케이블 풀리를 중간 높이에 맞추고, 발목 스트랩을 양 손목에 착용합니다. 벤치에 누워 반대편 케이블을 손목 스트랩에 교차하여 연결한 뒤, 팔꿈치를 살짝 구부린 상태를 유지하며 큰 원을 그리듯 팔을 벌려 측면 어깨가 최대로 늘어나는 것을 느끼세요.', staticGoal: '🔥 목표: 0kg x 12-15회.', movement_pattern: 'isolation_shoulder', increment: 2.5, alternatives: ['덤벨 사이드 레터럴 레이즈 (인클라인)', '케이블 Y-레이즈']};
            const dynamicExercise = isStrengthPhase ? strengthExercise : accumulationExercise;
            const targetIndex = routine.findIndex(ex => ex.name === '사이드 래터럴 레이즈 머신');
            if (targetIndex !== -1) {
                routine.splice(targetIndex, 1, dynamicExercise);
            }
        }
        
        appState.currentRoutine = routine; // Store current routine for timer logic
        if (!routine.length) { 
            updateCycleNav(); // 루틴이 없어도 네비게이션은 업데이트
            return;
        }

        routine.forEach(exercise => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg p-4 sm:p-5 flex flex-col card-enter';
            const sanitizedName = getSanitizedName(exercise);
            
            let goalText, tipContent;
            const originalExercise = findOriginalExercise(exercise.name) || exercise;

            let methodText;
            if (phase === '축적 주기' && exercise.type === '메인') {
                methodText = `${method} (3-4세트)`;
            } else {
                methodText = (exercise.type === '메인' && exercise.baseTopSet && phase !== '디로딩 주간') ? method : exercise.sets;
            }

            if (phase === '디로딩 주간') {
                goalText = getDeloadGoalText(exercise);
                tipContent = originalExercise?.tip || "전략적 회복에 집중하세요.";
            } else {
                if (exercise.type === '메인' && exercise.baseTopSet) {
                    goalText = getMainGoalText(exercise, currentWeek, displayCycleId) || exercise.staticGoal || '';
                } else if (exercise.type !== '웜업') {
                    goalText = getSmartAssistanceGoal_Aegis_v16(exercise);
                } else {
                    goalText = exercise.staticGoal || '';
                }
                tipContent = exercise.tip;
            }
            const restTime = getRestTime(exercise, phase);
            const restText = `권장 휴식: ${Math.floor(restTime / 60)}분 ${restTime % 60}초`;

            const alternativesHTML = originalExercise?.alternatives?.length > 0 ? `
                <div class="mt-4 pt-4 border-t border-slate-200">
                    <h5 class="text-sm font-bold text-slate-700 mb-2">대체 운동</h5>
                    <ul class="list-disc list-inside text-sm text-slate-600 space-y-1 pl-2">${originalExercise.alternatives.map(alt => `<li>${alt}</li>`).join('')}</ul>
                </div>` : '';
            
            const movementPatternTag = exercise.movement_pattern ? `<span class="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full whitespace-nowrap">#${exercise.movement_pattern}</span>` : '';

            card.innerHTML = `
                <div class="flex-1">
                     <div class="flex items-center gap-3 mb-3 flex-wrap">
                        <span class="text-xs font-bold uppercase py-1 px-3 rounded-full ${exercise.type.includes('웜업') || exercise.type.includes('회복') ? 'bg-amber-100 text-amber-800' : exercise.type === '메인' ? 'bg-blue-100 text-blue-800' : 'bg-slate-100 text-slate-800'}">${exercise.type}</span>
                        <h4 class="text-lg sm:text-xl font-bold text-slate-900">${exercise.name}</h4>
                        ${movementPatternTag}
                    </div>
                    <p class="text-slate-600 text-sm sm:text-base">${tipContent}<br><span class="font-bold text-red-600">${goalText}</span></p>
                    <div class="flex justify-between items-center mt-3 gap-2">
                         <p class="text-sm font-semibold text-slate-500 flex-1 min-w-0">${methodText} &nbsp;&nbsp; | &nbsp;&nbsp; <span class="font-bold text-sky-700">${restText}</span></p>
                         <button data-action="view-history" data-exercise-name="${exercise.name}" class="p-2 text-slate-400 hover:text-blue-500 transition flex-shrink-0" title="과거 기록 보기">
                            <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="20" height="20" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm5 0v3h4V4h-4z"/>
                            </svg>
                         </button>
                    </div>
                </div>
                ${alternativesHTML}
                <div data-container-for="${sanitizedName}" class="space-y-3 mt-4"></div>
                <div class="mt-4"><button data-action="add-set" data-target="${sanitizedName}" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg transition shadow-md">+ 세트 추가</button></div>`;
            dom.workoutList.appendChild(card);
            
            const setsContainer = card.querySelector(`[data-container-for="${sanitizedName}"]`);
            const lastRecord = (appState.allRecords[sanitizedName] || []).find(r => r.week === currentWeek && r.day === currentDay && r.cycleId === displayCycleId);
            const setsToRender = lastRecord?.sets || [{ weight: '', reps: '' }];
            setsToRender.forEach((set, i) => addSetRow(setsContainer, i + 1, set));
        });
        
        updateCycleNav();
    }

    function addSetRow(container, setNumber, setData = {weight: '', reps: ''}) {
        const setRow = document.createElement('div');
        setRow.className = 'set-row flex items-center gap-3';
        setRow.innerHTML = `
            <span class="font-semibold text-slate-500 w-12 text-right">세트 ${setNumber}</span>
            <input type="number" step="0.1" data-type="weight" value="${setData.weight}" placeholder="중량" class="w-full p-2.5 border border-slate-300 rounded-lg">
            <span class="font-semibold text-slate-400">kg</span>
            <input type="number" data-type="reps" value="${setData.reps}" placeholder="횟수" class="w-full p-2.5 border border-slate-300 rounded-lg">
            <span class="font-semibold text-slate-400">회</span>
            <button data-action="delete-set" class="p-2 text-slate-400 hover:text-red-500 transition"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>`;
        container.appendChild(setRow);
    }

    function updateActiveButtons() {
        appState.dom.weekSelector.querySelectorAll('button').forEach(btn => {
            const isPressed = parseInt(btn.dataset.week) === appState.currentWeek;
            btn.classList.toggle('week-btn-active', isPressed);
            btn.setAttribute('aria-pressed', String(isPressed));
        });
        appState.dom.daySelector.querySelectorAll('button').forEach(btn => {
            const isPressed = btn.dataset.day === appState.currentDay;
            btn.classList.toggle('day-btn-active', isPressed);
            btn.setAttribute('aria-pressed', String(isPressed));
        });
    }

    function createTable(containerId, headers, dataRows) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (!dataRows || dataRows.length === 0) {
            container.innerHTML = `<p class="p-4 text-center text-slate-500">표시할 데이터가 없습니다.</p>`;
            return;
        }
        const table = document.createElement('table');
        table.className = 'w-full text-left border-collapse';
        table.innerHTML = `
            <thead class="bg-slate-100"><tr>${headers.map(h => `<th class="p-3 font-semibold text-slate-700 text-sm">${h}</th>`).join('')}</tr></thead>
            <tbody class="text-sm">${dataRows.map(row => `<tr class="border-b border-slate-200">${row.map(cell => `<td class="p-3 text-slate-600">${cell}</td>`).join('')}</tr>`).join('')}</tbody>`;
        container.innerHTML = '';
        container.appendChild(table);
    }
    
    function showView(viewName) {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        
        appState.dom.mainTabs.querySelectorAll('button').forEach(tab => {
            tab.classList.toggle('tab-active', tab.dataset.view === viewName);
            tab.classList.toggle('text-slate-500', tab.dataset.view !== viewName);
        });

        if (viewName === 'plan') renderPlanView();
        else if (viewName === 'records') renderRecordsView();
        else if (viewName === 'bodycomp') renderBodycompView();
    }

    function renderPlanView() {
        const headers = ['주차', '월요일 (PULL)', '수요일 (PUSH)', '금요일 (LEG)', '주요 훈련 방식'];
        const dataRows = Array.from({length: 13}, (_, i) => {
            const week = i + 1;
            const { phase, method, originalWeekData, type } = getWeekInfo(week, appState.displayCycleId);
            return [
                `<span class="font-bold">${week}</span>`,
                originalWeekData.pull?.name || `${type} 디로딩`,
                originalWeekData.push?.name || `${type} 디로딩`,
                originalWeekData.leg?.name || `${type} 디로딩`,
                `<span class="px-3 py-1 text-sm font-semibold rounded-full ${phaseInfo.colors[phase]}">${method}</span>`
            ];
        });
        createTable('plan-table-container', headers, dataRows);
    }
    
    function renderRecordsView() {
        renderMovementPatternAnalysis();
        populateExerciseSelector();
        handleExerciseSelection();
    }
    
    function populateExerciseSelector() {
        const selector = document.getElementById('exercise-selector');
        const exerciseSet = new Set();
        Object.values(workoutPlan).forEach(w => Object.values(w).forEach(d => d.routine.forEach(ex => exerciseSet.add(ex.name))));
        const list = Array.from(exerciseSet).sort();
        selector.innerHTML = '<option value="">-- 운동 선택 --</option>' + list.map(name => `<option value="${name}">${name}</option>`).join('');
        
    }

    function handleExerciseSelection() {
        const selector = document.getElementById('exercise-selector');
        const recordsContent = document.getElementById('records-content');
        const noRecords = document.getElementById('no-records');
        const exerciseName = selector.value;

        if (!exerciseName) {
            recordsContent.classList.add('hidden');
            noRecords.classList.remove('hidden');
            noRecords.innerHTML = `<p class="text-slate-500 text-lg">운동을 선택하고 기록을 확인해주세요.</p>`;
            return;
        }

        const base = (exerciseName).replace(/\s/g, '').replace(/[^a-zA-Z0-9가-힣]/g, '');
        const allMatchingRecords = Object.entries(appState.allRecords)
            .filter(([k]) => k.startsWith(base))
            .flatMap(([, arr]) => arr)
            .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by most recent
        
        if (allMatchingRecords.length === 0) {
            recordsContent.classList.add('hidden');
            noRecords.classList.remove('hidden');
            noRecords.innerHTML = `<p class="text-slate-500">이 운동에 대한 기록이 없습니다.</p>`;
            return;
        }

        recordsContent.classList.remove('hidden');
        noRecords.classList.add('hidden');
        document.getElementById('chart-title').textContent = `${exerciseName} 중량 변화 추이 (Top Set 기준)`;
        
        const chartRecords = allMatchingRecords.slice().reverse(); // For chart, reverse to show chronological order
        const labels = chartRecords.map(d => `C${d.cycleId || 1}-${d.week}주`);
        const topSetData = chartRecords.map(d => pickStrongestSet(d.sets)?.weight || null);
        const e1RMData = chartRecords.map(d => pickStrongestSet(d.sets)?.e1rm || null);
        
        initializeChart('progressChart', {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Top Set 중량 (kg)', data: topSetData, borderColor: '#3b82f6', yAxisID: 'y' },
                    { label: '추정 1RM (kg)', data: e1RMData, borderColor: '#ef4444', borderDash: [5, 5], yAxisID: 'y' }
                ]
            },
            options: { 
                scales: { y: { beginAtZero: true, suggestedMin: 0, title: { display: true, text: '중량 (kg)' } } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const record = chartRecords[dataIndex];
                                const topSet = pickStrongestSet(record.sets);
                                if (!topSet || !topSet.weight) return '';
                                return `Top Set: ${topSet.weight}kg x ${topSet.reps}회`;
                            }
                        }
                    }
                }
            }
        });
        
        const headers = ['날짜', '사이클', '주차', '요일', '세트 상세'];
        const dataRows = allMatchingRecords.map(r => [r.date, r.cycleId || 1, r.week, `${r.dayName} (${r.phase})`, r.sets.map(s => `${s.weight}kg x ${s.reps}회`).join('<br>')]);
        createTable('records-table-container', headers, dataRows);
    }
    
    function renderMovementPatternAnalysis() {
        const allRecords = appState.allRecords;
        const cycleInfo = { cycleId: appState.displayCycleId };
        
        const isBlock = (cycleInfo.cycleId % 2 === 1);
        const feedbackPeriodText = isBlock ? "최근 3주" : "최근 6주";

        const recentRecords = [];
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - ((isBlock ? 3 : 6) * 7));

        for (const key in allRecords) {
            allRecords[key].forEach(record => {
                const recordDate = new Date(record.date);
                if (recordDate >= startDate && recordDate <= endDate && record.cycleId === cycleInfo.cycleId) {
                    recentRecords.push({ ...record, sanitizedName: key });
                }
            });
        }
        
        const exerciseMap = new Map();
        Object.values(workoutPlan).forEach(week => Object.values(week).forEach(day => day.routine.forEach(ex => exerciseMap.set(getSanitizedName(ex), ex))));
       
        const patternAlias = {
          isolation_chest: 'horizontal_push',
          isolation_triceps: 'horizontal_push',
          isolation_shoulder: 'vertical_push',
          isolation_biceps: 'horizontal_pull',
          isolation_back: 'vertical_pull',
          isolation_quads: 'squat',
          isolation_hams: 'hip_hinge',
          isolation_glutes: 'hip_hinge',
          isolation_calves: 'squat'
        };

        const patternVolumes = { horizontal_push: 0, horizontal_pull: 0, vertical_push: 0, vertical_pull: 0, squat: 0, hip_hinge: 0 };

        recentRecords.forEach(record => {
            const exerciseInfo = exerciseMap.get(record.sanitizedName);
             if (exerciseInfo && exerciseInfo.movement_pattern) {
                const key = exerciseInfo.movement_pattern;
                const bucketKey = patternVolumes.hasOwnProperty(key) ? key : patternAlias[key];
                if (bucketKey && patternVolumes.hasOwnProperty(bucketKey)) {
                     patternVolumes[bucketKey] += record.sets.reduce((sum, set) => {
                        const effectiveWeight = (exerciseInfo.unit === '한쪽') ? set.weight * 2 : set.weight;
                        return sum + (effectiveWeight * set.reps); // BUG FIX: Corrected volume calculation from weight*weight to weight*reps
                     }, 0);
                }
            }
        });
        
        initializeChart('movementPatternChart', {
            type: 'bar',
            data: {
                labels: ['수평 밀기/당기기', '수직 밀기/당기기', '스쿼트/힙힌지'],
                datasets: [
                    { label: '밀기/스쿼트 (전면)', data: [patternVolumes.horizontal_push, patternVolumes.vertical_push, patternVolumes.squat], backgroundColor: 'rgba(59, 130, 246, 0.7)' },
                    { label: '당기기/힙힌지 (후면)', data: [patternVolumes.horizontal_pull, patternVolumes.vertical_pull, patternVolumes.hip_hinge], backgroundColor: 'rgba(239, 68, 68, 0.7)' }
                ]
            },
            options: { indexAxis: 'y' }
        });

        let feedback = `${cycleInfo.cycleId} 사이클(${isBlock ? '블록' : '파동형'} 주기)의 ${feedbackPeriodText}간 훈련을 분석했습니다. `;
        let issues = [];
        const checkBalance = (a, b, nameA, nameB) => { if ((a + b) > 100 && (a / (a + b) > 0.625 || a / (a + b) < 0.375)) issues.push(`${nameA}과 ${nameB}의 불균형이 감지됩니다.`) };
        checkBalance(patternVolumes.horizontal_push, patternVolumes.horizontal_pull, '수평 밀기', '수평 당기기');
        checkBalance(patternVolumes.vertical_push, patternVolumes.vertical_pull, '수직 밀기', '수직 당기기');
        checkBalance(patternVolumes.squat, patternVolumes.hip_hinge, '스쿼트', '힙힌지');
        
        if (issues.length > 0) feedback += issues.join(' ');
        else if (recentRecords.length === 0) feedback = "아직 분석할 데이터가 충분하지 않습니다.";
        else feedback += "주요 움직임 패턴 간 훈련 볼륨이 이상적인 균형을 이루고 있습니다.";
        document.getElementById('ai-feedback-text').textContent = feedback;
    }

    function renderBodycompView() {
        const records = appState.inbodyRecords;
        initializeChart('inbodyChart', {
            type: 'line',
            data: {
                labels: records.map(d => d.date),
                datasets: [
                    { label: '체중 (kg)', data: records.map(d => d.weight), borderColor: '#3b82f6', yAxisID: 'yWeight' },
                    { label: '골격근량 (kg)', data: records.map(d => d.smm), borderColor: '#16a34a', yAxisID: 'yWeight' },
                    { label: '체지방률 (%)', data: records.map(d => d.fatPercentage), borderColor: '#ef4444', yAxisID: 'yFat' }
                ]
            },
            options: {
                scales: {
                    yWeight: { type: 'linear', position: 'left', title: { display: true, text: 'kg' }, suggestedMin: 0 },
                    yFat: { type: 'linear', position: 'right', title: { display: true, text: '%' }, grid: { drawOnChartArea: false }, suggestedMin: 0 }
                }
            }
        });

        const headers = ['측정일', '체중(kg)', '골격근량(kg)', '체지방률(%)', '삭제'];
        const dataRows = records.slice().reverse().map(r => [r.date, r.weight, r.smm, r.fatPercentage, `<button class="delete-inbody-btn text-red-500 hover:text-red-700" data-date="${r.date}">삭제</button>`]);
        createTable('inbody-table-container', headers, dataRows);
    }
    
    // Data Handling & Initialization...
    function saveAllSetsForExercise(sanitizedName) {
        const setsContainer = document.querySelector(`[data-container-for="${sanitizedName}"]`);
        if (!setsContainer) return;

        const setsData = Array.from(setsContainer.querySelectorAll('.set-row')).map(row => {
            const weight = row.querySelector('input[data-type="weight"]').value;
            const reps = row.querySelector('input[data-type="reps"]').value;
            return (weight && reps) ? { weight: parseFloat(weight), reps: parseInt(reps) } : null;
        }).filter(Boolean);

        if (!appState.allRecords[sanitizedName]) appState.allRecords[sanitizedName] = [];
        
        const { currentWeek, currentDay, currentCycleId } = appState;
        let recordIndex = appState.allRecords[sanitizedName].findIndex(r => r.week === currentWeek && r.day === currentDay && r.cycleId === currentCycleId);

        if (setsData.length === 0) {
            if (recordIndex > -1) appState.allRecords[sanitizedName].splice(recordIndex, 1);
        } else {
            const { phase, originalWeekData } = getWeekInfo(currentWeek, currentCycleId);
            const newRecord = { 
                date: toLocalISODate(), week: currentWeek, day: currentDay, 
                dayName: originalWeekData[currentDay].name, phase, cycleId: currentCycleId, sets: setsData 
            };
            if (recordIndex > -1) appState.allRecords[sanitizedName][recordIndex] = newRecord;
            else appState.allRecords[sanitizedName].push(newRecord);
        }
        localStorage.setItem('workoutRecords', JSON.stringify(appState.allRecords));
        if (typeof aegisCache?.clear === 'function') aegisCache.clear();
    }

    function loadState() {
        const savedState = JSON.parse(localStorage.getItem('workoutState')) || {};
        appState.currentWeek = savedState.currentWeek || 1;
        appState.currentDay = savedState.currentDay || 'pull';
        appState.currentCycleId = (JSON.parse(localStorage.getItem('workoutCycleInfo')) || { cycleId: 1 }).cycleId;

        appState.displayCycleId = appState.currentCycleId; // <--- 이 줄을 추가하세요!

        appState.allRecords = JSON.parse(localStorage.getItem('workoutRecords')) || {};
        appState.inbodyRecords = JSON.parse(localStorage.getItem('inbodyRecords')) || [];
    }
    
    function initializeChart(canvasId, config) {
        if (appState.charts[canvasId]) appState.charts[canvasId].destroy();
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if (ctx) {
            config.options = { ...(config.options || {}), responsive: true, maintainAspectRatio: false };
            appState.charts[canvasId] = new Chart(ctx, config);
        }
    }
    
    function handleInbodyFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const record = {
            date: form.querySelector('#inbody-date').value,
            weight: parseFloat(form.querySelector('#inbody-weight').value),
            smm: parseFloat(form.querySelector('#inbody-smm').value),
            fatPercentage: parseFloat(form.querySelector('#inbody-fat').value)
        };
        if (!record.date) return;
        
        const index = appState.inbodyRecords.findIndex(r => r.date === record.date);
        if (index > -1) appState.inbodyRecords[index] = record;
        else appState.inbodyRecords.push(record);
        appState.inbodyRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        localStorage.setItem('inbodyRecords', JSON.stringify(appState.inbodyRecords));
        renderBodycompView();
        form.reset();
        form.querySelector('#inbody-date').valueAsDate = new Date();
    }
    
function startTimer(exercise, phase) {
    if (appState.timerInterval) {
        clearInterval(appState.timerInterval);
    }
    const duration = getRestTime(exercise, phase);
    let remaining = duration;

    // ▼▼▼ 이 부분이 변경됩니다 ▼▼▼
    const banner = document.getElementById('timer-banner');
    document.getElementById('banner-timer-exercise-name').textContent = exercise.name;
    const displayEl = document.getElementById('banner-timer-display');

    displayEl.textContent = formatTime(remaining);
    banner.classList.remove('hidden');
    setTimeout(() => banner.classList.add('show'), 10); // 애니메이션을 위해 약간의 딜레이 추가
    // ▲▲▲ 여기까지 변경 ▲▲▲

    appState.timerInterval = setInterval(() => {
        remaining--;
        displayEl.textContent = formatTime(remaining);
        if (remaining <= 0) {
            clearInterval(appState.timerInterval);
            appState.timerInterval = null;
            if (navigator.vibrate) navigator.vibrate([150, 100, 150]);
            playBeepSound();
            document.body.style.animation = 'flash 0.5s 2';
            setTimeout(() => {
                // ▼▼▼ 이 부분도 변경됩니다 ▼▼▼
                banner.classList.remove('show'); // 배너를 아래로 내리는 애니메이션
                setTimeout(() => banner.classList.add('hidden'), 500); // 애니메이션 후 숨김 처리
                // ▲▲▲ 여기까지 변경 ▲▲▲
                document.body.style.animation = '';
            }, 1000);
        }
    }, 1000);
}

// ▼▼▼ 사이클 네비게이션 업데이트 함수 ▼▼▼
    function updateCycleNav() {
        const { displayCycleId, currentCycleId } = appState;
        const mode = (displayCycleId % 2 === 1) ? '블록 주기화' : '주간 파동형 주기화';
            appState.dom.cycleInfoBadge.textContent = `(사이클 ${displayCycleId}: ${mode})`;
            document.getElementById('prev-cycle-btn').disabled = (displayCycleId <= 1);
            document.getElementById('next-cycle-btn').disabled = (displayCycleId >= currentCycleId);
}
// ▲▲▲ /사이클 네비게이션 업데이트 함수 ▲▲▲

function initApp() {
        appState.dom = {
            mainTabs: document.getElementById('main-tabs'),
            weekSelector: document.getElementById('week-selector'),
            daySelector: document.getElementById('day-selector'),
            workoutTitle: document.getElementById('workout-title'),
            cycleInfoBadge: document.getElementById('cycle-info-badge'),
            workoutPhaseBadge: document.getElementById('workout-phase-badge'),
            workoutPhaseDescription: document.getElementById('workout-phase-description'),
            workoutList: document.getElementById('workout-list'),
            modalContainer: document.getElementById('modal-container'),
            exerciseSelector: document.getElementById('exercise-selector'),
            inbodyForm: document.getElementById('inbody-form'),
            inbodyTableContainer: document.getElementById('inbody-table-container'),
            newCycleButton: document.getElementById('new-cycle-button'),
            exportDataButton: document.getElementById('export-data-button'),
            importDataButton: document.getElementById('import-data-button'),
            resetAllButton: document.getElementById('reset-all-button'),
        };

        document.body.addEventListener('click', () => {
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });

        loadState();
        
        appState.dom.weekSelector.innerHTML = Array.from({length: 13}, (_, i) => `<button data-week="${i + 1}" class="p-2 px-4 rounded-lg font-semibold text-sm sm:text-base transition duration-200 hover:bg-slate-200 flex-grow text-center shadow-md">${i + 1}주</button>`).join('');
        
        appState.dom.mainTabs.addEventListener('click', e => e.target.dataset.view && showView(e.target.dataset.view));
        
        document.getElementById('prev-cycle-btn').addEventListener('click', () => {
            if (appState.displayCycleId > 1) {
                appState.displayCycleId--;
                renderWorkout();
                updateCycleNav();
            }
        });

        document.getElementById('next-cycle-btn').addEventListener('click', () => {
            if (appState.displayCycleId < appState.currentCycleId) {
                appState.displayCycleId++;
                renderWorkout();
                updateCycleNav();
            }
        });

        appState.dom.weekSelector.addEventListener('click', e => {
            if(e.target.dataset.week) {
                appState.currentWeek = parseInt(e.target.dataset.week);
                localStorage.setItem('workoutState', JSON.stringify({ currentWeek: appState.currentWeek, currentDay: appState.currentDay }));
                renderWorkout();
                updateActiveButtons();
            }
        });
        appState.dom.daySelector.addEventListener('click', e => {
            if(e.target.dataset.day) {
                appState.currentDay = e.target.dataset.day;
                localStorage.setItem('workoutState', JSON.stringify({ currentWeek: appState.currentWeek, currentDay: appState.currentDay }));
                renderWorkout();
                updateActiveButtons();
            }
        });

        const debouncedSave = debounce((sanitizedName) => {
            saveAllSetsForExercise(sanitizedName);
        }, 350);

        appState.dom.workoutList.addEventListener('input', e => {
             if (e.target.matches('input[data-type]')) {
                const sanitizedName = e.target.closest('.card-enter').querySelector('[data-container-for]').dataset.containerFor;
                debouncedSave(sanitizedName);
            }
        });

        appState.dom.workoutList.addEventListener('click', e => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const card = button.closest('.card-enter');
            const sanitizedName = card.querySelector('[data-container-for]')?.dataset.containerFor;
            
            if (button.dataset.action === 'add-set') {
                const container = card.querySelector(`[data-container-for="${sanitizedName}"]`);
                const lastSetRow = container.querySelector('.set-row:last-child');
                let startTimerFlag = false;
                if (lastSetRow) {
                    const weightInput = lastSetRow.querySelector('input[data-type="weight"]');
                    const repsInput = lastSetRow.querySelector('input[data-type="reps"]');
                    if (weightInput.value && repsInput.value) {
                       startTimerFlag = true;
                    }
                }

                addSetRow(container, container.querySelectorAll('.set-row').length + 1);
                
                if(startTimerFlag) {
                    const exercise = appState.currentRoutine.find(ex => getSanitizedName(ex) === sanitizedName);
                    if (exercise) {
                        const { phase } = getWeekInfo(appState.currentWeek, appState.displayCycleId);
                        startTimer(exercise, phase);
                    }
                }

            } else if (button.dataset.action === 'delete-set') {
                const container = card.querySelector(`[data-container-for="${sanitizedName}"]`);
                button.closest('.set-row').remove();
                container.querySelectorAll('.set-row').forEach((r, i) => r.querySelector('span:first-child').textContent = `세트 ${i + 1}`);
                saveAllSetsForExercise(sanitizedName);
            } else if (button.dataset.action === 'view-history') {
                const exerciseName = button.dataset.exerciseName;
                showHistoryModal(exerciseName);
            }
        });
        appState.dom.exerciseSelector.addEventListener('change', handleExerciseSelection);
        appState.dom.inbodyForm.addEventListener('submit', handleInbodyFormSubmit);
        appState.dom.inbodyTableContainer.addEventListener('click', e => {
            if (e.target.classList.contains('delete-inbody-btn')) {
                const date = e.target.dataset.date;
                showConfirmModal(
                    '인바디 기록 삭제', 
                    `'${date}'의 인바디 기록을 정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`,
                    'bg-red-600 hover:bg-red-700',
                    () => {
                        appState.inbodyRecords = appState.inbodyRecords.filter(r => r.date !== date);
                        localStorage.setItem('inbodyRecords', JSON.stringify(appState.inbodyRecords));
                        renderBodycompView();
                        toggleModal('confirm-modal', false);
                    }
                );
            }
        });

        appState.dom.resetAllButton.addEventListener('click', () => {
             showConfirmModal(
                '모든 기록 삭제 및 초기화', 
                '이 작업은 되돌릴 수 없습니다. 모든 운동 및 신체 기록이 영구적으로 삭제됩니다.',
                'bg-red-600 hover:bg-red-700',
                () => {
                    localStorage.clear(); 
                    window.location.reload();
                }
            );
        });
        
        // [버그 수정] '새로운 사이클 시작' 버튼의 로직을 올바르게 수정했습니다.
        appState.dom.newCycleButton.addEventListener('click', () => {
             showConfirmModal(
                '새로운 사이클 시작', 
                '1주차부터 새로운 13주 훈련 계획이 시작됩니다. 기존 기록은 보존됩니다.',
                'bg-blue-600 hover:bg-blue-700',
                () => {
                    appState.currentCycleId++;
                    appState.displayCycleId = appState.currentCycleId; // displayCycleId도 현재 사이클로 동기화
                    appState.currentWeek = 1; 
                    appState.currentDay = 'pull';
                    localStorage.setItem('workoutCycleInfo', JSON.stringify({ cycleId: appState.currentCycleId }));
                    localStorage.setItem('workoutState', JSON.stringify({ currentWeek: appState.currentWeek, currentDay: appState.currentDay }));
                    loadState(); 
                    renderWorkout(); 
                    updateActiveButtons(); 
                    showView('today');
                    toggleModal('confirm-modal', false);
                }
            );
        });

        appState.dom.exportDataButton.addEventListener('click', handleExport);
        document.getElementById('weekly-export-csv')?.addEventListener('click', exportCurrentWeekToCSV);
        document.getElementById('weekly-share-summary')?.addEventListener('click', shareWeeklySummary);
        document.getElementById('weekly-instagram-png')?.addEventListener('click', downloadInstagramCardPNG);
        appState.dom.importDataButton.addEventListener('click', () => toggleModal('import-modal', true));

        appState.dom.modalContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            if (button.dataset.action === 'close-modal') {
                const modal = button.closest('[id$="-modal"]');
                if(modal) toggleModal(modal.id, false);
            }
            
            switch(button.id) {
                case 'save-export-data-button': saveDataAsFile(); break;
                case 'copy-export-data-button': {
                  const txt = document.getElementById('export-data-textarea').value;
                  (async () => {
                    try {
                      await navigator.clipboard.writeText(txt);
                      button.textContent = '복사 완료!';
                    } catch {
                      document.getElementById('export-data-textarea').select();
                      document.execCommand('copy');
                      button.textContent = '복사 완료!';
                    } finally {
                      setTimeout(() => { button.textContent = '전체 복사'; }, 2000);
                    }
                  })();
                  break;
                }
                case 'confirm-import-button': handleImport(); break;
                 case 'banner-skip-timer-btn':
                    if (appState.timerInterval) {
                        clearInterval(appState.timerInterval);
                        appState.timerInterval = null;
                        const banner = document.getElementById('timer-banner');
                        banner.classList.remove('show');
                        setTimeout(() => banner.classList.add('hidden'), 500);
                    }
                    break;
            }
        });
        
        document.getElementById('import-file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { document.getElementById('import-data-textarea').value = e.target.result; };
            reader.readAsText(file);
        });

        updateActiveButtons();
        renderWorkout();
        showView('today');
        updateCycleNav();
        
        document.body.addEventListener('click', acquireWakeLock, { once: true });
        document.body.addEventListener('touchstart', acquireWakeLock, { once: true });

        document.addEventListener('visibilitychange', () => {
            if (wakeLock !== null && document.visibilityState === 'hidden') {
                releaseWakeLock();
            } else if (document.visibilityState === 'visible') {
                acquireWakeLock();
            }
        });
    }
 

    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.toggle('hidden', !show);
        document.body.style.overflow = show ? 'hidden' : '';
    }
    
    // --- BUG FIX v20.8: Reverted to the original stable modal confirmation logic ---
    function showConfirmModal(title, message, btnClass, onConfirm) {
        document.getElementById('confirm-modal-title').textContent = title;
        document.getElementById('confirm-modal-message').textContent = message;
        const actionBtn = document.getElementById('confirm-modal-action-btn');
        actionBtn.className = `px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg text-white font-bold transition shadow-md ${btnClass}`;
        
        // Create a clean clone of the button to remove any lingering event listeners
        const newActionBtn = actionBtn.cloneNode(true);
        actionBtn.parentNode.replaceChild(newActionBtn, actionBtn);
        
        // Add the single, correct event listener for this specific confirmation
        newActionBtn.addEventListener('click', onConfirm);

        toggleModal('confirm-modal', true);
    }
    
    function showHistoryModal(exerciseName) {
        document.getElementById('history-modal-title').textContent = `${exerciseName} 과거 기록`;
        
        const base = (exerciseName).replace(/\s/g, '').replace(/[^a-zA-Z0-9가-힣]/g, '');
        const allMatchingRecords = Object.entries(appState.allRecords)
            .filter(([k]) => k.startsWith(base))
            .flatMap(([, arr]) => arr)
            .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by most recent

        const headers = ['날짜', '사이클-주차', '단계', '세트 상세'];
        const dataRows = allMatchingRecords.map(r => [
            r.date,
            `C${r.cycleId || 1}-${r.week}주`,
            r.phase,
            r.sets.map(s => `${s.weight}kg x ${s.reps}회`).join('<br>')
        ]);
        
        createTable('history-modal-content', headers, dataRows);
        toggleModal('history-modal', true);
    }

    function handleExport() {
        const dataToExport = {
            workoutRecords: appState.allRecords,
            workoutState: { currentWeek: appState.currentWeek, currentDay: appState.currentDay },
            workoutCycleInfo: { cycleId: appState.currentCycleId },
            inbodyRecords: appState.inbodyRecords,
        };
        document.getElementById('export-data-textarea').value = JSON.stringify(dataToExport, null, 2);
        toggleModal('export-modal', true);
    }

    function saveDataAsFile() {
        const dataStr = document.getElementById('export-data-textarea').value;
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `26w-growth-program-backup-${toLocalISODate()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function handleImport() {
        const jsonString = document.getElementById('import-data-textarea').value;
        const feedbackEl = document.getElementById('import-feedback');
        try {
            const data = JSON.parse(jsonString);
            if (!data.workoutRecords || !data.workoutState || !data.workoutCycleInfo || !data.inbodyRecords) throw new Error('필수 데이터가 누락되었습니다.');
            
            showConfirmModal(
                '기록 불러오기',
                '정말로 데이터를 불러오시겠습니까? 현재 모든 기록을 덮어씁니다.',
                'bg-purple-600 hover:bg-purple-700',
                () => {
                    localStorage.setItem('workoutRecords', JSON.stringify(data.workoutRecords));
                    localStorage.setItem('workoutState', JSON.stringify(data.workoutState));
                    localStorage.setItem('workoutCycleInfo', JSON.stringify(data.workoutCycleInfo));
                    localStorage.setItem('inbodyRecords', JSON.stringify(data.inbodyRecords));
                    toggleModal('confirm-modal', false);
                    toggleModal('import-modal', false);
                    window.location.reload();
                }
            )

        } catch (error) {
            feedbackEl.textContent = `오류: ${error.message}`;
            feedbackEl.classList.add('text-red-600');
        }
    }

/* ===================== 주간 집계 공통 헬퍼 ===================== */
/* 운동별 통계: Max Kg(그 주에 든 최고 중량), 총 Reps, 총 Sets */
function getWeeklyExerciseStats(cycle = appState?.currentCycleId ?? 1,
                                week  = appState?.currentWeek ?? 1) {
  const stat = new Map(); // name -> { kgSum, kgMax, reps, sets }
  let totalSets = 0, totalKg = 0, totalReps = 0;

  for (const [sanitized, recs] of Object.entries(appState?.allRecords || {})) {
    (recs || []).forEach(r => {
      if (+r.cycleId !== +cycle || +r.week !== +week) return;
      const name = (r.exerciseName || r.name || sanitized || "").trim();

      let kgSum = 0, kgMax = 0, reps = 0, sets = 0;
      (r.sets || []).forEach(s => {
        const w = (+s.weight || 0), rr = (+s.reps || 0);
        kgSum += w;
        kgMax  = Math.max(kgMax, w);   // 👈 최고 중량
        reps  += rr;
        sets  += 1;
      });

      totalSets += sets;
      totalKg   += kgSum;   // 총합은 참고용(요약 상단)
      totalReps += reps;

      const prev = stat.get(name) || { kgSum:0, kgMax:0, reps:0, sets:0 };
      prev.kgSum += kgSum;
      prev.kgMax  = Math.max(prev.kgMax, kgMax);
      prev.reps  += reps;
      prev.sets  += sets;
      stat.set(name, prev);
    });
  }

  // 정렬: Max Kg  → 총 Reps → 세트수
  const list = [...stat.entries()]
    .map(([name, s]) => ({ name, ...s }))
    .sort((a,b) => (b.kgMax - a.kgMax) || (b.sets - a.sets) || (b.reps - a.reps));

  return { cycle, week, totalSets, totalKg, totalReps, list };
}

/* ===================== 주간 요약 공유(텍스트) ===================== */
/* Top5는 '운동 단위'로 표기: Max Kg / Reps / Sets */
function shareWeeklySummary() {
  const cycle = appState?.currentCycleId ?? 1;
  const week  = appState?.currentWeek ?? 1;

  // 총 세트수
  let totalSets = 0;
  for (const recs of Object.values(appState?.allRecords || {})) {
    (recs || []).forEach(r => {
      if (+r.cycleId === +cycle && +r.week === +week) totalSets += (r.sets || []).length;
    });
  }

  // PPL Top3
  const { Push, Pull, Legs } = getWeeklyPPLTop3(cycle, week);
  const fmt = (it,i) => `${i+1}. ${it.name} — ${it.kgMax} kg (max) / ${it.reps} reps / ${it.sets} sets`;

  // (선택) PR 하이라이트
  const now = [], past = [];
  for (const [k, recs] of Object.entries(appState?.allRecords || {})) {
    (recs || []).forEach(r => {
      const sets = (r.sets || []).map(s => ({ w:+s.weight||0, r:+s.reps||0 }));
      const obj = { name: (r.exerciseName || r.name || r.dayName || k).trim(), cycleId:+r.cycleId||0, week:+r.week||0, sets };
      ((obj.cycleId === cycle && obj.week === week) ? now : past).push(obj);
    });
  }
  const e1 = (w,r)=> (r>1 ? w*(1+r/30) : w);
  const bestE1RM = (arr)=> arr.reduce((mx,rec)=>Math.max(mx, ...rec.sets.map(s=>e1(s.w,s.r))), 0);
  const pastByName = past.reduce((m,rec)=>( (m[rec.name]??=[]).push(rec), m), {});
  const bestThisWeek = new Map();
  for (const rec of now) for (const s of rec.sets) {
    const curr = bestThisWeek.get(rec.name);
    const val  = e1(s.w,s.r);
    if (!curr || val > curr.e1) bestThisWeek.set(rec.name, { w:s.w, r:s.r, e1:val });
  }
  const prs = [];
  for (const [name,cur] of bestThisWeek.entries()) {
    const prev = bestE1RM(pastByName[name] || []);
    if (cur.e1 > prev + 0.5) prs.push({ name, ...cur, prev });
  }
  const prLines = prs.sort((a,b)=>b.e1-a.e1).slice(0,5)
    .map(p => `• ${p.name}: ${p.w}kg×${p.r} (추정1RM ${Math.round(p.e1)}kg, 이전 ${Math.round(p.prev)}kg)`);

  // 텍스트 구성
  const header = `[26주 프로그램] C${cycle} · ${week}주차 요약\n총 세트수: ${totalSets}`;
  const secPush = Push.length ? `\n💪 Push — Top 3 (Max Kg)\n${Push.map(fmt).join("\n")}` : "";
  const secPull = Pull.length ? `\n🧲 Pull — Top 3 (Max Kg)\n${Pull.map(fmt).join("\n")}` : "";
  const secLegs = Legs.length ? `\n🦵 Legs — Top 3 (Max Kg)\n${Legs.map(fmt).join("\n")}` : "";
  const secPR   = prLines.length ? `\n🚀 PR 갱신\n${prLines.join("\n")}` : "";

  const text = `${header}${secPush}${secPull}${secLegs}${secPR}\n#주간요약 #PPL #운동기록`.trim();

  if (navigator.share) navigator.share({ title:"주간 요약", text }).catch(()=>copy(text));
  else copy(text);

  function copy(t){ navigator.clipboard?.writeText(t).then(()=>alert("주간 요약을 클립보드에 복사했습니다!")); }
}

/* ===================== CSV 내보내기 (메인 운동만) ===================== */
/* 컬럼: Category, Exercise, MaxKg, TotalReps, Sets */
function exportCurrentWeekToCSV() {
  const cycle = appState?.currentCycleId ?? 1;
  const week  = appState?.currentWeek ?? 1;
  const rows = [["Category","Exercise","MaxKg","TotalReps","Sets"]];
  const MAIN = getMainExerciseKeySet();
  const byKey = new Map(); // key: `${cat}||${name}`
  const catMap = { push:"Push", pull:"Pull", leg:"Legs" };

  // (키가 필요한 이유: 메인 필터링을 정확히 하려고 entries 사용)
  for (const [k, recs] of Object.entries(appState?.allRecords || {})) {
    if (!MAIN.has(k)) continue; // 메인 운동만 CSV 포함

    (recs || []).forEach(r => {
      if (+r.cycleId !== +cycle || +r.week !== +week) return;

      const cat  = catMap[r.day] || "Etc";
      const name = (r.exerciseName || r.name || r.dayName || k || "미지정 운동").trim();

      let kgMax = 0, reps = 0, sets = 0;
      (r.sets || []).forEach(s => {
        const w = +s.weight || 0, rr = +s.reps || 0;
        kgMax = Math.max(kgMax, w);
        reps += rr; sets += 1;
      });

      const key = `${cat}||${name}`;
      const prev = byKey.get(key) || { cat, name, kgMax:0, reps:0, sets:0 };
      prev.kgMax = Math.max(prev.kgMax, kgMax);
      prev.reps += reps;
      prev.sets += sets;
      byKey.set(key, prev);
    });
  }

  const list = Array.from(byKey.values()).sort((a,b)=>(b.kgMax-a.kgMax)||(b.sets-a.sets)||(b.reps-a.reps));
  list.forEach(it => rows.push([it.cat, it.name, it.kgMax, it.reps, it.sets]));

  const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `C${cycle}_W${week}_weekly.csv`;
  document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); },0);
}

async function downloadInstagramCardPNG() {
  const cycle = appState?.currentCycleId ?? 1;
  const week  = appState?.currentWeek ?? 1;
  const ppl   = getWeeklyPPLTop3(cycle, week);

  // 총 세트수
  let totalSets = 0;
  for (const recs of Object.values(appState?.allRecords || {})) {
    (recs || []).forEach(r => {
      if (+r.cycleId === +cycle && +r.week === +week) totalSets += (r?.sets?.length || 0);
    });
  }

  // ---- 고해상도 캔버스 (Retina/고DPR 선명 표시) ----
  const W = 1080, H = 1350, PAD = 64;
  const DPR = Math.max(2, Math.floor(window.devicePixelRatio || 1)); // 최소 2배
  const c = document.createElement('canvas');
  c.width  = W * DPR;
  c.height = H * DPR;
  const ctx = c.getContext('2d');
  ctx.scale(DPR, DPR);
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.textBaseline = 'alphabetic';

  // ---- 폰트 로딩 보장 (깨짐 방지) ----
  const FONT_STACK = `"Pretendard", "Noto Sans KR", "Apple SD Gothic Neo", system-ui, -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif`;
  await ensureFonts([
    `bold 64px ${FONT_STACK}`,
    `bold 56px ${FONT_STACK}`,
    `700 36px ${FONT_STACK}`,
    `600 40px ${FONT_STACK}`,
    `32px ${FONT_STACK}`,
    `28px ${FONT_STACK}`
  ]);

  // ---- 배경 & 카드 ----
  function rr(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
  ctx.fillStyle = '#ffffff';             // 페이지 배경 (라이트)
  ctx.fillRect(0,0,W,H);
  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,.06)';
  ctx.shadowBlur = 24;
  ctx.shadowOffsetY = 8;
  ctx.fillStyle = '#f8fafc';             // 카드 바탕 (slate-50)
  rr(PAD, PAD, W-PAD*2, H-PAD*2, 28);
  ctx.fill();
  ctx.restore();

  // ---- 헤더 ----
  ctx.fillStyle = '#0f172a'; // slate-900
  ctx.font = `bold 64px ${FONT_STACK}`;
  ctx.fillText('26주 장기 성장 프로그램', PAD+48, PAD+110);

  ctx.fillStyle = '#2563eb'; // blue-600
  ctx.font = `bold 56px ${FONT_STACK}`;
  ctx.fillText(`C${cycle} · ${week}주차`, PAD+48, PAD+180);

  // ---- 총 Sets 박스 ----
  const boxX = PAD+48, boxY = PAD+210, boxW = W - (PAD+48)*2, boxH = 96;
  ctx.fillStyle = '#e2e8f0'; // slate-200
  rr(boxX, boxY, boxW, boxH, 16); ctx.fill();
  ctx.fillStyle = '#0f172a';
  ctx.font = `700 36px ${FONT_STACK}`;
  ctx.fillText('총 Sets', boxX+24, boxY+62);
  ctx.font = `bold 64px ${FONT_STACK}`;
  const setsText = String(totalSets);
  ctx.fillText(setsText, boxX + boxW - 24 - ctx.measureText(setsText).width, boxY+68);

  // ---- 섹션 제목/본문 ----
  const icon = { Push:'💪', Pull:'🧲', Legs:'🦵' };
  const label= { Push:'Push', Pull:'Pull', Legs:'Legs' };
  let y = boxY + boxH + 36;
  const left = PAD + 48;
  const rightLimit = W - (PAD + 48);
  const textWidth = rightLimit - left;

  (['Push','Pull','Legs']).forEach(group=>{
    // 섹션 제목
    ctx.fillStyle = group==='Push' ? '#ef4444' : group==='Pull' ? '#0ea5e9' : '#10b981';
    ctx.font = `bold 44px ${FONT_STACK}`;
    y = drawTextWrap(ctx, `${icon[group]} ${label[group]} — Top 3 (Max Kg)`, left, y, textWidth, 50);

    // 항목
    const arr = ppl[group] || [];
    if (arr.length === 0) {
      ctx.fillStyle = '#475569';
      ctx.font = `28px ${FONT_STACK}`;
      y = drawTextWrap(ctx, '(기록 없음)', left+24, y, textWidth-24, 44);
    } else {
      arr.forEach((it, i) => {
        ctx.fillStyle = '#0f172a';
        ctx.font = `32px ${FONT_STACK}`;
        y = drawTextWrap(ctx, `${i+1}. ${it.name}`, left+24, y, textWidth-24, 42);

        ctx.fillStyle = '#334155';
        ctx.font = `28px ${FONT_STACK}`;
        const detail = `${it.kgMax} kg (max) / ${it.reps} reps / ${it.sets} sets`;
        y = drawTextWrap(ctx, detail, left+44, y, textWidth-44, 40);
      });
    }
    y += 8; // 섹션 간격
  });

  // ---- 해시태그 ----
  ctx.font = `28px ${FONT_STACK}`;
  ctx.fillStyle = '#475569';
  ctx.fillText('#주간요약 #PPL #운동기록', PAD+48, H-PAD-36);

  // ---- 저장 ----
  const a = document.createElement('a');
  a.download = `instagram_weekly_c${cycle}_w${week}.png`;
  a.href = c.toDataURL('image/png');
  a.click();
}

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>








